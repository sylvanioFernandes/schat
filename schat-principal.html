<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S-Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #0a0a0a;
    --bg-panel: #111111;
    --bg-card: #181818;
    --bg-input: #1e1e1e;
    --bg-msg-out: #2a1a0e;
    --bg-msg-in: #1a1a1a;
    --orange-soft: #e8874a;
    --orange-dim: #a0522825;
    --text-primary: #f0ece6;
    --text-secondary: #8a8178;
    --text-muted: #4a4540;
    --border: #242220;
    --radius: 14px;
    --green-online: #4caf7d;
    --sidebar-w: 340px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Sora', sans-serif;
    background: var(--bg-deep);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* ===================== SIDEBAR ===================== */
  .sidebar {
    width: var(--sidebar-w); flex-shrink: 0;
    background: var(--bg-panel);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column; height: 100vh;
  }

  .sidebar-header {
    padding: 16px 16px 14px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }

  .sidebar-brand { display: flex; align-items: center; gap: 10px; }

  .sidebar-logo {
    width: 34px; height: 34px; border-radius: 10px;
    background: linear-gradient(135deg, #e8874a, #c05820);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 12px #e8874a20;
  }
  .sidebar-logo svg { width: 18px; height: 18px; fill: white; }

  .sidebar-brand-name {
    font-family: 'Space Mono', monospace;
    font-size: 16px; font-weight: 700; letter-spacing: -0.3px;
  }
  .sidebar-brand-name span { color: var(--orange-soft); }

  .header-actions { display: flex; gap: 6px; }

  .icon-btn {
    width: 38px; height: 38px; border-radius: 10px;
    background: var(--bg-card); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s, border-color 0.2s, transform 0.15s;
    color: var(--text-secondary);
  }
  .icon-btn:hover { background: var(--bg-input); border-color: rgba(232,135,74,0.4); color: var(--text-primary); transform: translateY(-1px); }
  .icon-btn:active { transform: scale(0.94); }
  .icon-btn svg { width: 18px; height: 18px; stroke: currentColor; fill: none; }

  .search-wrap { padding: 10px 14px; border-bottom: 1px solid var(--border); }
  .search-inner { position: relative; }
  .search-inner svg {
    position: absolute; left: 11px; top: 50%; transform: translateY(-50%);
    width: 13px; height: 13px; stroke: var(--text-muted); fill: none; pointer-events: none;
  }
  .search-inner input {
    width: 100%; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 9px 12px 9px 32px;
    font-family: 'Sora', sans-serif; font-size: 13px; color: var(--text-primary);
    outline: none; transition: border-color 0.2s;
  }
  .search-inner input::placeholder { color: var(--text-muted); }
  .search-inner input:focus { border-color: var(--orange-soft); }

  .contacts-section { flex: 1; overflow-y: auto; padding: 4px 0; }
  .contacts-section::-webkit-scrollbar { width: 3px; }
  .contacts-section::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .section-label {
    font-size: 10px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 1px; padding: 12px 16px 5px;
  }

  .contact-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 14px; cursor: pointer;
    transition: background 0.15s; position: relative;
    border-bottom: 1px solid rgba(232, 135, 74, 0.12);
  }
  .contact-item:last-child { border-bottom: none; }
  .contact-item:hover { background: var(--bg-card); }
  .contact-item.active { background: var(--orange-dim); }
  .contact-item.active::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0;
    width: 3px; background: var(--orange-soft); border-radius: 0 2px 2px 0;
  }

  .avatar { position: relative; flex-shrink: 0; }
  .avatar-img {
    width: 50px; height: 50px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px; font-weight: 600; border: 1px solid var(--border);
  }
  .avatar-img.c1 { background: #1a0e08; color: #e8874a; }
  .avatar-img.c2 { background: #081a10; color: #4a9e6a; }
  .avatar-img.c3 { background: #08101a; color: #4a80c0; }
  .avatar-img.c4 { background: #1a0814; color: #c04a8a; }
  .avatar-img.c5 { background: #141a08; color: #8ac04a; }

  .status-dot {
    position: absolute; bottom: 2px; right: 2px;
    width: 12px; height: 12px; border-radius: 50%;
    border: 2px solid var(--bg-panel);
  }
  .status-dot.online  { background: var(--green-online); }
  .status-dot.away    { background: #c09030; }
  .status-dot.offline { background: var(--text-muted); }

  .contact-info { flex: 1; min-width: 0; }
  .contact-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 3px; }
  .contact-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .contact-time { font-size: 11px; color: var(--text-muted); flex-shrink: 0; margin-left: 8px; }
  .contact-bottom { display: flex; align-items: center; justify-content: space-between; }
  .contact-preview { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
  .unread-badge {
    background: var(--orange-soft); color: white; font-size: 10px; font-weight: 700;
    min-width: 18px; height: 18px; border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    padding: 0 5px; flex-shrink: 0; margin-left: 6px;
  }

  .my-profile {
    padding: 11px 14px; border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
    cursor: pointer; transition: background 0.2s;
  }
  .my-profile:hover { background: var(--bg-card); }
  .my-profile .avatar-img { width: 38px; height: 38px; font-size: 13px; }
  .my-profile-info { flex: 1; min-width: 0; }
  .my-profile-name { font-size: 13px; font-weight: 500; }
  .my-profile-sub  { font-size: 11px; color: var(--green-online); }

  /* ===================== CHAT ===================== */
  .chat-area {
    flex: 1; display: flex; flex-direction: column;
    background: var(--bg-deep); position: relative;
  }
  .chat-area::before {
    content: ''; position: absolute; inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 32px 32px; opacity: 0.18; pointer-events: none;
  }

  .chat-header {
    padding: 12px 18px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
    background: var(--bg-panel); position: relative; z-index: 2;
  }
  .chat-header .avatar-img { width: 40px; height: 40px; font-size: 14px; }
  .chat-header .status-dot { bottom: 0; right: 0; width: 11px; height: 11px; border-color: var(--bg-panel); }
  .chat-header-info { flex: 1; }
  .chat-header-name   { font-size: 15px; font-weight: 600; margin-bottom: 1px; }
  .chat-header-status { font-size: 12px; color: var(--green-online); }
  .chat-header-actions { display: flex; gap: 6px; }

  .messages-wrap {
    flex: 1; overflow-y: auto;
    padding: 16px 18px; display: flex; flex-direction: column; gap: 4px;
    position: relative; z-index: 1;
  }
  .messages-wrap::-webkit-scrollbar { width: 3px; }
  .messages-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .date-sep { text-align: center; margin: 10px 0 6px; }
  .date-sep span {
    font-size: 11px; color: var(--text-muted);
    background: var(--bg-panel); border: 1px solid var(--border);
    padding: 3px 12px; border-radius: 20px;
  }

  .msg {
    display: flex; align-items: flex-end; gap: 7px;
    max-width: 65%; animation: msg-in 0.2s ease both;
  }
  @keyframes msg-in {
    from { opacity: 0; transform: translateY(5px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .msg.out { align-self: flex-end; flex-direction: row-reverse; }
  .msg.in  { align-self: flex-start; }

  .msg-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 600; flex-shrink: 0;
    border: 1px solid var(--border);
  }

  .msg-bubble {
    padding: 9px 13px; font-size: 14px; line-height: 1.5;
    position: relative; max-width: 100%; cursor: pointer;
  }
  .msg.in .msg-bubble {
    background: var(--bg-msg-in); border: 1px solid var(--border);
    border-radius: 16px 16px 16px 4px;
  }
  .msg.out .msg-bubble {
    background: var(--bg-msg-out); border: 1px solid #3a2010;
    border-radius: 16px 16px 4px 16px;
  }

  .msg-bubble:hover .reaction-trigger { opacity: 1; }
  .reaction-trigger {
    position: absolute; top: -10px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 20px; padding: 2px 6px; font-size: 12px;
    cursor: pointer; opacity: 0; transition: opacity 0.15s;
    white-space: nowrap; z-index: 10;
  }
  .msg.in  .reaction-trigger { right: -4px; }
  .msg.out .reaction-trigger { left: -4px; }

  .msg-reaction {
    display: inline-block; font-size: 14px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 1px 6px; margin-top: 4px;
    cursor: pointer; transition: transform 0.15s;
  }
  .msg-reaction:hover { transform: scale(1.2); }

  .msg-footer { display: flex; align-items: center; gap: 4px; margin-top: 3px; }
  .msg.out .msg-footer { justify-content: flex-end; }
  .msg-time  { font-size: 10px; color: var(--text-muted); }
  .msg-check { font-size: 11px; color: var(--orange-soft); }

  /* ===================== ÁUDIO ===================== */

  /* Bolha de áudio */
  .audio-bubble {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; border-radius: 16px;
    min-width: 200px; max-width: 280px; cursor: pointer;
    position: relative;
  }
  .msg.in .audio-bubble {
    background: var(--bg-msg-in); border: 1px solid var(--border);
    border-radius: 16px 16px 16px 4px;
  }
  .msg.out .audio-bubble {
    background: var(--bg-msg-out); border: 1px solid #3a2010;
    border-radius: 16px 16px 4px 16px;
  }

  .audio-play-btn {
    width: 34px; height: 34px; border-radius: 50%;
    background: var(--orange-soft);
    border: none; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s, box-shadow 0.15s;
    box-shadow: 0 3px 10px #e8874a30;
  }
  .audio-play-btn:hover { transform: scale(1.08); }
  .audio-play-btn svg { width: 14px; height: 14px; fill: white; margin-left: 2px; }
  .audio-play-btn.playing svg { margin-left: 0; }

  .audio-info { flex: 1; min-width: 0; }

  .audio-waveform {
    display: flex; align-items: center; gap: 2px;
    height: 24px; margin-bottom: 4px;
  }

  .wave-bar {
    width: 3px; border-radius: 2px;
    background: var(--text-muted); flex-shrink: 0;
    transition: background 0.2s;
  }

  .audio-duration { font-size: 11px; color: var(--text-muted); }

  /* Overlay de gravação */
  .recording-overlay {
    display: none;
    position: absolute; left: 0; right: 0; bottom: 0;
    background: var(--bg-panel);
    border-top: 1px solid var(--border);
    padding: 14px 18px;
    align-items: center; gap: 14px;
    z-index: 20; animation: slide-up 0.2s ease;
  }
  @keyframes slide-up {
    from { transform: translateY(100%); opacity: 0; }
    to   { transform: translateY(0); opacity: 1; }
  }
  .recording-overlay.visible { display: flex; }

  .rec-cancel {
    width: 38px; height: 38px; border-radius: 50%;
    background: #2a1010; border: 1px solid #5a2020;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: #c05050; font-size: 18px;
    transition: background 0.2s; flex-shrink: 0;
  }
  .rec-cancel:hover { background: #3a1515; }

  .rec-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }

  .rec-top { display: flex; align-items: center; gap: 8px; }

  .rec-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: #e05050;
    animation: blink 1s infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

  .rec-label { font-size: 13px; color: var(--text-primary); font-weight: 500; }

  .rec-timer {
    font-family: 'Space Mono', monospace;
    font-size: 18px; font-weight: 700;
    color: var(--orange-soft); letter-spacing: 1px;
  }

  .rec-wave {
    display: flex; align-items: center; gap: 3px; height: 20px;
  }
  .rec-wave-bar {
    width: 3px; border-radius: 2px; background: var(--orange-soft);
    animation: wave-anim 0.8s infinite;
  }
  .rec-wave-bar:nth-child(1) { animation-delay: 0s; }
  .rec-wave-bar:nth-child(2) { animation-delay: 0.1s; }
  .rec-wave-bar:nth-child(3) { animation-delay: 0.2s; }
  .rec-wave-bar:nth-child(4) { animation-delay: 0.3s; }
  .rec-wave-bar:nth-child(5) { animation-delay: 0.15s; }
  .rec-wave-bar:nth-child(6) { animation-delay: 0.05s; }
  .rec-wave-bar:nth-child(7) { animation-delay: 0.25s; }
  .rec-wave-bar:nth-child(8) { animation-delay: 0.1s; }

  @keyframes wave-anim {
    0%,100% { height: 4px; opacity: 0.4; }
    50%      { height: 18px; opacity: 1; }
  }

  .rec-send {
    width: 48px; height: 48px; border-radius: 50%;
    background: linear-gradient(135deg, #e8874a, #c05820);
    border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 16px #e8874a30; flex-shrink: 0;
    transition: transform 0.15s;
  }
  .rec-send:hover { transform: scale(1.06); }
  .rec-send svg { width: 20px; height: 20px; fill: white; }

  /* Dica de segurar */
  .mic-hint {
    position: absolute; bottom: 70px; right: 18px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 7px 12px;
    font-size: 12px; color: var(--text-secondary);
    display: none; animation: picker-in 0.15s ease;
    white-space: nowrap; z-index: 15;
    pointer-events: none;
  }
  @keyframes picker-in {
    from { opacity: 0; transform: translateY(4px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .mic-hint.visible { display: block; }

  /* Indicador digitando */
  .typing-indicator {
    display: none; align-self: flex-start;
    align-items: flex-end; gap: 7px;
    animation: msg-in 0.2s ease both;
  }
  .typing-indicator.visible { display: flex; }
  .typing-bubble {
    background: var(--bg-msg-in); border: 1px solid var(--border);
    border-radius: 16px 16px 16px 4px;
    padding: 10px 14px; display: flex; gap: 6px; align-items: center;
    min-width: 80px; max-width: 260px;
  }
  .typing-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--text-muted); animation: bounce 1.2s infinite; flex-shrink: 0;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%,60%,100% { transform: translateY(0); background: var(--text-muted); }
    30%          { transform: translateY(-5px); background: var(--orange-soft); }
  }
  /* Humor text dentro do typing bubble */
  /* Preview de formatação rica */
  .fmt-hint {
    position: absolute; top: -32px; left: 18px;
    background: var(--bg-card); border: 1px solid var(--orange-soft);
    border-radius: 8px; padding: 4px 10px; font-size: 11px;
    color: var(--orange-soft); pointer-events: none;
    opacity: 0; transform: translateY(4px);
    transition: opacity 0.2s, transform 0.2s; z-index: 10;
    white-space: nowrap;
  }
  .fmt-hint.visible { opacity: 1; transform: translateY(0); }
  .fmt-hint code { background: rgba(232,135,74,0.15); border-radius:3px; padding:0 3px; font-family:'Space Mono',monospace; font-size:10px; }

  .typing-humor-text {
    font-size: 11px; color: var(--text-muted); font-style: italic;
    white-space: nowrap; overflow: hidden;
    animation: humor-fade 0.4s ease both;
    flex: 1; min-width: 0; text-overflow: ellipsis;
  }
  @keyframes humor-fade { from { opacity:0; transform: translateY(4px);} to { opacity:1; transform: translateY(0);} }

  /* ============ AUTODESTRUIÇÃO VISUAL (POEIRA) ============ */
  .msg-bubble.autodestruct {
    position: relative;
  }
  .autodestruct-ring {
    position: absolute; inset: -3px; border-radius: inherit;
    border: 2px solid transparent;
    background: conic-gradient(var(--orange-soft) 0%, transparent 0%) border-box;
    -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: destination-out;
    mask-composite: exclude;
    transition: background 0.1s linear;
    pointer-events: none;
    border-radius: 14px;
  }
  .autodestruct-badge {
    display: inline-flex; align-items: center; gap: 3px;
    background: rgba(232,135,74,0.15); border: 1px solid rgba(232,135,74,0.3);
    border-radius: 8px; padding: 2px 7px; font-size: 10px;
    color: var(--orange-soft); font-family: 'Space Mono', monospace;
    margin-left: 6px; cursor: pointer; transition: background 0.2s;
    vertical-align: middle;
  }
  .autodestruct-badge:hover { background: rgba(232,135,74,0.25); }
  .autodestruct-badge .ad-icon { font-size: 10px; }
  /* Partículas de poeira */
  .dust-particle {
    position: fixed; pointer-events: none; z-index: 9999;
    border-radius: 50%; opacity: 1;
    animation: dust-fly var(--dur, 0.8s) ease-out forwards;
  }
  @keyframes dust-fly {
    0% { transform: translate(0,0) scale(1); opacity:1; }
    100% { transform: translate(var(--tx),var(--ty)) scale(0); opacity:0; }
  }

  /* ============ MODO FANTASMA (melhorado com pulso) ============ */
  .ghost-pulse {
    animation: ghost-pulse-anim 2s infinite;
  }
  @keyframes ghost-pulse-anim {
    0%,100% { opacity:1; }
    50% { opacity:0.5; }
  }

  /* ============ EMOJI CONTEXTUAL ============ */
  .emoji-contextual {
    position: absolute; bottom: 100%; left: 0; right: 0;
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 14px 14px 0 0; padding: 12px 14px 8px;
    display: none; flex-direction: column; gap: 8px;
    box-shadow: 0 -12px 30px rgba(0,0,0,0.5);
    z-index: 20; margin-bottom: 0;
  }
  .emoji-contextual.visible { display: flex; }
  .emoji-ctx-header {
    font-size: 10px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600;
    display: flex; align-items: center; gap: 6px;
  }
  .emoji-ctx-header::before {
    content: '✨'; font-size: 11px;
  }
  .emoji-ctx-row {
    display: flex; gap: 6px; flex-wrap: wrap;
  }
  .emoji-ctx-btn {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 6px 10px; font-size: 18px;
    cursor: pointer; transition: all 0.15s; display: flex;
    align-items: center; gap: 4px; position: relative;
  }
  .emoji-ctx-btn:hover { background: var(--orange-dim); border-color: var(--orange-soft); transform: scale(1.15); }
  .emoji-ctx-btn.top-suggestion {
    border-color: rgba(232,135,74,0.4);
    box-shadow: 0 0 8px rgba(232,135,74,0.15);
  }
  .emoji-ctx-label {
    font-size: 9px; color: var(--text-muted); font-family:'Space Mono',monospace;
  }
  .emoji-ctx-divider {
    width: 1px; background: var(--border); align-self: stretch; margin: 0 4px;
  }

  /* ============ BOLHA DIGITANDO COM HUMOR ============ */
  /* (já integrado acima no .typing-bubble) */

  /* ============ MOOD DO DIA ============ */
  .mood-selector {
    position: absolute; bottom: 100%; left: 0;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 10px; display: none;
    flex-wrap: wrap; gap: 6px; width: 200px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.4); z-index: 100;
  }
  .mood-selector.visible { display: flex; }
  .mood-opt {
    background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 8px; padding: 5px 8px; cursor: pointer;
    font-size: 13px; display: flex; align-items: center; gap: 4px;
    transition: all 0.15s; white-space: nowrap;
  }
  .mood-opt:hover { border-color: var(--orange-soft); background: var(--orange-dim); }
  .mood-opt.active { border-color: var(--orange-soft); background: rgba(232,135,74,0.2); }
  .mood-opt-label { font-size: 10px; color: var(--text-muted); }
  .mood-badge {
    display: inline-flex; align-items: center; gap: 3px;
    font-size: 11px; color: var(--text-secondary);
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 8px; padding: 1px 6px; cursor: pointer;
    transition: all 0.2s; animation: mood-pulse 3s infinite;
  }
  .mood-badge:hover { border-color: var(--orange-soft); }
  @keyframes mood-pulse {
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  /* Mood no contato da lista */
  .contact-mood {
    font-size: 14px; line-height: 1; flex-shrink: 0;
    filter: drop-shadow(0 0 3px rgba(255,255,255,0.2));
  }

  /* ============ CÁPSULA DO TEMPO ============ */
  .capsula-msg {
    background: linear-gradient(135deg, #1a0e08, #0e0e1a);
    border: 1px solid rgba(232,135,74,0.3);
    border-radius: 14px; padding: 12px 16px;
    position: relative; overflow: hidden;
    cursor: default;
  }
  .capsula-msg::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(232,135,74,0.08), transparent 70%);
    pointer-events: none;
  }
  .capsula-header {
    display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
  }
  .capsula-icon { font-size: 20px; animation: capsula-float 3s ease-in-out infinite; }
  @keyframes capsula-float {
    0%,100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }
  .capsula-title {
    font-size: 12px; font-weight: 600; color: var(--orange-soft);
    font-family: 'Space Mono', monospace; letter-spacing: 0.5px;
  }
  .capsula-subtitle { font-size: 10px; color: var(--text-muted); }
  .capsula-body { font-size: 13px; color: var(--text-secondary); font-style: italic; }
  .capsula-lacre {
    margin-top: 10px; padding-top: 8px; border-top: 1px dashed rgba(232,135,74,0.2);
    display: flex; align-items: center; justify-content: space-between;
  }
  .capsula-delivery {
    font-size: 10px; color: var(--text-muted); font-family:'Space Mono',monospace;
  }
  .capsula-status {
    font-size: 10px; display: flex; align-items: center; gap: 4px;
    color: var(--orange-soft);
  }
  .capsula-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--orange-soft); animation: blink 1.5s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
  /* Explode ao abrir */
  .capsula-aberta {
    border-color: var(--orange-soft) !important;
    animation: capsula-open 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
  }
  @keyframes capsula-open {
    0% { transform: scale(0.8); opacity:0.5; }
    100% { transform: scale(1); opacity:1; }
  }
  /* Confete */
  .confete {
    position: fixed; pointer-events: none; z-index: 9999;
    width: 8px; height: 8px; border-radius: 2px;
    animation: confete-fall var(--dur,1.2s) ease-out forwards;
  }
  @keyframes confete-fall {
    0% { transform: translate(0,0) rotate(0deg); opacity:1; }
    100% { transform: translate(var(--tx),var(--ty)) rotate(var(--rot,360deg)); opacity:0; }
  }

  /* ============ TIMELINE DA AMIZADE ============ */
  .timeline-overlay {
    position: fixed; inset:0; z-index: 3000;
    background: rgba(0,0,0,0.85); backdrop-filter: blur(6px);
    display: none; align-items: center; justify-content: center;
    animation: tl-fade-in 0.3s ease both;
  }
  .timeline-overlay.visible { display: flex; }
  @keyframes tl-fade-in { from{opacity:0} to{opacity:1} }
  .timeline-panel {
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 20px; width: 360px; max-width: 95vw;
    max-height: 80vh; overflow-y: auto; overflow-x: hidden;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6);
    animation: tl-slide-up 0.4s cubic-bezier(0.16,1,0.3,1) both;
  }
  @keyframes tl-slide-up { from{transform:translateY(30px);opacity:0} to{transform:translateY(0);opacity:1} }
  .timeline-panel::-webkit-scrollbar { width: 3px; }
  .timeline-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .timeline-header {
    padding: 18px 20px 14px; border-bottom: 1px solid var(--border);
    position: sticky; top: 0; background: var(--bg-panel); z-index:1;
    display: flex; align-items: center; justify-content: space-between;
  }
  .timeline-title { font-size: 15px; font-weight: 700; }
  .timeline-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .timeline-close {
    width: 28px; height: 28px; border-radius: 8px;
    background: var(--bg-card); border: 1px solid var(--border);
    cursor: pointer; color: var(--text-muted); font-size: 14px;
    display: flex; align-items: center; justify-content: center;
  }
  .timeline-close:hover { border-color: var(--orange-soft); color: var(--orange-soft); }
  .timeline-body { padding: 16px 20px; }
  .tl-item {
    display: flex; gap: 14px; margin-bottom: 20px;
    animation: tl-item-in 0.4s ease both;
  }
  .tl-item:nth-child(1){animation-delay:0.05s}
  .tl-item:nth-child(2){animation-delay:0.1s}
  .tl-item:nth-child(3){animation-delay:0.15s}
  .tl-item:nth-child(4){animation-delay:0.2s}
  .tl-item:nth-child(5){animation-delay:0.25s}
  .tl-item:nth-child(6){animation-delay:0.3s}
  @keyframes tl-item-in { from{opacity:0;transform:translateX(-10px)} to{opacity:1;transform:translateX(0)} }
  .tl-line { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
  .tl-icon {
    width: 36px; height: 36px; border-radius: 10px;
    background: var(--bg-card); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .tl-connector { width: 1px; flex: 1; background: var(--border); margin: 4px 0; min-height: 14px; }
  .tl-content { flex: 1; padding-top: 4px; }
  .tl-label { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
  .tl-date { font-size: 10px; color: var(--text-muted); font-family:'Space Mono',monospace; margin-bottom: 4px; }
  .tl-preview {
    font-size: 12px; color: var(--text-secondary);
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 8px; padding: 6px 10px;
    font-style: italic;
  }
  .tl-preview.special {
    border-color: rgba(232,135,74,0.3);
    background: rgba(232,135,74,0.05);
    color: var(--text-primary);
  }
  .timeline-stats {
    display: flex; gap: 8px; margin-top: 4px;
  }
  .tl-stat {
    flex: 1; background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px; text-align: center;
  }
  .tl-stat-n { font-size: 18px; font-weight: 700; color: var(--orange-soft); font-family:'Space Mono',monospace; }
  .tl-stat-l { font-size: 10px; color: var(--text-muted); margin-top: 2px; }


  /* ══════════════════════════════════════════════
     UPGRADE: FORMATAÇÃO RICA
  ══════════════════════════════════════════════ */
  .msg-bubble b  { font-weight: 700; color: inherit; }
  .msg-bubble i  { font-style: italic; color: inherit; }
  .msg-bubble s  { text-decoration: line-through; opacity: .7; }
  .msg-bubble code {
    font-family: 'Space Mono', monospace; font-size: 12px;
    background: rgba(232,135,74,0.15); border: 1px solid rgba(232,135,74,0.3);
    border-radius: 5px; padding: 1px 5px; color: var(--orange-soft);
  }
  .msg-bubble .mention {
    color: var(--orange-soft); font-weight: 600; cursor: pointer;
    background: rgba(232,135,74,0.12); border-radius: 5px;
    padding: 0 4px; transition: background .15s;
  }
  .msg-bubble .mention:hover { background: rgba(232,135,74,0.25); }

  /* ══════════════════════════════════════════════
     UPGRADE: BARRA DE PESQUISA
  ══════════════════════════════════════════════ */
  .search-bar-chat {
    display: none; align-items: center; gap: 8px;
    padding: 8px 18px; background: var(--bg-panel);
    border-bottom: 1px solid var(--border);
    position: relative; z-index: 2;
  }
  .search-bar-chat.visible { display: flex; }
  .search-bar-chat input {
    flex: 1; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 12px;
    font-family: 'Sora', sans-serif; font-size: 13px; color: var(--text-primary);
    outline: none; transition: border-color .2s;
  }
  .search-bar-chat input:focus { border-color: var(--orange-soft); }
  .search-bar-chat input::placeholder { color: var(--text-muted); }
  .search-nav { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
  .search-count { font-size: 11px; color: var(--text-muted); font-family:'Space Mono',monospace; min-width: 44px; text-align:center; }
  .search-nav-btn {
    width: 28px; height: 28px; border-radius: 7px;
    background: var(--bg-card); border: 1px solid var(--border);
    cursor: pointer; color: var(--text-muted); font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .search-nav-btn:hover { border-color: var(--orange-soft); color: var(--orange-soft); }
  .search-close-btn {
    width: 28px; height: 28px; border-radius: 7px;
    background: transparent; border: 1px solid var(--border);
    cursor: pointer; color: var(--text-muted); font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .search-close-btn:hover { border-color: #c05050; color: #c05050; }
  .msg-highlight { background: rgba(232,135,74,0.35) !important; border-radius: 3px; }
  .msg-highlight-current { background: rgba(232,135,74,0.7) !important; outline: 1px solid var(--orange-soft); }

  /* ══════════════════════════════════════════════
     UPGRADE: QUICK REPLIES
  ══════════════════════════════════════════════ */
  .quick-replies {
    display: none; flex-wrap: wrap; gap: 6px;
    padding: 8px 18px 4px; position: relative; z-index: 1;
    animation: humor-fade .25s ease both;
  }
  .quick-replies.visible { display: flex; }
  .qr-chip {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 20px; padding: 6px 14px;
    font-size: 12px; color: var(--text-secondary); cursor: pointer;
    transition: all .15s; white-space: nowrap;
  }
  .qr-chip:hover { border-color: var(--orange-soft); color: var(--orange-soft); background: var(--orange-dim); transform: translateY(-1px); }

  /* ══════════════════════════════════════════════
     UPGRADE: CARD INTERATIVO
  ══════════════════════════════════════════════ */
  .card-msg {
    border-radius: 14px; overflow: hidden;
    border: 1px solid var(--border); max-width: 280px; cursor: default;
  }
  .card-msg-header {
    padding: 12px 14px 8px; position: relative;
  }
  .card-msg-badge {
    font-size: 10px; font-weight: 700; letter-spacing: .8px;
    text-transform: uppercase; opacity: .8; margin-bottom: 4px;
    font-family: 'Space Mono', monospace;
  }
  .card-msg-title { font-size: 15px; font-weight: 700; line-height: 1.25; }
  .card-msg-body { padding: 8px 14px 12px; font-size: 13px; line-height: 1.5; }
  .card-msg-footer {
    padding: 8px 14px; border-top: 1px solid rgba(255,255,255,.06);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-msg-tag { font-size: 10px; opacity: .5; font-family:'Space Mono',monospace; }
  .card-msg-icon { font-size: 18px; }

  /* Card creator overlay */
  .card-creator {
    position: fixed; inset: 0; z-index: 4000;
    background: rgba(0,0,0,.85); backdrop-filter: blur(6px);
    display: none; align-items: center; justify-content: center;
  }
  .card-creator.visible { display: flex; }
  .card-creator-panel {
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 20px; width: 360px; max-width: 95vw; padding: 22px;
    animation: tl-slide-up .35s cubic-bezier(.16,1,.3,1) both;
    box-shadow: 0 24px 80px rgba(0,0,0,.6);
  }
  .card-creator h3 { font-size: 15px; font-weight: 700; margin-bottom: 16px; }
  .card-creator label { font-size: 11px; color: var(--text-muted); text-transform:uppercase; letter-spacing:.6px; display:block; margin-bottom:4px; margin-top:12px; }
  .card-creator input, .card-creator textarea, .card-creator select {
    width: 100%; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 9px 12px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 13px; outline: none;
    transition: border-color .2s; resize: none;
  }
  .card-creator input:focus, .card-creator textarea:focus, .card-creator select:focus { border-color: var(--orange-soft); }
  .card-creator textarea { height: 72px; }
  .card-colors { display: flex; gap: 8px; margin-top: 6px; }
  .card-color-opt {
    width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
    border: 2px solid transparent; transition: border-color .15s, transform .15s;
  }
  .card-color-opt.selected, .card-color-opt:hover { border-color: white; transform: scale(1.1); }
  .card-creator-actions { display: flex; gap: 8px; margin-top: 18px; }
  .cc-btn {
    flex: 1; padding: 10px; border-radius: 10px; font-family:'Sora',sans-serif;
    font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all .15s;
  }
  .cc-btn.cancel { background: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border); }
  .cc-btn.send { background: var(--orange-soft); color: white; }
  .cc-btn.send:hover { background: #d4733a; }

  /* ══════════════════════════════════════════════
     UPGRADE: MENÇÃO @
  ══════════════════════════════════════════════ */
  .mention-popup {
    position: absolute; bottom: 100%; left: 14px;
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 12px; width: 220px; overflow: hidden;
    box-shadow: 0 -8px 24px rgba(0,0,0,.5);
    display: none; z-index: 30;
    animation: humor-fade .2s ease both;
  }
  .mention-popup.visible { display: block; }
  .mention-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 12px; cursor: pointer; transition: background .12s;
  }
  .mention-item:hover { background: var(--bg-card); }
  .mention-item-av {
    width: 30px; height: 30px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; flex-shrink: 0;
  }
  .mention-item-name { font-size: 13px; font-weight: 500; }
  .mention-item-status { font-size: 10px; color: var(--text-muted); }

  /* Mini card de perfil ao clicar em menção */
  .mention-card {
    position: fixed; z-index: 5000;
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 14px; width: 200px; padding: 14px;
    box-shadow: 0 8px 32px rgba(0,0,0,.6);
    display: none; animation: humor-fade .2s ease both;
  }
  .mention-card.visible { display: block; }
  .mention-card-av {
    width: 44px; height: 44px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; font-weight: 700; margin-bottom: 8px;
  }
  .mention-card-name { font-size: 14px; font-weight: 700; }
  .mention-card-status { font-size: 11px; margin-top: 2px; }
  .mention-card-mood { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
  .mention-card-close {
    position: absolute; top: 8px; right: 8px;
    background: transparent; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 14px; padding: 2px 5px;
  }

  /* ══════════════════════════════════════════════
     UPGRADE: HISTÓRICO DE EDIÇÕES
  ══════════════════════════════════════════════ */
  .edit-badge {
    font-size: 10px; color: var(--text-muted); cursor: pointer;
    margin-left: 4px; font-style: italic; transition: color .15s;
  }
  .edit-badge:hover { color: var(--orange-soft); }
  .edit-history-popup {
    position: fixed; z-index: 5000;
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 12px; width: 260px; padding: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,.6);
    display: none;
  }
  .edit-history-popup.visible { display: block; animation: humor-fade .2s ease both; }
  .edit-history-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform:uppercase; letter-spacing:.6px; margin-bottom: 8px; }
  .edit-history-item { padding: 6px 0; border-bottom: 1px solid var(--border); }
  .edit-history-item:last-child { border-bottom: none; }
  .edit-history-ver { font-size: 10px; color: var(--orange-soft); font-family:'Space Mono',monospace; margin-bottom: 2px; }
  .edit-history-text { font-size: 12px; color: var(--text-secondary); }

  /* ══════════════════════════════════════════════
     UPGRADE: MODO FOCO
  ══════════════════════════════════════════════ */
  .focus-vignette {
    position: fixed; inset: 0; pointer-events: none; z-index: 2500;
    background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,.6) 100%);
    display: none; transition: opacity .5s;
  }
  .focus-vignette.visible { display: block; }
  .focus-banner {
    position: fixed; top: 0; left: 0; right: 0; z-index: 2600;
    background: linear-gradient(90deg, #1a0e08, #0e1a0e);
    border-bottom: 1px solid rgba(232,135,74,.3);
    padding: 8px 18px; display: none; align-items: center; justify-content: space-between;
    animation: humor-fade .3s ease both;
  }
  .focus-banner.visible { display: flex; }
  .focus-banner-left { display: flex; align-items: center; gap: 10px; }
  .focus-banner-icon { font-size: 16px; }
  .focus-banner-text { font-size: 13px; font-weight: 600; color: var(--orange-soft); }
  .focus-banner-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
  .focus-timer { font-family:'Space Mono',monospace; font-size: 14px; color: var(--orange-soft); }
  .focus-end-btn {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 8px; padding: 5px 12px; cursor: pointer;
    font-size: 12px; color: var(--text-muted); font-family:'Sora',sans-serif;
    transition: all .15s;
  }
  .focus-end-btn:hover { border-color: var(--orange-soft); color: var(--orange-soft); }

  /* ══════════════════════════════════════════════
     UPGRADE: STICKERS
  ══════════════════════════════════════════════ */
  .sticker-panel {
    position: absolute; bottom: 100%; left: 0; right: 0;
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 14px 14px 0 0; padding: 12px 14px 8px;
    display: none; flex-direction: column; gap: 8px;
    box-shadow: 0 -12px 30px rgba(0,0,0,.5); z-index: 20;
  }
  .sticker-panel.visible { display: flex; }
  .sticker-grid { display: flex; flex-wrap: wrap; gap: 8px; }
  .sticker-btn {
    width: 56px; height: 56px; border-radius: 12px;
    background: var(--bg-card); border: 1px solid var(--border);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all .15s; flex-shrink: 0; overflow: hidden;
  }
  .sticker-btn:hover { border-color: var(--orange-soft); transform: scale(1.08); }
  .sticker-svg { width: 40px; height: 40px; }
  .sticker-panel-title { font-size: 10px; color: var(--text-muted); text-transform:uppercase; letter-spacing:.7px; font-weight:600; }

  /* Sticker na bolha */
  .sticker-bubble {
    background: transparent !important; border: none !important;
    padding: 4px !important; cursor: default;
  }
  .sticker-bubble svg { width: 80px; height: 80px; }

  /* ══════════════════════════════════════════════
     UPGRADE: SALA FLASH
  ══════════════════════════════════════════════ */
  .sala-flash-overlay {
    position: fixed; inset: 0; z-index: 4500;
    background: rgba(0,0,0,.85); backdrop-filter: blur(6px);
    display: none; align-items: center; justify-content: center;
  }
  .sala-flash-overlay.visible { display: flex; }
  .sala-flash-panel {
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 20px; width: 340px; max-width: 95vw;
    padding: 24px; box-shadow: 0 24px 80px rgba(0,0,0,.6);
    animation: tl-slide-up .35s cubic-bezier(.16,1,.3,1) both;
  }
  .sf-title { font-size: 17px; font-weight: 800; margin-bottom: 4px; }
  .sf-sub { font-size: 12px; color: var(--text-muted); margin-bottom: 20px; }
  .sf-code-display {
    text-align: center; font-family:'Space Mono',monospace;
    font-size: 32px; font-weight: 700; letter-spacing: 8px;
    color: var(--orange-soft); background: var(--bg-card);
    border: 1px solid rgba(232,135,74,.3); border-radius: 14px;
    padding: 16px; margin-bottom: 16px;
    text-shadow: 0 0 20px rgba(232,135,74,.3);
  }
  .sf-expiry { text-align:center; font-size:11px; color: var(--text-muted); margin-bottom: 16px; font-family:'Space Mono',monospace; }
  .sf-input {
    width: 100%; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px; color: var(--text-primary);
    font-family:'Space Mono',monospace; font-size: 18px; letter-spacing: 4px;
    text-align: center; outline: none; transition: border-color .2s;
  }
  .sf-input:focus { border-color: var(--orange-soft); }
  .sf-tabs { display: flex; gap: 6px; margin-bottom: 16px; }
  .sf-tab {
    flex: 1; padding: 8px; border-radius: 9px; text-align: center;
    font-size: 13px; font-weight: 600; cursor: pointer;
    border: 1px solid var(--border); background: var(--bg-card);
    color: var(--text-muted); transition: all .15s;
  }
  .sf-tab.active { background: var(--orange-soft); color: white; border-color: var(--orange-soft); }
  .sf-members { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; max-height: 120px; overflow-y: auto; }
  .sf-member {
    display: flex; align-items: center; gap: 8px;
    background: var(--bg-card); border-radius: 8px; padding: 7px 10px;
  }
  .sf-member-av {
    width: 26px; height: 26px; border-radius: 50%;
    background: var(--orange-dim); border: 1px solid rgba(232,135,74,.3);
    display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700;
  }
  .sf-member-name { font-size: 12px; }
  .sf-actions { display: flex; gap: 8px; }
  .sf-btn {
    flex: 1; padding: 10px; border-radius: 10px;
    font-family:'Sora',sans-serif; font-size: 13px; font-weight: 600;
    cursor: pointer; border: none; transition: all .15s;
  }
  .sf-btn.cancel { background: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border); }
  .sf-btn.primary { background: var(--orange-soft); color: white; }
  .sf-btn.primary:hover { background: #d4733a; }

  /* ══════════════════════════════════════════════
     UPGRADE: WRAP-UP SEMANAL
  ══════════════════════════════════════════════ */
  .wrapup-overlay {
    position: fixed; inset: 0; z-index: 4200;
    background: rgba(0,0,0,.9); backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center;
  }
  .wrapup-overlay.visible { display: flex; }
  .wrapup-panel {
    background: linear-gradient(145deg, #1a0e08, #0e0e1a);
    border: 1px solid rgba(232,135,74,.3);
    border-radius: 24px; width: 340px; max-width: 95vw;
    padding: 28px; box-shadow: 0 0 60px rgba(232,135,74,.1), 0 24px 80px rgba(0,0,0,.8);
    animation: tl-slide-up .4s cubic-bezier(.16,1,.3,1) both;
    position: relative; overflow: hidden;
  }
  .wrapup-panel::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(232,135,74,.08), transparent 60%);
    pointer-events: none;
  }
  .wrapup-week { font-size: 11px; font-family:'Space Mono',monospace; color: var(--orange-soft); letter-spacing:1px; margin-bottom: 4px; }
  .wrapup-title { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
  .wrapup-sub { font-size: 12px; color: var(--text-muted); margin-bottom: 22px; }
  .wrapup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .wu-card {
    background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.07);
    border-radius: 12px; padding: 12px;
    animation: tl-item-in .4s ease both;
  }
  .wu-card:nth-child(1){animation-delay:.05s} .wu-card:nth-child(2){animation-delay:.1s}
  .wu-card:nth-child(3){animation-delay:.15s} .wu-card:nth-child(4){animation-delay:.2s}
  .wu-icon { font-size: 20px; margin-bottom: 6px; }
  .wu-label { font-size: 10px; color: var(--text-muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom: 2px; }
  .wu-value { font-size: 18px; font-weight: 800; font-family:'Space Mono',monospace; color: var(--orange-soft); }
  .wu-detail { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
  .wrapup-highlight {
    background: rgba(232,135,74,.08); border: 1px solid rgba(232,135,74,.2);
    border-radius: 12px; padding: 12px; margin-bottom: 16px;
    animation: tl-item-in .4s .25s ease both;
  }
  .wh-label { font-size: 10px; color: var(--orange-soft); text-transform:uppercase; letter-spacing:.6px; font-weight:700; margin-bottom: 4px; }
  .wh-text { font-size: 13px; font-style:italic; color: var(--text-secondary); }
  .wrapup-close {
    width: 100%; padding: 12px; border-radius: 12px;
    background: var(--orange-soft); color: white; border: none;
    font-family:'Sora',sans-serif; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: background .15s;
  }
  .wrapup-close:hover { background: #d4733a; }
  .wrapup-share {
    text-align: center; font-size: 11px; color: var(--text-muted);
    margin-top: 10px; cursor: pointer; transition: color .15s;
  }
  .wrapup-share:hover { color: var(--orange-soft); }

  /* Input área */
  .chat-input-wrap {
    padding: 12px 18px; border-top: 1px solid var(--border);
    display: flex; align-items: flex-end; gap: 8px;
    background: var(--bg-panel); position: relative; z-index: 2;
  }

  .chat-input {
    flex: 1; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 12px; padding: 11px 14px;
    font-family: 'Sora', sans-serif; font-size: 14px; color: var(--text-primary);
    outline: none; transition: border-color 0.2s;
    resize: none; max-height: 120px; line-height: 1.4;
  }
  .chat-input::placeholder { color: var(--text-muted); }
  .chat-input:focus { border-color: var(--orange-soft); }

  .btn-send {
    width: 42px; height: 42px; border-radius: 12px;
    background: linear-gradient(135deg, #e8874a, #c05820);
    border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: transform 0.15s, box-shadow 0.15s;
    box-shadow: 0 4px 14px #e8874a25;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-send:hover { transform: scale(1.06); }
  .btn-send:active { transform: scale(0.94); }
  .btn-send svg { width: 17px; height: 17px; fill: white; }

  .btn-icon-input {
    width: 38px; height: 38px; border-radius: 10px;
    background: transparent; border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s, border-color 0.2s;
    flex-shrink: 0; color: var(--text-muted);
    -webkit-tap-highlight-color: transparent;
    user-select: none; -webkit-user-select: none;
  }
  .btn-icon-input:hover { background: var(--bg-card); color: var(--text-secondary); }
  .btn-icon-input svg { width: 16px; height: 16px; stroke: currentColor; fill: none; }

  /* Botão de microfone */
  .btn-mic {
    width: 42px; height: 42px; border-radius: 12px;
    background: var(--bg-input); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; flex-shrink: 0;
    transition: background 0.2s, border-color 0.2s, transform 0.15s;
    color: var(--text-muted);
    -webkit-tap-highlight-color: transparent;
    user-select: none; -webkit-user-select: none;
  }
  .btn-mic:hover { background: var(--bg-card); border-color: #333; color: var(--text-secondary); }
  .btn-mic.recording {
    background: #2a1010; border-color: #c05050; color: #e05050;
    animation: mic-pulse 1s infinite;
  }
  @keyframes mic-pulse {
    0%,100% { box-shadow: 0 0 0 0 #c0505030; }
    50%      { box-shadow: 0 0 0 8px #c0505000; }
  }
  .btn-mic svg { width: 17px; height: 17px; stroke: currentColor; fill: none; }

  /* Emoji picker */
  .emoji-picker {
    position: absolute; bottom: 70px; left: 18px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 14px; padding: 12px;
    display: none; flex-wrap: wrap; gap: 6px; width: 280px;
    box-shadow: 0 8px 32px #00000050; z-index: 20;
    animation: picker-in 0.15s ease both;
  }
  .emoji-picker.open { display: flex; }
  .emoji-picker-title {
    width: 100%; font-size: 10px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px;
  }
  .emoji-btn {
    font-size: 22px; cursor: pointer; line-height: 1;
    padding: 4px; border-radius: 8px; transition: background 0.15s, transform 0.15s;
    background: transparent; border: none;
  }
  .emoji-btn:hover { background: var(--bg-input); transform: scale(1.2); }

  /* Reaction picker */
  .reaction-picker {
    position: absolute; z-index: 30;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 30px; padding: 6px 10px;
    display: none; gap: 6px;
    box-shadow: 0 8px 24px #00000060;
    animation: picker-in 0.15s ease both;
  }
  .reaction-picker.open { display: flex; }
  .reaction-picker .emoji-btn { font-size: 20px; }

  /* Boas-vindas */

  /* ══════════════════════════════════════════
     UPGRADE SIDEBAR 1 — HEADER ELEVADO
  ══════════════════════════════════════════ */
  .sidebar-header {
    padding: 14px 16px 12px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    background: linear-gradient(180deg, #161410, var(--bg-panel));
    position: relative; overflow: hidden;
  }
  .sidebar-header::after {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 30% 50%, rgba(232,135,74,0.06), transparent 70%);
    pointer-events: none;
  }
  .sidebar-logo {
    position: relative;
    animation: logo-breathe 4s ease-in-out infinite;
  }
  @keyframes logo-breathe {
    0%,100% { box-shadow: 0 4px 12px #e8874a20; }
    50%      { box-shadow: 0 4px 22px #e8874a50; }
  }
  .conn-badge {
    display: flex; align-items: center; gap: 5px;
    font-family: 'Space Mono', monospace;
    font-size: 9px; color: var(--text-muted); letter-spacing: 0.5px;
    margin-top: 2px;
  }
  .conn-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green-online);
    animation: conn-pulse 2s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes conn-pulse {
    0%,100% { opacity: 1; transform: scale(1); }
    50%      { opacity: 0.5; transform: scale(0.8); }
  }
  .conn-dot.offline { background: var(--text-muted); animation: none; }
  .sidebar-brand-wrap { display: flex; flex-direction: column; gap: 1px; }

  /* ══════════════════════════════════════════
     UPGRADE SIDEBAR 2 — MINI DASHBOARD
  ══════════════════════════════════════════ */
  .dash-bar {
    padding: 10px 14px 8px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-panel);
    cursor: pointer; transition: background 0.2s;
    overflow: hidden;
  }
  .dash-bar:hover { background: var(--bg-card); }
  .dash-grid {
    display: flex; gap: 6px;
    transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1),
                opacity 0.3s ease, margin 0.3s ease;
    max-height: 80px; opacity: 1;
  }
  .dash-grid.collapsed { max-height: 0; opacity: 0; margin: 0; pointer-events: none; }
  .dash-card {
    flex: 1; background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 10px; text-align: center;
    transition: border-color 0.2s;
  }
  .dash-card:hover { border-color: rgba(232,135,74,0.3); }
  .dash-n {
    font-family: 'Space Mono', monospace; font-size: 17px;
    font-weight: 700; color: var(--orange-soft); line-height: 1.1;
  }
  .dash-l { font-size: 9px; color: var(--text-muted); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
  .dash-toggle {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 6px;
  }
  .dash-toggle-label {
    font-size: 10px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.8px;
  }
  .dash-chevron {
    font-size: 10px; color: var(--text-muted);
    transition: transform 0.3s ease;
  }
  .dash-chevron.open { transform: rotate(180deg); }

  /* ══════════════════════════════════════════
     UPGRADE SIDEBAR 3 — STORIES NA SIDEBAR
  ══════════════════════════════════════════ */
  .stories-bar {
    padding: 10px 14px;
    display: flex; gap: 12px; overflow-x: auto;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    cursor: grab;
  }
  .stories-bar:active { cursor: grabbing; }
  .stories-bar::-webkit-scrollbar { display: none; }
  /* Sombra fade nas bordas indicando que há mais conteúdo */
  .stories-bar-wrap {
    position: relative;
    border-bottom: 1px solid var(--border);
  }
  .stories-bar-wrap::after {
    content: '';
    position: absolute; top: 0; right: 0; bottom: 0;
    width: 32px;
    background: linear-gradient(to right, transparent, var(--bg-panel));
    pointer-events: none; z-index: 1;
  }
  .story-thumb {
    display: flex; flex-direction: column; align-items: center;
    gap: 4px; cursor: pointer; flex-shrink: 0;
    transition: transform 0.2s;
  }
  .story-thumb:hover { transform: scale(1.08); }
  .story-ring {
    width: 48px; height: 48px; border-radius: 50%;
    padding: 2px;
    background: conic-gradient(var(--orange-soft) 0%, var(--orange-soft) var(--pct,100%), #333 var(--pct,100%));
    position: relative;
  }
  .story-ring.visto {
    background: conic-gradient(#444 0%, #444 100%);
  }
  .story-ring.novo {
    animation: story-glow 2.5s ease-in-out infinite;
  }
  @keyframes story-glow {
    0%,100% { filter: drop-shadow(0 0 4px rgba(232,135,74,0.4)); }
    50%      { filter: drop-shadow(0 0 10px rgba(232,135,74,0.8)); }
  }
  .story-av {
    width: 100%; height: 100%; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 600;
    border: 2px solid var(--bg-panel);
  }
  .story-name { font-size: 10px; color: var(--text-muted); max-width: 52px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .story-add {
    width: 48px; height: 48px; border-radius: 50%;
    border: 1.5px dashed var(--border); display: flex;
    align-items: center; justify-content: center;
    font-size: 20px; color: var(--text-muted); cursor: pointer;
    transition: all 0.2s; flex-shrink: 0;
  }
  .story-add:hover { border-color: var(--orange-soft); color: var(--orange-soft); }

  /* ══════════════════════════════════════════
     UPGRADE SIDEBAR 4 — FILTROS
  ══════════════════════════════════════════ */
  .filter-chips {
    display: flex; gap: 6px; padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    overflow-x: auto; scrollbar-width: none;
  }
  .filter-chips::-webkit-scrollbar { display: none; }
  .chip {
    padding: 4px 12px; border-radius: 20px; font-size: 11px;
    font-weight: 500; border: 1px solid var(--border);
    background: transparent; color: var(--text-muted);
    cursor: pointer; white-space: nowrap;
    transition: all 0.18s; flex-shrink: 0;
  }
  .chip:hover { border-color: #444; color: var(--text-secondary); }
  .chip.active {
    background: var(--orange-soft); border-color: var(--orange-soft);
    color: white; font-weight: 600;
  }
  .chip .chip-badge {
    display: inline-flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.25); border-radius: 8px;
    min-width: 14px; height: 14px; font-size: 9px;
    padding: 0 3px; margin-left: 4px; font-weight: 700;
  }

  /* ══════════════════════════════════════════
     UPGRADE SIDEBAR 5 — RANKING TOP 3
  ══════════════════════════════════════════ */
  .top3-section {
    padding: 10px 14px 6px;
    border-bottom: 1px solid var(--border);
  }
  .top3-label {
    font-size: 10px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px;
    display: flex; align-items: center; gap: 5px;
  }
  .top3-label::before { content: '★'; color: var(--orange-soft); font-size: 10px; }
  .top3-row { display: flex; gap: 14px; justify-content: flex-start; }
  .top3-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
  .top3-ring {
    position: relative; width: 46px; height: 46px;
    border-radius: 50%;
  }
  .top3-ring svg {
    position: absolute; inset: 0; width: 100%; height: 100%;
    transform: rotate(-90deg);
  }
  .top3-ring svg circle { fill: none; stroke-linecap: round; }
  .top3-av {
    position: absolute; inset: 4px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 600;
  }
  .top3-name { font-size: 10px; color: var(--text-muted); max-width: 50px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .top3-crown { font-size: 9px; }

  /* ══════════════════════════════════════════
     UPGRADE SIDEBAR 6 — HOVER PREVIEW
  ══════════════════════════════════════════ */
  .contact-preview-popup {
    position: fixed; z-index: 500;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 14px; padding: 12px 14px; width: 240px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    pointer-events: none; opacity: 0; transform: translateX(-8px);
    transition: opacity 0.18s ease, transform 0.18s ease;
  }
  .contact-preview-popup.visible { opacity: 1; transform: translateX(0); }
  .cpp-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
  .cpp-av { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
  .cpp-name { font-size: 13px; font-weight: 600; }
  .cpp-status { font-size: 11px; color: var(--text-muted); }
  .cpp-msgs { display: flex; flex-direction: column; gap: 4px; }
  .cpp-msg {
    font-size: 11px; color: var(--text-secondary);
    background: var(--bg-input); border-radius: 8px; padding: 5px 9px;
    border-left: 2px solid var(--border);
  }
  .cpp-msg.out { border-left-color: var(--orange-soft); }
  .cpp-msg.in  { border-left-color: #4a80c0; }

  /* ══════════════════════════════════════════
     UPGRADE SIDEBAR 7 — PENSANDO EM VOCÊ
  ══════════════════════════════════════════ */
  .nudge-card {
    margin: 8px 14px 2px;
    background: linear-gradient(135deg, #1a0e08, #0e0e16);
    border: 1px solid rgba(232,135,74,0.25);
    border-radius: 12px; padding: 10px 12px;
    display: none; align-items: center; gap: 10px;
    animation: nudge-in 0.4s cubic-bezier(0.34,1.56,0.64,1) both;
    cursor: pointer;
  }
  .nudge-card.visible { display: flex; }
  @keyframes nudge-in {
    from { opacity: 0; transform: translateY(-6px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  .nudge-av {
    width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 600; position: relative;
  }
  .nudge-heart {
    position: absolute; top: -4px; right: -4px; font-size: 12px;
    animation: heart-beat 1.2s ease-in-out infinite;
  }
  @keyframes heart-beat {
    0%,100% { transform: scale(1); }
    30%      { transform: scale(1.35); }
    60%      { transform: scale(1.1); }
  }
  .nudge-text { flex: 1; min-width: 0; }
  .nudge-name { font-size: 12px; font-weight: 600; color: var(--text-primary); }
  .nudge-sub  { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
  .nudge-close {
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 13px; padding: 2px; pointer-events: all;
  }

  /* ══════════════════════════════════════════
     UPGRADE SIDEBAR 8 — WELCOME SCREEN ANIMADA
  ══════════════════════════════════════════ */
  .welcome-screen {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative; z-index: 1; gap: 0;
    overflow: hidden;
  }
  .welcome-sbot {
    position: relative; margin-bottom: 24px;
    animation: sbot-float 3s ease-in-out infinite;
  }
  @keyframes sbot-float {
    0%,100% { transform: translateY(0); }
    50%      { transform: translateY(-10px); }
  }
  .welcome-sbot svg { width: 100px; height: 100px; }
  .welcome-glow {
    position: absolute; inset: -20px; border-radius: 50%;
    background: radial-gradient(circle, rgba(232,135,74,0.15) 0%, transparent 70%);
    animation: glow-pulse 3s ease-in-out infinite;
  }
  @keyframes glow-pulse {
    0%,100% { transform: scale(1); opacity: 0.6; }
    50%      { transform: scale(1.2); opacity: 1; }
  }
  .welcome-title {
    font-size: 20px; font-weight: 700;
    background: linear-gradient(135deg, var(--text-primary), var(--orange-soft));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text; margin-bottom: 8px;
  }
  .welcome-frase {
    font-size: 13px; color: var(--text-muted); text-align: center;
    line-height: 1.6; max-width: 280px; min-height: 40px;
    transition: opacity 0.4s ease;
  }
  .welcome-atalhos {
    display: flex; gap: 8px; margin-top: 24px; flex-wrap: wrap; justify-content: center;
  }
  .welcome-btn {
    display: flex; align-items: center; gap: 6px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 14px; cursor: pointer;
    font-family: 'Sora', sans-serif; font-size: 12px; color: var(--text-secondary);
    transition: all 0.2s;
  }
  .welcome-btn:hover { border-color: var(--orange-soft); color: var(--text-primary); transform: translateY(-2px); }
  .welcome-btn .wb-icon { font-size: 14px; }
  .welcome-particles { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
  .wp { position: absolute; border-radius: 50%; background: var(--orange-soft); opacity: 0;
    animation: wp-float var(--dur,6s) var(--delay,0s) ease-in-out infinite; }
  @keyframes wp-float {
    0%   { opacity: 0; transform: translateY(100%) scale(0); }
    20%  { opacity: 0.15; }
    80%  { opacity: 0.08; }
    100% { opacity: 0; transform: translateY(-20%) scale(1.5); }
  }


  .chat-content { display: none; flex-direction: column; height: 100%; }
  .chat-content.visible { display: flex; }
  .welcome-screen.hidden { display: none; }

  .status-bar {
    position: fixed; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, transparent, var(--orange-soft), transparent);
    opacity: 0.3; z-index: 100;
  }

  .back-btn {
    display: none !important; width: 32px; height: 32px; border-radius: 9px;
    background: transparent; border: 1px solid var(--border);
    align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-muted); margin-right: 2px;
  }
  .back-btn svg { width: 15px; height: 15px; stroke: currentColor; fill: none; }

  /* ===================== RESPONSIVO ===================== */
  @media (max-width: 700px) {
    .sidebar {
      width: 100%; position: absolute;
      left: 0; top: 0; bottom: 0; z-index: 10;
      transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
    }
    .sidebar.hidden { transform: translateX(-100%); }
    .chat-area { width: 100%; }
    .back-btn { display: flex !important; }
    .msg { max-width: 80%; }
    .emoji-picker { left: 10px; right: 10px; width: auto; }
  }

  /* ===================== LAYOUT TABLET / IPAD ===================== */
  @media (min-width: 701px) and (max-width: 1024px) {
    :root { --sidebar-w: 280px; }
    .sidebar { width: var(--sidebar-w); }
    .contact-name { font-size: 13px; }
    .contact-preview { font-size: 11px; }
    .sidebar-search input { font-size: 13px; }
    .msg { max-width: 75%; }
    .chat-input-bar { padding: 10px 14px; }
    /* Call window menor no tablet */
    .call-window { width: 240px; bottom: 16px; right: 16px; }
    /* Emoji picker centralizado */
    .emoji-picker { right: 14px; }
    /* Sidebar mini-mode ao inclinar */
    .sidebar-mini-label { display: block; }
  }

  /* iPad landscape — sidebar colapsável */
  @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
    :root { --sidebar-w: 300px; }
  }

  /* ===================== PUSH NOTIFICATIONS ===================== */
  .push-notif-container {
    position: fixed; top: 16px; right: 16px;
    display: flex; flex-direction: column; gap: 10px;
    z-index: 9000; pointer-events: none;
    max-width: 340px;
  }
  .push-notif {
    background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 14px 16px;
    display: flex; align-items: flex-start; gap: 12px;
    box-shadow: 0 16px 50px #00000070, 0 0 0 1px #e8874a10;
    pointer-events: all; cursor: pointer;
    transform: translateX(120%) scale(0.95);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.16,1,0.3,1), opacity 0.3s ease;
    position: relative; overflow: hidden;
  }
  .push-notif::before {
    content: '';
    position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
    background: var(--orange-soft);
    border-radius: 3px 0 0 3px;
  }
  .push-notif.in  { transform: translateX(0) scale(1); opacity: 1; }
  .push-notif.out { transform: translateX(120%) scale(0.95); opacity: 0; }

  .push-notif-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px; font-weight: 700; flex-shrink: 0;
    border: 2px solid transparent;
  }
  .push-notif-body { flex: 1; min-width: 0; }
  .push-notif-header {
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    margin-bottom: 3px;
  }
  .push-notif-sender { font-size: 13px; font-weight: 600; color: var(--text-primary); }
  .push-notif-time   { font-size: 10px; color: var(--text-muted); flex-shrink: 0; font-family: 'Space Mono', monospace; }
  .push-notif-app    { font-size: 10px; color: var(--orange-soft); opacity: 0.8; font-weight: 500; }
  .push-notif-text   { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .push-notif-actions {
    display: flex; gap: 8px; margin-top: 9px;
  }
  .push-notif-btn {
    flex: 1; padding: 7px 12px; border-radius: 10px;
    font-size: 12px; font-weight: 600; cursor: pointer;
    border: 1px solid var(--border); background: var(--bg-card);
    color: var(--text-secondary); font-family: 'Sora', sans-serif;
    transition: background 0.15s, color 0.15s;
  }
  .push-notif-btn:hover { background: var(--border); }
  .push-notif-btn.primary {
    background: var(--orange-soft); border-color: transparent; color: white;
  }
  .push-notif-btn.primary:hover { background: #d07040; }
  .push-notif-dismiss {
    position: absolute; top: 10px; right: 12px;
    width: 18px; height: 18px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; color: var(--text-muted); cursor: pointer;
    background: transparent; border: none;
    transition: background 0.15s;
  }
  .push-notif-dismiss:hover { background: var(--bg-card); color: var(--text-primary); }
  .push-notif-progress {
    position: absolute; bottom: 0; left: 0;
    height: 2px; background: var(--orange-soft); opacity: 0.4;
    border-radius: 0 0 2px 2px;
    animation: push-progress 6s linear forwards;
  }
  @keyframes push-progress {
    from { width: 100%; }
    to   { width: 0%; }
  }

  /* ===================== VIDEO CALL EXPANDIDO ===================== */
  .video-call-overlay {
    position: fixed; inset: 0;
    background: #000;
    z-index: 1000;
    display: none; flex-direction: column;
    animation: video-fade-in 0.4s cubic-bezier(0.16,1,0.3,1) both;
  }
  .video-call-overlay.visible { display: flex; }
  @keyframes video-fade-in {
    from { opacity: 0; transform: scale(1.02); }
    to   { opacity: 1; transform: scale(1); }
  }

  .video-main {
    flex: 1; position: relative; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    background: #0a0a0a;
  }

  /* "câmera" simulada com canvas animado */
  .video-cam-canvas {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
  }
  .video-overlay-gradient {
    position: absolute; inset: 0;
    background:
      linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 25%, transparent 65%, rgba(0,0,0,0.75) 100%);
    z-index: 1;
  }

  /* Avatar grande no centro quando cam desligada */
  .video-remote-avatar {
    width: 110px; height: 110px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 38px; font-weight: 700;
    border: 3px solid rgba(232,135,74,0.4);
    box-shadow: 0 0 40px rgba(232,135,74,0.2), 0 0 80px rgba(232,135,74,0.08);
    z-index: 2; position: relative;
    animation: avatar-breathe 3s ease-in-out infinite;
  }
  @keyframes avatar-breathe {
    0%,100% { box-shadow: 0 0 40px rgba(232,135,74,0.2), 0 0 80px rgba(232,135,74,0.08); }
    50%      { box-shadow: 0 0 60px rgba(232,135,74,0.35), 0 0 100px rgba(232,135,74,0.15); }
  }

  /* Pip — câmera própria (canto inferior direito) */
  .video-pip {
    position: absolute; bottom: 90px; right: 20px;
    width: 110px; height: 150px; border-radius: 16px;
    overflow: hidden; z-index: 3;
    border: 2px solid rgba(255,255,255,0.15);
    box-shadow: 0 8px 30px #00000070;
    cursor: move;
    transition: transform 0.15s;
  }
  .video-pip:hover { transform: scale(1.04); }
  .video-pip canvas { width: 100%; height: 100%; display: block; }
  .video-pip-label {
    position: absolute; bottom: 6px; left: 50%;
    transform: translateX(-50%);
    font-size: 9px; color: rgba(255,255,255,0.7);
    background: rgba(0,0,0,0.5); padding: 2px 8px;
    border-radius: 6px; white-space: nowrap;
  }

  /* Topbar da chamada de vídeo */
  .video-topbar {
    position: absolute; top: 0; left: 0; right: 0;
    padding: 20px 24px 16px;
    display: flex; align-items: center; gap: 14px;
    z-index: 4;
  }
  .video-contact-name {
    font-size: 17px; font-weight: 600; color: white; flex: 1;
  }
  .video-call-status {
    font-size: 13px; color: rgba(255,255,255,0.6);
  }
  .video-timer-top {
    font-family: 'Space Mono', monospace;
    font-size: 13px; font-weight: 700; color: white;
  }

  /* Barra de controles */
  .video-controls {
    position: absolute; bottom: 0; left: 0; right: 0;
    padding: 20px 24px 36px;
    display: flex; align-items: center; justify-content: center; gap: 16px;
    z-index: 4;
  }
  .video-ctrl-btn {
    width: 56px; height: 56px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: none; cursor: pointer;
    transition: transform 0.15s, box-shadow 0.2s, background 0.2s;
    flex-shrink: 0;
  }
  .video-ctrl-btn:hover { transform: scale(1.1); }
  .video-ctrl-btn:active { transform: scale(0.94); }
  .video-ctrl-btn svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 1.8; }
  .video-ctrl-btn.toggled { background: rgba(255,255,255,0.9) !important; }
  .video-ctrl-btn.toggled svg { stroke: #000; }

  .vcb-mute    { background: rgba(255,255,255,0.15); color: white; }
  .vcb-cam     { background: rgba(255,255,255,0.15); color: white; }
  .vcb-flip    { background: rgba(255,255,255,0.15); color: white; }
  .vcb-speaker { background: rgba(255,255,255,0.15); color: white; }
  .vcb-end     { background: #e05050; color: white; width: 64px; height: 64px;
                  box-shadow: 0 8px 28px rgba(224,80,80,0.5); }
  .vcb-end svg { width: 22px; height: 22px; }

  /* Rótulos dos botões */
  .video-ctrl-group {
    display: flex; flex-direction: column; align-items: center; gap: 8px;
  }
  .vcb-label {
    font-size: 10px; color: rgba(255,255,255,0.6);
  }

  /* TEMA CLARO */
  html.light body {
    --bg-deep: #f0ece6;
    --bg-panel: #ffffff;
    --bg-card: #f5f1eb;
    --bg-input: #ede9e3;
    --text-primary: #1a1410;
    --text-secondary: #6a6058;
    --text-muted: #a09888;
    --border: #ddd8d0;
    --bg-msg-out: #fde8d8;
    --bg-msg-in: #f0ece6;
  }
  body.light {
    --bg-deep: #f0ece6;
    --bg-panel: #ffffff;
    --bg-card: #f5f1eb;
    --bg-input: #ede9e3;
    --text-primary: #1a1410;
    --text-secondary: #6a6058;
    --text-muted: #a09888;
    --border: #ddd8d0;
    --bg-msg-out: #fde8d8;
    --bg-msg-in: #f5f1eb;
  }
  body.light::before { opacity: 0; }
  body { transition: background 0.3s, color 0.3s; }


  /* ===================== PAINEL LATERAL DE FEATURES ===================== */
  .features-overlay {
    position: fixed; inset: 0; background: #00000060;
    z-index: 80; opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }
  .features-overlay.open { opacity: 1; pointer-events: all; }

  .features-panel {
    position: fixed; top: 0; right: 0; bottom: 0;
    width: 320px; max-width: 90vw;
    background: var(--bg-panel);
    border-left: 1px solid var(--border);
    z-index: 90;
    display: flex; flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    box-shadow: -12px 0 40px #00000050;
  }
  .features-panel.open { transform: translateX(0); }

  .fp-header {
    padding: 16px 18px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
    background: var(--bg-card);
  }
  .fp-header-avatar {
    width: 42px; height: 42px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px; font-weight: 600; border: 1px solid var(--border);
    flex-shrink: 0;
  }
  .fp-header-info { flex: 1; }
  .fp-header-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
  .fp-header-sub { font-size: 11px; color: var(--text-muted); }
  .fp-close {
    width: 32px; height: 32px; border-radius: 9px;
    background: transparent; border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-muted);
    transition: background 0.2s, color 0.2s; flex-shrink: 0;
  }
  .fp-close:hover { background: var(--bg-input); color: var(--text-secondary); }
  .fp-close svg { width: 14px; height: 14px; stroke: currentColor; fill: none; }

  .fp-body { flex: 1; overflow-y: auto; padding: 14px 14px 24px; }
  .fp-body::-webkit-scrollbar { width: 3px; }
  .fp-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Seções do painel */
  .fp-section { margin-bottom: 10px; }
  .fp-section-title {
    font-size: 10px; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 1px;
    padding: 0 6px; margin-bottom: 6px;
  }
  .fp-section-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 14px; overflow: hidden;
  }

  /* Item do painel */
  .fp-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 14px; border-bottom: 1px solid var(--border);
    transition: background 0.15s; cursor: default;
  }
  .fp-item:last-child { border-bottom: none; }
  .fp-item.clickable { cursor: pointer; }
  .fp-item.clickable:hover { background: var(--bg-input); }

  .fp-item-icon {
    width: 34px; height: 34px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; font-size: 16px;
  }

  .fp-item-info { flex: 1; min-width: 0; }
  .fp-item-label { font-size: 13px; color: var(--text-primary); font-weight: 500; margin-bottom: 1px; }
  .fp-item-desc  { font-size: 11px; color: var(--text-muted); line-height: 1.4; }

  /* Toggle no painel */
  .fp-toggle {
    width: 40px; height: 24px; border-radius: 12px;
    background: var(--bg-input); border: 1px solid var(--border);
    position: relative; cursor: pointer; flex-shrink: 0;
    transition: background 0.3s, border-color 0.3s;
  }
  .fp-toggle.on { background: var(--orange-soft); border-color: var(--orange-soft); }
  .fp-toggle-thumb {
    width: 18px; height: 18px; border-radius: 50%;
    background: var(--text-muted); position: absolute;
    top: 2px; left: 2px; transition: transform 0.25s, background 0.25s;
  }
  .fp-toggle.on .fp-toggle-thumb { transform: translateX(16px); background: white; }
  .fp-toggle.ghost-on { background: #8a4ac0; border-color: #8a4ac0; }

  /* Seletor de tema no painel */
  .fp-tema-grid {
    display: flex; gap: 8px; padding: 12px 14px;
    flex-wrap: wrap;
  }
  .fp-tema-opt {
    width: 34px; height: 34px; border-radius: 50%;
    cursor: pointer; border: 2px solid transparent;
    transition: transform 0.15s, border-color 0.15s;
    position: relative; flex-shrink: 0;
  }
  .fp-tema-opt:hover { transform: scale(1.12); }
  .fp-tema-opt.selected { border-color: white; }
  .fp-tema-opt.selected::after {
    content: '✓'; position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; color: white; font-weight: 700;
  }

  /* Timer selector no painel */
  .fp-timer-grid {
    display: flex; flex-wrap: wrap; gap: 6px;
    padding: 10px 14px 14px;
  }
  .fp-timer-opt {
    padding: 5px 12px; border-radius: 20px;
    border: 1px solid var(--border); background: transparent;
    color: var(--text-muted); font-family: 'Sora', sans-serif;
    font-size: 12px; cursor: pointer; transition: all 0.15s;
  }
  .fp-timer-opt:hover { border-color: var(--orange-soft); color: var(--orange-soft); background: var(--orange-dim); }
  .fp-timer-opt.selected { border-color: var(--orange-soft); color: var(--orange-soft); background: var(--orange-dim); }
  .fp-timer-off {
    padding: 5px 12px; border-radius: 20px;
    border: 1px solid var(--border); background: transparent;
    color: var(--text-muted); font-family: 'Sora', sans-serif;
    font-size: 12px; cursor: pointer; transition: all 0.15s;
  }
  .fp-timer-off:hover { border-color: #c05050; color: #c05050; }

  /* Forms dentro do painel */
  .fp-form { padding: 0 14px 14px; }
  .fp-input {
    width: 100%; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 9px 12px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 13px;
    resize: none; outline: none; margin-bottom: 8px;
    transition: border-color 0.2s;
  }
  .fp-input:focus { border-color: var(--orange-soft); }
  .fp-input-row { display: flex; gap: 8px; margin-bottom: 8px; }
  .fp-btn {
    width: 100%; padding: 10px; border-radius: 10px;
    border: none; color: white; font-family: 'Sora', sans-serif;
    font-size: 13px; font-weight: 600; cursor: pointer;
    transition: transform 0.15s, opacity 0.15s;
  }
  .fp-btn:hover { opacity: 0.88; transform: scale(1.01); }
  .fp-btn-purple { background: linear-gradient(135deg, #8a4ac0, #6030a0); }
  .fp-btn-blue   { background: linear-gradient(135deg, #4a80c0, #2a5090); }
  .fp-btn-green  { background: linear-gradient(135deg, #4a9e6a, #2d7a50); }

  .fp-enquete-opcoes { display: flex; flex-direction: column; gap: 5px; margin-bottom: 8px; }
  .fp-enquete-add {
    width: 100%; padding: 7px; border-radius: 8px;
    border: 1px dashed var(--border); background: transparent;
    color: var(--text-muted); font-family: 'Sora', sans-serif;
    font-size: 12px; cursor: pointer; margin-bottom: 8px;
    transition: border-color 0.2s, color 0.2s;
  }
  .fp-enquete-add:hover { border-color: #4a80c0; color: #6aa0e0; }

  /* Indicador ativo no botão ⋮ */
  .chat-header-actions .icon-btn.has-active {
    border-color: var(--orange-soft);
    background: var(--orange-dim);
    color: var(--orange-soft);
  }
  .chat-header-actions .icon-btn.has-active svg circle,
  .chat-header-actions .icon-btn.has-active svg line { fill: var(--orange-soft) !important; }


  /* ===================== DIFERENCIAIS ===================== */


  /* ---- MODO FANTASMA — banner topo chat ---- */
  .ghost-banner {
    display: none; align-items: center; gap: 8px;
    padding: 8px 18px; background: #12082088;
    border-bottom: 1px solid #6030a040;
    position: relative; z-index: 2;
    animation: slide-down 0.2s ease;
  }
  .ghost-banner.visible { display: flex; }
  @keyframes slide-down {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .ghost-banner-icon { font-size: 16px; }
  .ghost-banner-text { font-size: 12px; color: #a06ae0; flex: 1; }
  .ghost-banner-close {
    background: transparent; border: none; color: #6030a0;
    cursor: pointer; font-size: 14px; padding: 2px 6px; border-radius: 6px;
  }
  .ghost-banner-close:hover { background: #6030a020; }

  /* ---- TIMER DE MENSAGENS — badge na mensagem ---- */
  .msg-timer-badge {
    display: inline-flex; align-items: center; gap: 3px;
    font-size: 10px; color: #e8874a; background: #e8874a12;
    border: 1px solid #e8874a30; border-radius: 8px;
    padding: 1px 6px; margin-top: 3px;
  }
  .msg-timer-badge svg { width: 10px; height: 10px; stroke: #e8874a; fill: none; }
  .msg-timer-badge.expiring { color: #c05050; background: #c0505012; border-color: #c0505030; animation: timer-pulse 1s infinite; }
  @keyframes timer-pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

  /* ---- ASSISTENTE S ---- */
  .assistente-badge {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 10px; color: var(--orange-soft);
    background: var(--orange-dim); border: 1px solid #e8874a30;
    border-radius: 8px; padding: 2px 7px; margin-bottom: 4px;
  }
  .assistente-badge svg { width: 10px; height: 10px; stroke: var(--orange-soft); fill: none; }

  .msg-bubble.assistente {
    background: linear-gradient(135deg, #1a0d05, #120808) !important;
    border-color: #e8874a20 !important;
  }

  /* IA typing */
  .ia-typing { display: flex; align-items: center; gap: 6px; padding: 8px 12px; }
  .ia-typing-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--orange-soft); animation: ia-bounce 1s infinite; }
  .ia-typing-dot:nth-child(2) { animation-delay: 0.15s; }
  .ia-typing-dot:nth-child(3) { animation-delay: 0.3s; }
  @keyframes ia-bounce { 0%,60%,100%{transform:translateY(0);opacity:0.4} 30%{transform:translateY(-5px);opacity:1} }

  /* Chat IA header especial */
  .chat-area.assistente-mode .chat-header { background: linear-gradient(90deg, var(--bg-panel), #1a0a0280); border-bottom-color: #e8874a20; }

  /* ---- REPLY DE MENSAGEM ---- */
  .reply-preview {
    margin: 0 18px 8px; padding: 8px 12px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-left: 3px solid var(--orange-soft); border-radius: 8px;
    display: none; position: relative; z-index: 2;
    animation: slide-down 0.15s ease both;
  }
  .reply-preview.visible { display: flex; align-items: center; gap: 10px; }
  .reply-preview-text { flex: 1; min-width: 0; }
  .reply-preview-author { font-size: 11px; color: var(--orange-soft); font-weight: 600; margin-bottom: 2px; }
  .reply-preview-content { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .reply-preview-close { width: 20px; height: 20px; border-radius: 50%; background: var(--bg-input); border: none; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
  .reply-preview-close:hover { background: #3a1010; color: #c05050; }

  /* Bolha com reply */
  .msg-reply-ref {
    background: var(--bg-deep); border: 1px solid var(--border);
    border-left: 3px solid var(--orange-soft); border-radius: 6px;
    padding: 5px 10px; margin-bottom: 6px; font-size: 12px;
    cursor: pointer; transition: background 0.15s;
  }
  .msg-reply-ref:hover { background: var(--bg-input); }
  .msg-reply-ref-author { color: var(--orange-soft); font-weight: 600; font-size: 11px; margin-bottom: 1px; }
  .msg-reply-ref-text { color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* ---- MENSAGENS FIXADAS ---- */
  .pinned-banner {
    padding: 8px 18px; background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    display: none; align-items: center; gap: 10px;
    cursor: pointer; transition: background 0.15s;
    position: relative; z-index: 2;
  }
  .pinned-banner:hover { background: var(--bg-input); }
  .pinned-banner.visible { display: flex; }
  .pinned-icon { font-size: 14px; flex-shrink: 0; }
  .pinned-text { flex: 1; min-width: 0; }
  .pinned-label { font-size: 10px; color: var(--orange-soft); font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 1px; }
  .pinned-content { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .pinned-count { font-size: 10px; color: var(--text-muted); flex-shrink: 0; }

  /* Msg fixada highlight */
  .msg-bubble.pinned { border-color: var(--orange-soft) !important; box-shadow: 0 0 0 1px #e8874a20; }
  .msg-pinned-badge { font-size: 10px; color: var(--orange-soft); margin-top: 3px; display: flex; align-items: center; gap: 3px; }


  /* ---- TEMA POR CONVERSA ---- */
  .chat-area[data-tema="verde"] { --bg-msg-out: #0d1f0d; --chat-accent: #4a9e6a; }
  .chat-area[data-tema="azul"]  { --bg-msg-out: #0d1220; --chat-accent: #4a80c0; }
  .chat-area[data-tema="rosa"]  { --bg-msg-out: #1f0d14; --chat-accent: #c04a8a; }
  .chat-area[data-tema="roxo"] { --bg-msg-out: #130d1f; --chat-accent: #8a4ac0; }
  .chat-area[data-tema="laranja"] { --bg-msg-out: #2a1a0e; --chat-accent: #e8874a; }
  .chat-area[data-tema]:not([data-tema=""]) .msg.out .msg-bubble { border-color: var(--chat-accent, #3a2010) !important; }
  .chat-area[data-tema]:not([data-tema=""]) .btn-send { background: var(--chat-accent, var(--orange-soft)) !important; }
  .chat-area[data-tema]:not([data-tema=""]) .chat-area::before { opacity: 0.12; }

  /* Strip de cor no topo do chat por tema */
  .tema-strip {
    height: 2px; width: 100%;
    background: var(--chat-accent, transparent);
    position: relative; z-index: 3; transition: background 0.3s;
  }

  /* ---- PAINEL DE TEMA ---- */
  .tema-panel {
    position: absolute; top: 60px; right: 12px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 16px; padding: 14px;
    z-index: 50; display: none; flex-direction: column; gap: 10px;
    box-shadow: 0 12px 40px #00000070;
    animation: picker-in 0.15s ease;
    min-width: 200px;
  }
  .tema-panel.open { display: flex; }
  .tema-panel-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; }
  .tema-opts { display: flex; gap: 8px; flex-wrap: wrap; }
  .tema-opt {
    width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
    border: 2px solid transparent; transition: transform 0.15s, border-color 0.15s;
    position: relative;
  }
  .tema-opt:hover { transform: scale(1.15); }
  .tema-opt.selected { border-color: white; }
  .tema-opt.selected::after {
    content: '✓'; position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; color: white;
  }

  /* ---- CÁPSULA DO TEMPO ---- */
  .capsula-form {
    background: linear-gradient(135deg, #1a0808, #120d18);
    border: 1px solid #8a4ac030; border-radius: 16px;
    padding: 16px; margin: 8px 0; display: none;
    animation: msg-in 0.2s ease both;
    position: relative; z-index: 1;
  }
  .capsula-form.open { display: block; }
  .capsula-form-title {
    font-size: 12px; font-weight: 600; color: #a06ae0;
    display: flex; align-items: center; gap: 6px; margin-bottom: 12px;
  }
  .capsula-form-title svg { width: 14px; height: 14px; stroke: #a06ae0; fill: none; }
  .capsula-input-msg {
    width: 100%; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 12px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 13px;
    resize: none; outline: none; margin-bottom: 10px;
  }
  .capsula-input-msg:focus { border-color: #8a4ac0; }
  .capsula-row { display: flex; gap: 8px; align-items: center; }
  .capsula-date-input {
    flex: 1; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 12px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 12px; outline: none;
    color-scheme: dark;
  }
  .capsula-date-input:focus { border-color: #8a4ac0; }
  .capsula-send-btn {
    padding: 8px 16px; border-radius: 10px;
    background: linear-gradient(135deg, #8a4ac0, #6030a0);
    border: none; color: white; font-family: 'Sora', sans-serif;
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: transform 0.15s; white-space: nowrap;
  }
  .capsula-send-btn:hover { transform: scale(1.03); }

  /* Mensagem tipo cápsula no chat */
  .msg-capsula {
    background: linear-gradient(135deg, #13081a, #0d0810) !important;
    border-color: #8a4ac030 !important;
    position: relative; overflow: hidden;
  }
  .msg-capsula::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, #8a4ac008, transparent);
    pointer-events: none;
  }
  .capsula-header {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: #a06ae0; margin-bottom: 6px;
  }
  .capsula-header svg { width: 12px; height: 12px; stroke: #a06ae0; fill: none; }
  .capsula-unlock-date { font-size: 11px; color: var(--text-muted); margin-top: 6px; }

  /* ---- ENQUETES ---- */
  .enquete-form {
    background: linear-gradient(135deg, #08141a, #0a1018);
    border: 1px solid #4a80c030; border-radius: 16px;
    padding: 16px; margin: 8px 0; display: none;
    animation: msg-in 0.2s ease both; position: relative; z-index: 1;
  }
  .enquete-form.open { display: block; }
  .enquete-form-title {
    font-size: 12px; font-weight: 600; color: #6aa0e0;
    display: flex; align-items: center; gap: 6px; margin-bottom: 12px;
  }
  .enquete-form-title svg { width: 14px; height: 14px; stroke: #6aa0e0; fill: none; }
  .enquete-pergunta-input {
    width: 100%; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 12px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 13px;
    outline: none; margin-bottom: 8px;
  }
  .enquete-pergunta-input:focus { border-color: #4a80c0; }
  .enquete-opcoes { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
  .enquete-opcao-row { display: flex; gap: 6px; align-items: center; }
  .enquete-opcao-input {
    flex: 1; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 8px; padding: 7px 10px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 12px; outline: none;
  }
  .enquete-opcao-input:focus { border-color: #4a80c0; }
  .enquete-add-btn {
    background: transparent; border: 1px dashed var(--border);
    border-radius: 8px; padding: 7px 12px; color: var(--text-muted);
    font-family: 'Sora', sans-serif; font-size: 12px; cursor: pointer;
    width: 100%; transition: border-color 0.2s, color 0.2s; margin-bottom: 10px;
  }
  .enquete-add-btn:hover { border-color: #4a80c0; color: #6aa0e0; }
  .enquete-send-btn {
    padding: 8px 16px; border-radius: 10px;
    background: linear-gradient(135deg, #4a80c0, #2a5090);
    border: none; color: white; font-family: 'Sora', sans-serif;
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: transform 0.15s; float: right;
  }
  .enquete-send-btn:hover { transform: scale(1.03); }

  /* Enquete no chat */
  .msg-enquete {
    background: linear-gradient(135deg, #08121a, #060e14) !important;
    border-color: #4a80c025 !important;
    min-width: 240px;
  }
  .enquete-titulo { font-size: 14px; font-weight: 600; margin-bottom: 10px; }
  .enquete-header-badge {
    display: flex; align-items: center; gap: 5px;
    font-size: 11px; color: #6aa0e0; margin-bottom: 8px;
  }
  .enquete-header-badge svg { width: 12px; height: 12px; stroke: #6aa0e0; fill: none; }
  .enquete-opcao {
    width: 100%; padding: 8px 12px; border-radius: 10px;
    background: var(--bg-input); border: 1px solid var(--border);
    color: var(--text-primary); font-family: 'Sora', sans-serif;
    font-size: 13px; cursor: pointer; text-align: left;
    margin-bottom: 6px; transition: all 0.2s; position: relative;
    overflow: hidden;
  }
  .enquete-opcao:hover { border-color: #4a80c0; background: #08121a; }
  .enquete-opcao.votado { border-color: #4a80c0; background: #08121a; }
  .enquete-barra {
    position: absolute; left: 0; top: 0; bottom: 0;
    background: #4a80c015; transition: width 0.5s cubic-bezier(0.16,1,0.3,1);
    border-radius: 10px;
  }
  .enquete-opcao-texto { position: relative; z-index: 1; display: flex; justify-content: space-between; }
  .enquete-pct { font-size: 11px; color: #6aa0e0; font-weight: 600; }
  .enquete-total { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

  /* Debate na enquete */
  .enquete-debate {
    margin-top: 10px; border-top: 1px solid var(--border);
    padding-top: 8px; display: none;
  }
  .enquete-debate.open { display: block; }
  .enquete-debate-titulo { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
  .enquete-comentario { font-size: 12px; padding: 4px 0; border-bottom: 1px solid var(--border); }
  .enquete-comentario:last-child { border-bottom: none; }
  .enquete-comentario-user { color: var(--orange-soft); font-weight: 600; }
  .enquete-debate-input-row { display: flex; gap: 6px; margin-top: 8px; }
  .enquete-debate-input {
    flex: 1; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 8px; padding: 6px 10px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 12px; outline: none;
  }
  .enquete-debate-send {
    padding: 6px 12px; border-radius: 8px;
    background: #4a80c0; border: none; color: white;
    font-family: 'Sora', sans-serif; font-size: 12px; cursor: pointer;
  }
  .enquete-debate-toggle {
    font-size: 11px; color: #6aa0e0; cursor: pointer;
    background: transparent; border: none; font-family: 'Sora', sans-serif;
    text-decoration: underline; margin-top: 4px;
  }

  /* ---- LEMBRETE ---- */
  .lembrete-form {
    background: linear-gradient(135deg, #0d1408, #0a1208);
    border: 1px solid #4a9e6a30; border-radius: 16px;
    padding: 16px; margin: 8px 0; display: none;
    animation: msg-in 0.2s ease both; position: relative; z-index: 1;
  }
  .lembrete-form.open { display: block; }
  .lembrete-form-title {
    font-size: 12px; font-weight: 600; color: #6abf8a;
    display: flex; align-items: center; gap: 6px; margin-bottom: 12px;
  }
  .lembrete-form-title svg { width: 14px; height: 14px; stroke: #6abf8a; fill: none; }
  .lembrete-msg-input {
    width: 100%; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 12px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 13px;
    resize: none; outline: none; margin-bottom: 10px;
  }
  .lembrete-msg-input:focus { border-color: #4a9e6a; }
  .lembrete-row { display: flex; gap: 8px; align-items: center; }
  .lembrete-date-input {
    flex: 1; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 12px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 12px; outline: none;
    color-scheme: dark;
  }
  .lembrete-date-input:focus { border-color: #4a9e6a; }
  .lembrete-send-btn {
    padding: 8px 16px; border-radius: 10px;
    background: linear-gradient(135deg, #4a9e6a, #2d7a50);
    border: none; color: white; font-family: 'Sora', sans-serif;
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: transform 0.15s; white-space: nowrap;
  }
  .lembrete-send-btn:hover { transform: scale(1.03); }

  /* Mensagem de lembrete no chat */
  .msg-lembrete {
    background: linear-gradient(135deg, #0d1808, #0a1210) !important;
    border-color: #4a9e6a30 !important;
  }
  .lembrete-header {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: #6abf8a; margin-bottom: 6px;
  }
  .lembrete-header svg { width: 12px; height: 12px; stroke: #6abf8a; fill: none; }
  .lembrete-when { font-size: 11px; color: var(--text-muted); margin-top: 6px; }

  /* ===================== ANIMAÇÕES DE TRANSIÇÃO ===================== */
  .sidebar { transition: transform 0.35s cubic-bezier(0.16,1,0.3,1); }
  .chat-content.visible {
    animation: chat-slide-in 0.3s cubic-bezier(0.16,1,0.3,1) both;
  }
  @keyframes chat-slide-in {
    from { opacity: 0; transform: translateX(18px); }
    to   { opacity: 1; transform: translateX(0); }
  }
  .contact-item:active { transform: scale(0.98); }
  .msg.out { animation: msg-in-out 0.22s cubic-bezier(0.16,1,0.3,1) both; }
  @keyframes msg-in-out {
    from { opacity: 0; transform: translateX(12px) translateY(4px); }
    to   { opacity: 1; transform: translateX(0) translateY(0); }
  }

  /* ===================== REAÇÃO BOTÃO FIXO ===================== */
  .msg-wrapper { position: relative; display: flex; align-items: center; gap: 6px; }
  .msg.in .msg-wrapper { flex-direction: row; }
  .msg.out .msg-wrapper { flex-direction: row-reverse; }

  .reaction-btn-fixed {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--bg-card); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 14px; flex-shrink: 0;
    opacity: 0; transition: opacity 0.15s, transform 0.15s, background 0.15s;
    transform: scale(0.8);
    box-shadow: 0 2px 8px #00000030;
  }
  .msg:hover .reaction-btn-fixed {
    opacity: 1; transform: scale(1);
  }
  .reaction-btn-fixed:hover {
    background: var(--bg-input); transform: scale(1.18) !important;
  }

  /* ===================== JANELA DE CHAMADA FLUTUANTE ===================== */
  .call-window {
    position: fixed; bottom: 24px; right: 24px;
    width: 280px; background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: 20px;
    box-shadow: 0 20px 60px #00000070, 0 0 0 1px #e8874a15;
    z-index: 999;
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: call-slide-in 0.4s cubic-bezier(0.16,1,0.3,1) both;
  }
  .call-window.visible { display: flex; }
  @keyframes call-slide-in {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  .call-header {
    padding: 12px 14px 10px;
    background: linear-gradient(135deg, #1a0a05, #120808);
    display: flex; align-items: center; gap: 10px;
    border-bottom: 1px solid #e8874a15;
  }

  .call-avatar {
    width: 38px; height: 38px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 600; flex-shrink: 0;
    border: 2px solid #e8874a40;
    box-shadow: 0 0 14px #e8874a20;
  }

  .call-info { flex: 1; min-width: 0; }
  .call-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .call-status { font-size: 11px; color: var(--orange-soft); display: flex; align-items: center; gap: 4px; }
  .call-pulse { width: 6px; height: 6px; border-radius: 50%; background: var(--orange-soft); animation: pulse-call 1.5s infinite; }
  @keyframes pulse-call { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }

  .call-timer {
    font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700;
    color: var(--text-secondary); flex-shrink: 0;
  }

  .call-window-controls {
    display: flex; gap: 4px; flex-shrink: 0; margin-left: 4px;
  }
  .call-wc-btn {
    width: 22px; height: 22px; border-radius: 50%;
    border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 10px; transition: opacity 0.15s;
  }
  .call-wc-btn:hover { opacity: 0.8; }
  .call-wc-min { background: #c09030; color: #000; font-size: 14px; font-weight: 700; }
  .call-wc-close { background: #c05050; color: #fff; font-size: 14px; font-weight: 700; }

  .call-body {
    padding: 16px 14px 14px;
    display: flex; flex-direction: column; align-items: center; gap: 14px;
  }

  .call-wave {
    display: flex; align-items: center; gap: 3px; height: 36px;
  }
  .call-wave-bar {
    width: 4px; border-radius: 3px;
    background: var(--orange-soft);
    animation: call-wave-anim 1s infinite;
    opacity: 0.7;
  }
  .call-wave-bar:nth-child(1) { animation-delay: 0s; }
  .call-wave-bar:nth-child(2) { animation-delay: 0.1s; }
  .call-wave-bar:nth-child(3) { animation-delay: 0.2s; }
  .call-wave-bar:nth-child(4) { animation-delay: 0.15s; }
  .call-wave-bar:nth-child(5) { animation-delay: 0.05s; }
  .call-wave-bar:nth-child(6) { animation-delay: 0.25s; }
  .call-wave-bar:nth-child(7) { animation-delay: 0.1s; }
  .call-wave-bar:nth-child(8) { animation-delay: 0.3s; }
  .call-wave-bar.muted { background: var(--text-muted); animation: none; height: 4px !important; }
  @keyframes call-wave-anim {
    0%,100% { height: 6px; } 50% { height: 30px; }
  }

  .call-actions {
    display: flex; gap: 10px; align-items: center; justify-content: center;
  }

  .call-action-btn {
    width: 44px; height: 44px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: none; cursor: pointer; font-size: 16px;
    transition: transform 0.15s, box-shadow 0.15s;
    flex-shrink: 0;
  }
  .call-action-btn:hover { transform: scale(1.08); }
  .call-action-btn:active { transform: scale(0.95); }
  .call-action-btn svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 1.8; }

  .call-btn-mute   { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); }
  .call-btn-mute.active { background: #3a1010; border-color: #c05050; color: #e05050; }
  .call-btn-speaker { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); }
  .call-btn-speaker.active { background: var(--orange-dim); border-color: var(--orange-soft); color: var(--orange-soft); }
  .call-btn-video  { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); }
  .call-btn-video.active { background: #0a1220; border-color: #4a80c0; color: #4a80c0; }
  .call-btn-end    { background: #c05050; color: white; box-shadow: 0 4px 16px #c0505040; }

  /* Notificação de chamada recebida */
  .call-incoming {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-120px);
    background: var(--bg-panel); border: 1px solid var(--border);
    border-radius: 20px; padding: 16px 20px;
    display: flex; align-items: center; gap: 14px;
    box-shadow: 0 16px 50px #00000080;
    z-index: 9999; min-width: 300px; max-width: 380px;
    transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
  }
  .call-incoming.show { transform: translateX(-50%) translateY(0); }

  .call-incoming-avatar {
    width: 50px; height: 50px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px; font-weight: 600; flex-shrink: 0;
    border: 2px solid var(--border);
    animation: avatar-ring 1s ease infinite;
  }
  @keyframes avatar-ring {
    0%,100% { box-shadow: 0 0 0 0 #e8874a40; }
    50%      { box-shadow: 0 0 0 8px #e8874a00; }
  }

  .call-incoming-info { flex: 1; }
  .call-incoming-label { font-size: 11px; color: var(--orange-soft); text-transform: uppercase; letter-spacing: 0.6px; font-weight: 600; margin-bottom: 2px; }
  .call-incoming-name { font-size: 15px; font-weight: 600; margin-bottom: 1px; }
  .call-incoming-type { font-size: 12px; color: var(--text-muted); }

  .call-incoming-actions { display: flex; gap: 8px; flex-shrink: 0; }
  .call-reject { width: 44px; height: 44px; border-radius: 50%; background: #c05050; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 14px #c0505040; transition: transform 0.15s; }
  .call-reject:hover { transform: scale(1.08); }
  .call-reject svg { width: 18px; height: 18px; stroke: white; fill: none; stroke-width: 2; }
  .call-accept { width: 44px; height: 44px; border-radius: 50%; background: #4a9e6a; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 14px #4a9e6a40; transition: transform 0.15s; }
  .call-accept:hover { transform: scale(1.08); }
  .call-accept svg { width: 18px; height: 18px; stroke: white; fill: none; stroke-width: 2; }

  /* ---- NOTIFICAÇÃO DE LEMBRETE ---- */
  .lembrete-notif {
    position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-80px);
    background: linear-gradient(135deg, #0d1808, #0a1210);
    border: 1px solid #4a9e6a60; border-radius: 16px;
    padding: 14px 20px; z-index: 999;
    box-shadow: 0 12px 40px #00000080, 0 0 0 1px #4a9e6a20;
    display: flex; align-items: center; gap: 12px;
    transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
    max-width: 380px; min-width: 260px;
  }
  .lembrete-notif.show { transform: translateX(-50%) translateY(0); }
  .lembrete-notif-icon { font-size: 22px; flex-shrink: 0; }
  .lembrete-notif-text { flex: 1; }
  .lembrete-notif-title { font-size: 13px; font-weight: 600; color: #6abf8a; margin-bottom: 2px; }
  .lembrete-notif-msg { font-size: 12px; color: var(--text-secondary); }
  .lembrete-notif-close {
    background: transparent; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 16px; padding: 4px;
    border-radius: 6px; flex-shrink: 0;
  }
  .lembrete-notif-close:hover { background: #4a9e6a20; }
</style>
<script>
  // Aplicar tema ANTES de renderizar (evita flash)
  if (localStorage.getItem('schat-tema') !== 'dark')
    document.documentElement.classList.add('light');
</script>
</head>
<body>
<div class="status-bar"></div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-brand">
      <div class="sidebar-logo">
        <svg viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z"/></svg>
      </div>
      <div class="sidebar-brand-wrap">
        <div class="sidebar-brand-name">S<span>-</span>Chat</div>
        <div class="conn-badge" id="connBadge">
          <div class="conn-dot" id="connDot"></div>
          <span id="connLabel">Conectado · v3.0</span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" title="Criar grupo" onclick="window.location.href='schat-criar-grupo.html'">
        <svg viewBox="0 0 24 24" stroke-width="1.8"><path d="M16 21V19C16 16.8 14.2 15 12 15H5C2.8 15 1 16.8 1 19V21" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8.5" cy="8" r="4" stroke-linecap="round" stroke-linejoin="round"/><line x1="20" y1="8" x2="20" y2="14" stroke-linecap="round"/><line x1="17" y1="11" x2="23" y2="11" stroke-linecap="round"/></svg>
      </button>
      <button class="icon-btn" title="Modo Cofre 🔐" onclick="window.location.href='schat-cofre.html'" style="position:relative">
        <svg viewBox="0 0 24 24" stroke-width="1.8"><rect x="3" y="11" width="18" height="11" rx="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 11V7C7 4.24 9.24 2 12 2C14.76 2 17 4.24 17 7V11" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="icon-btn" title="Configurações" onclick="window.location.href='schat-config.html'">
        <svg viewBox="0 0 24 24" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83" stroke-linecap="round"/></svg>
      </button>
    </div>
  </div>

  <div class="search-wrap">
    <div class="search-inner">
      <svg viewBox="0 0 24 24" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke-linecap="round"/></svg>
      <input type="text" placeholder="Buscar conversa..." oninput="filtrarContatos(this.value)">
    </div>
  </div>

  <!-- ── MINI DASHBOARD ── -->
  <div class="dash-bar" onclick="toggleDash()">
    <div class="dash-toggle">
      <div class="dash-toggle-label">Resumo do dia</div>
      <div class="dash-chevron open" id="dashChevron">▼</div>
    </div>
    <div class="dash-grid" id="dashGrid">
      <div class="dash-card">
        <div class="dash-n" id="dashMsgs">24</div>
        <div class="dash-l">Mensagens</div>
      </div>
      <div class="dash-card">
        <div class="dash-n" id="dashOnline">3</div>
        <div class="dash-l">Online</div>
      </div>
      <div class="dash-card">
        <div class="dash-n" id="dashNotif" style="color:#e87070">6</div>
        <div class="dash-l">Não lidos</div>
      </div>
    </div>
  </div>

  <!-- ── STORIES NA SIDEBAR ── -->
  <div class="stories-bar-wrap">
  <div class="stories-bar" id="storiesBar">
    <div class="story-add" onclick="window.location.href='schat-status.html'" title="Adicionar status">+</div>
    <div class="story-thumb" onclick="window.location.href='schat-status.html'">
      <div class="story-ring novo"><div class="story-av c1">AL</div></div>
      <div class="story-name">Ana</div>
    </div>
    <div class="story-thumb" onclick="window.location.href='schat-status.html'">
      <div class="story-ring novo"><div class="story-av c2">CS</div></div>
      <div class="story-name">Carlos</div>
    </div>
    <div class="story-thumb" onclick="window.location.href='schat-status.html'">
      <div class="story-ring visto"><div class="story-av c4">BR</div></div>
      <div class="story-name">Beatriz</div>
    </div>
    <div class="story-thumb" onclick="window.location.href='schat-status.html'">
      <div class="story-ring visto"><div class="story-av c3">DM</div></div>
      <div class="story-name">Diego</div>
    </div>
    <div class="story-thumb" onclick="window.location.href='schat-status.html'">
      <div class="story-ring novo"><div class="story-av c5">FC</div></div>
      <div class="story-name">Fernanda</div>
    </div>
  </div>
  </div><!-- /stories-bar-wrap -->

  <!-- ── TOP 3 FAVORITOS ── -->
  <div class="top3-section">
    <div class="top3-label">Mais conversados</div>
    <div class="top3-row" id="top3Row">
      <div class="top3-item" onclick="document.querySelector('[data-nome=\"Ana Lima\"]').click()">
        <div class="top3-ring">
          <svg viewBox="0 0 46 46"><circle cx="23" cy="23" r="19" stroke="#333" stroke-width="3.5"/><circle cx="23" cy="23" r="19" stroke="#e8874a" stroke-width="3.5" stroke-dasharray="119.4" stroke-dashoffset="12"/></svg>
          <div class="top3-av c1">AL</div>
        </div>
        <div class="top3-name">Ana Lima</div>
        <div class="top3-crown">🥇</div>
      </div>
      <div class="top3-item" onclick="document.querySelector('[data-nome=\"Carlos Souza\"]').click()">
        <div class="top3-ring">
          <svg viewBox="0 0 46 46"><circle cx="23" cy="23" r="19" stroke="#333" stroke-width="3.5"/><circle cx="23" cy="23" r="19" stroke="#4a80c0" stroke-width="3.5" stroke-dasharray="119.4" stroke-dashoffset="30"/></svg>
          <div class="top3-av c2">CS</div>
        </div>
        <div class="top3-name">Carlos</div>
        <div class="top3-crown">🥈</div>
      </div>
      <div class="top3-item" onclick="document.querySelector('[data-nome=\"Beatriz Ramos\"]').click()">
        <div class="top3-ring">
          <svg viewBox="0 0 46 46"><circle cx="23" cy="23" r="19" stroke="#333" stroke-width="3.5"/><circle cx="23" cy="23" r="19" stroke="#c04a8a" stroke-width="3.5" stroke-dasharray="119.4" stroke-dashoffset="55"/></svg>
          <div class="top3-av c4">BR</div>
        </div>
        <div class="top3-name">Beatriz</div>
        <div class="top3-crown">🥉</div>
      </div>
    </div>
  </div>

  <!-- ── FILTROS ── -->
  <div class="filter-chips" id="filterChips">
    <button class="chip active" onclick="filtrarChip(this,'todos')">Todos <span class="chip-badge">6</span></button>
    <button class="chip" onclick="filtrarChip(this,'nao-lidos')">Não lidos <span class="chip-badge">3</span></button>
    <button class="chip" onclick="filtrarChip(this,'online')">Online</button>
    <button class="chip" onclick="filtrarChip(this,'grupos')">Grupos</button>
  </div>

  <!-- ── NUDGE "PENSANDO EM VOCÊ" ── -->
  <div class="nudge-card" id="nudgeCard" onclick="nudgeAbrir()">
    <div class="nudge-av c1" id="nudgeAv">AL<div class="nudge-heart">❤️</div></div>
    <div class="nudge-text">
      <div class="nudge-name" id="nudgeName">Ana Lima</div>
      <div class="nudge-sub" id="nudgeSub">Ativa há 2h — que tal dar um oi? 👋</div>
    </div>
    <button class="nudge-close" onclick="event.stopPropagation();fecharNudge()">✕</button>
  </div>

  <div class="contacts-section" id="contactsList">
    <div class="section-label">Online agora</div>
    <div class="contact-item active" data-nome="Ana Lima" onclick="abrirChat(this,'Ana Lima','online','c1','AL','Oi! Tudo bem? 😊','14:24',2)">
      <div class="avatar"><div class="avatar-img c1">AL</div><div class="status-dot online"></div></div>
      <div class="contact-info">
        <div class="contact-top"><div class="contact-name">Ana Lima</div><div class="contact-time">14:24</div></div>
        <div class="contact-bottom"><div class="contact-preview">Oi! Tudo bem? 😊</div><div class="unread-badge">2</div></div>
      </div>
    </div>
    <div class="contact-item" data-nome="Carlos Souza" onclick="abrirChat(this,'Carlos Souza','online','c2','CS','Você viu o jogo ontem?','13:10',0)">
      <div class="avatar"><div class="avatar-img c2">CS</div><div class="status-dot online"></div></div>
      <div class="contact-info">
        <div class="contact-top"><div class="contact-name">Carlos Souza</div><div class="contact-time">13:10</div></div>
        <div class="contact-bottom"><div class="contact-preview">Você viu o jogo ontem?</div></div>
      </div>
    </div>
    <div class="contact-item" data-nome="Beatriz Ramos" onclick="abrirChat(this,'Beatriz Ramos','away','c4','BR','Ok, te falo mais tarde!','11:45',1)">
      <div class="avatar"><div class="avatar-img c4">BR</div><div class="status-dot away"></div></div>
      <div class="contact-info">
        <div class="contact-top"><div class="contact-name">Beatriz Ramos</div><div class="contact-time">11:45</div></div>
        <div class="contact-bottom"><div class="contact-preview">Ok, te falo mais tarde!</div><div class="unread-badge">1</div></div>
      </div>
    </div>
    <div class="section-label" style="margin-top:6px">Offline</div>
    <div class="contact-item" data-nome="Diego Martins" onclick="abrirChat(this,'Diego Martins','offline','c3','DM','Vlw! Até mais 👋','Ontem',0)">
      <div class="avatar"><div class="avatar-img c3">DM</div><div class="status-dot offline"></div></div>
      <div class="contact-info">
        <div class="contact-top"><div class="contact-name">Diego Martins</div><div class="contact-time">Ontem</div></div>
        <div class="contact-bottom"><div class="contact-preview">Vlw! Até mais 👋</div></div>
      </div>
    </div>
    <div class="contact-item" data-nome="Fernanda Costa" onclick="abrirChat(this,'Fernanda Costa','offline','c5','FC','Vou verificar aqui 🙂','Seg',3)">
      <div class="avatar"><div class="avatar-img c5">FC</div><div class="status-dot offline"></div></div>
      <div class="contact-info">
        <div class="contact-top"><div class="contact-name">Fernanda Costa</div><div class="contact-time">Seg</div></div>
        <div class="contact-bottom"><div class="contact-preview">Vou verificar aqui 🙂</div><div class="unread-badge">3</div></div>
      </div>
    </div>
    <div class="contact-item" data-nome="Gustavo Pereira" onclick="abrirChat(this,'Gustavo Pereira','offline','c2','GP','Combinado então!','Dom',0)">
      <div class="avatar"><div class="avatar-img c2">GP</div><div class="status-dot offline"></div></div>
      <div class="contact-info">
        <div class="contact-top"><div class="contact-name">Gustavo Pereira</div><div class="contact-time">Dom</div></div>
        <div class="contact-bottom"><div class="contact-preview">Combinado então!</div></div>
      </div>
    </div>
    <div class="section-label" style="margin-top:6px">Assistente</div>
    <div class="contact-item" data-nome="Assistente S" data-assistente="1" onclick="abrirChatAssistente(this)" style="background:linear-gradient(90deg,#1a0d0580,transparent)">
      <div class="avatar">
        <div class="avatar-img" style="background:linear-gradient(135deg,#1a0808,#120d05);color:var(--orange-soft);border-color:#e8874a30;font-size:20px">🤖</div>
        <div class="status-dot online" style="background:var(--orange-soft);box-shadow:0 0 6px var(--orange-soft)"></div>
      </div>
      <div class="contact-info">
        <div class="contact-top">
          <div class="contact-name" style="color:var(--orange-soft)">Assistente S <span style="font-size:10px;color:var(--text-muted);font-weight:400">· IA</span></div>
          <div class="contact-time">Agora</div>
        </div>
        <div class="contact-bottom"><div class="contact-preview">Olá! Como posso te ajudar? ✨</div></div>
      </div>
    </div>
  </div>

  <div class="my-profile" style="position:relative">
    <div class="avatar">
      <div class="avatar-img c1" style="width:38px;height:38px;font-size:13px">EU</div>
      <div class="status-dot online" style="width:10px;height:10px;border-color:var(--bg-panel)"></div>
    </div>
    <div class="my-profile-info">
      <div class="my-profile-name" style="display:flex;align-items:center;gap:6px">
        Você
        <span class="mood-badge" id="moodBadge" onclick="toggleMoodSelector()" title="Seu mood de hoje">😎 <span id="moodLabel">Focado</span></span>
        <span class="mood-badge" onclick="window.abrirWrapup && window.abrirWrapup()" title="Wrap-up semanal" style="cursor:pointer">📊</span>
      </div>
      <div class="my-profile-sub" id="ghostStatusLabel">● Online</div>
    </div>
    <button class="icon-btn" title="Meu perfil" style="border:none;background:transparent" onclick="window.location.href='schat-perfil.html'">
      <svg viewBox="0 0 24 24" style="stroke:var(--text-muted);fill:none;width:14px;height:14px" stroke-width="2"><circle cx="12" cy="5" r="1" fill="var(--text-muted)"/><circle cx="12" cy="12" r="1" fill="var(--text-muted)"/><circle cx="12" cy="19" r="1" fill="var(--text-muted)"/></svg>
    </button>
    <!-- Mood Selector -->
    <div class="mood-selector" id="moodSelector">
      <div onclick="setMood('😎','Focado')" class="mood-opt active" data-mood="Focado">😎 <span class="mood-opt-label">Focado</span></div>
      <div onclick="setMood('🔥','Animado')" class="mood-opt" data-mood="Animado">🔥 <span class="mood-opt-label">Animado</span></div>
      <div onclick="setMood('🌙','Com sono')" class="mood-opt" data-mood="Com sono">🌙 <span class="mood-opt-label">Com sono</span></div>
      <div onclick="setMood('💻','Trabalhando')" class="mood-opt" data-mood="Trabalhando">💻 <span class="mood-opt-label">No trampo</span></div>
      <div onclick="setMood('🎮','No game')" class="mood-opt" data-mood="No game">🎮 <span class="mood-opt-label">No game</span></div>
      <div onclick="setMood('🎵','Na música')" class="mood-opt" data-mood="Na música">🎵 <span class="mood-opt-label">Na música</span></div>
      <div onclick="setMood('🏋️','Treinando')" class="mood-opt" data-mood="Treinando">🏋️ <span class="mood-opt-label">Treinando</span></div>
      <div onclick="setMood('😴','Offline')" class="mood-opt" data-mood="Offline">😴 <span class="mood-opt-label">Offline</span></div>
    </div>
  </div>
</div>

<!-- ÁREA DE CHAT -->
<div class="chat-area">

  <div class="welcome-screen" id="welcome">
    <!-- Partículas flutuantes -->
    <div class="welcome-particles" id="welcomeParticles"></div>

    <!-- S-Bot animado -->
    <div class="welcome-sbot">
      <div class="welcome-glow"></div>
      <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
        <!-- Corpo -->
        <circle cx="60" cy="65" r="38" fill="#e8874a"/>
        <!-- Olhos -->
        <circle cx="47" cy="58" r="7" fill="#1a0e08"/>
        <circle cx="73" cy="58" r="7" fill="#1a0e08"/>
        <!-- Brilho olhos -->
        <circle cx="50" cy="55" r="2.5" fill="white"/>
        <circle cx="76" cy="55" r="2.5" fill="white"/>
        <!-- Sorriso -->
        <path d="M44 72 Q60 84 76 72" stroke="#1a0e08" stroke-width="3.5" fill="none" stroke-linecap="round"/>
        <!-- Orelhas/Antenas -->
        <circle cx="60" cy="24" r="5" fill="#c05820"/>
        <line x1="60" y1="27" x2="60" y2="38" stroke="#c05820" stroke-width="3" stroke-linecap="round"/>
        <!-- Bochecha -->
        <circle cx="35" cy="68" r="6" fill="#c05820" opacity="0.5"/>
        <circle cx="85" cy="68" r="6" fill="#c05820" opacity="0.5"/>
        <!-- Halo laranja -->
        <circle cx="60" cy="60" r="50" fill="none" stroke="#e8874a" stroke-width="1" opacity="0.15"/>
      </svg>
    </div>

    <div class="welcome-title">Olá! Bem-vindo ao S-Chat</div>
    <div class="welcome-frase" id="welcomeFrase">Selecione uma conversa para começar ✨</div>

    <!-- Atalhos rápidos -->
    <div class="welcome-atalhos">
      <button class="welcome-btn" onclick="window.location.href='schat-criar-grupo.html'">
        <span class="wb-icon">👥</span> Criar grupo
      </button>
      <button class="welcome-btn" onclick="window.location.href='schat-status.html'">
        <span class="wb-icon">✨</span> Ver status
      </button>
      <button class="welcome-btn" onclick="window.location.href='schat-cofre.html'">
        <span class="wb-icon">🔐</span> Cofre
      </button>
      <button class="welcome-btn" onclick="window.abrirWrapup && window.abrirWrapup()">
        <span class="wb-icon">📊</span> Wrap-up
      </button>
    </div>
  </div>

  <div class="chat-content" id="chatContent" style="position:relative">

    <div class="chat-header">
      <button class="back-btn" onclick="voltarLista()">
        <svg viewBox="0 0 24 24" stroke-width="2"><polyline points="15,18 9,12 15,6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="avatar">
        <div class="avatar-img c1" id="chatAvatar">AL</div>
        <div class="status-dot online" id="chatStatusDot"></div>
      </div>
      <div class="chat-header-info" style="cursor:pointer" onclick="verDetalhesContato()">
        <div class="chat-header-name" id="chatName">Ana Lima</div>
        <div class="chat-header-status" id="chatStatus">Online agora</div>
      </div>
      <div class="chat-header-actions">
        <button class="icon-btn" title="Pesquisar na conversa" onclick="toggleBusca()" id="btnBusca">
          <svg viewBox="0 0 24 24" stroke-width="1.8" style="fill:none;stroke:var(--text-muted)"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </button>
        <button class="icon-btn" title="Chamada de voz">
          <svg viewBox="0 0 24 24" stroke-width="1.8"><path d="M22 16.9V19.9C22 20.5 21.5 21 21 21C10 21 1 12 1 3C1 2.4 1.5 2 2.1 2H5.1C5.6 2 6 2.4 6.1 2.9L7.1 7.5C7.2 8 7 8.5 6.6 8.8L4.9 10.1C6.4 13.1 8.9 15.6 11.9 17.1L13.2 15.4C13.5 15 14 14.8 14.5 14.9L19.1 15.9C19.6 16 20 16.4 20 16.9H22Z" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button class="icon-btn" title="Chamada de vídeo">
          <svg viewBox="0 0 24 24" stroke-width="1.8"><polygon points="23,7 16,12 23,17" stroke-linecap="round" stroke-linejoin="round"/><rect x="1" y="5" width="15" height="14" rx="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button class="icon-btn" title="Tema da conversa" onclick="toggleTemaPanel()">
          <svg viewBox="0 0 24 24" stroke-width="1.8" style="fill:none;stroke:var(--text-muted)"><circle cx="12" cy="12" r="10" stroke-linecap="round"/><circle cx="12" cy="8" r="1.5" fill="var(--text-muted)" stroke="none"/><circle cx="16" cy="14" r="1.5" fill="var(--orange-soft)" stroke="none"/><circle cx="8" cy="14" r="1.5" fill="#4a80c0" stroke="none"/></svg>
        </button>
        <button class="icon-btn" title="Modo Foco" onclick="toggleFoco()" id="btnFoco">
          <svg viewBox="0 0 24 24" stroke-width="1.8" style="fill:none;stroke:var(--text-muted)"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.9 4.9l2.1 2.1M16.9 16.9l2.1 2.1M19.1 4.9l-2.1 2.1M7.1 16.9l-2.1 2.1"/></svg>
        </button>
        <button class="icon-btn" title="Sala Flash" onclick="abrirSalaFlash()" id="btnSalaFlash">
          <svg viewBox="0 0 24 24" stroke-width="1.8" style="fill:none;stroke:var(--text-muted)"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </button>
        <button class="icon-btn" title="Linha do Tempo" onclick="abrirTimeline()" id="btnTimeline" style="position:relative">
          <svg viewBox="0 0 24 24" stroke-width="1.8" style="fill:none;stroke:var(--text-muted)"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
        </button>
        <button class="icon-btn" id="btnAbrirPainel" onclick="abrirPainel()" title="Ferramentas da conversa">
          <svg viewBox="0 0 24 24" stroke-width="2" style="fill:none"><circle cx="12" cy="5" r="1" fill="var(--text-muted)"/><circle cx="12" cy="12" r="1" fill="var(--text-muted)"/><circle cx="12" cy="19" r="1" fill="var(--text-muted)"/></svg>
        </button>
      </div>
    </div>



    <!-- BARRA DE PESQUISA NA CONVERSA -->
    <div class="search-bar-chat" id="searchBarChat">
      <input type="text" id="searchChatInput" placeholder="Buscar na conversa..." oninput="buscarNaConversa(this.value)">
      <div class="search-nav">
        <span class="search-count" id="searchCount">0/0</span>
        <button class="search-nav-btn" onclick="navegarBusca(-1)" title="Anterior">↑</button>
        <button class="search-nav-btn" onclick="navegarBusca(1)" title="Próximo">↓</button>
      </div>
      <button class="search-close-btn" onclick="fecharBusca()" title="Fechar">✕</button>
    </div>
    <!-- Strip de cor do tema -->
    <div class="tema-strip" id="temaStrip"></div>
    <!-- Banner modo fantasma -->
    <div class="ghost-banner" id="ghostBanner">
      <span class="ghost-banner-icon">👻</span>
      <span class="ghost-banner-text"><strong>Modo Fantasma ativo</strong> — suas leituras são invisíveis</span>
      <button class="ghost-banner-close" onclick="desativarFantasma()">✕</button>
    </div>
    <!-- Banner de mensagem fixada -->
    <div class="pinned-banner" id="pinnedBanner" onclick="irParaMsgFixada()">
      <div class="pinned-icon">📌</div>
      <div class="pinned-text">
        <div class="pinned-label">Mensagem fixada</div>
        <div class="pinned-content" id="pinnedContent">—</div>
      </div>
      <div class="pinned-count" id="pinnedCount"></div>
    </div>
    <div class="messages-wrap" id="messagesWrap">
      <div class="date-sep"><span>Hoje</span></div>

      <div class="msg in">
        <div class="msg-avatar c1">AL</div>
        <div class="msg-wrapper">
          <div>
            <div class="msg-bubble" onclick="mostrarReacoes(this)">
              Oi! Tudo bem? 😊
            </div>
            <div class="msg-footer"><span class="msg-time">14:22</span></div>
          </div>
          <button class="reaction-btn-fixed" onclick="mostrarReacoesBotao(this)" title="Reagir">😊</button>
        </div>
      </div>

      <!-- Exemplo de mensagem de voz recebida -->
      <div class="msg in">
        <div class="msg-avatar c1">AL</div>
        <div>
          <div class="audio-bubble" onclick="toggleAudio(this)">
            <button class="audio-play-btn">
              <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
            </button>
            <div class="audio-info">
              <div class="audio-waveform" id="wave-in"></div>
              <div class="audio-duration">0:08</div>
            </div>
          </div>
          <div class="msg-footer"><span class="msg-time">14:23</span></div>
        </div>
      </div>

      <div class="msg out">
        <div class="msg-wrapper">
          <button class="reaction-btn-fixed" onclick="mostrarReacoesBotao(this)" title="Reagir">😊</button>
          <div>
            <div class="msg-bubble" onclick="mostrarReacoes(this)">
              Tudo ótimo! E você? 😄
            </div>
            <div class="msg-footer">
              <span class="msg-time">14:24</span>
              <span class="msg-check">✓✓</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Exemplo de mensagem de voz enviada -->
      <div class="msg out">
        <div>
          <div class="audio-bubble" onclick="toggleAudio(this)">
            <button class="audio-play-btn">
              <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
            </button>
            <div class="audio-info">
              <div class="audio-waveform" id="wave-out"></div>
              <div class="audio-duration">0:05</div>
            </div>
          </div>
          <div class="msg-footer">
            <span class="msg-time">14:25</span>
            <span class="msg-check">✓✓</span>
          </div>
        </div>
      </div>

      <div class="msg in">
        <div class="msg-avatar c1">AL</div>
        <div class="msg-wrapper">
          <div>
            <div class="msg-bubble" onclick="mostrarReacoes(this)">
              Que app incrível esse S-Chat! 🔥
            </div>
            <div class="msg-footer"><span class="msg-time">14:26</span></div>
            <span class="msg-reaction">❤️ 1</span>
          </div>
          <button class="reaction-btn-fixed" onclick="mostrarReacoesBotao(this)" title="Reagir">😊</button>
        </div>
      </div>
    </div>

    <!-- Indicador digitando (Modo Humor) -->
    <div class="typing-indicator" id="typingIndicator" style="padding:0 18px 10px;position:relative;z-index:1;">
      <div class="msg-avatar c1" id="typingAvatar">AL</div>
      <div class="typing-bubble" id="typingBubble">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <span class="typing-humor-text" id="typingHumorText"></span>
      </div>
    </div>



    <!-- Dica microfone -->
    <div class="mic-hint" id="micHint">🎙️ Segure para gravar</div>

    <!-- Reply preview -->
    <div class="reply-preview" id="replyPreview">
      <div class="reply-preview-text">
        <div class="reply-preview-author" id="replyAuthor">—</div>
        <div class="reply-preview-content" id="replyContent">—</div>
      </div>
      <button class="reply-preview-close" onclick="cancelarReply()">✕</button>
    </div>

    <!-- Input -->
    <!-- QUICK REPLIES -->
    <div class="quick-replies" id="quickReplies">
      <!-- preenchido por JS -->
    </div>
    <div class="chat-input-wrap" id="inputWrap" style="position:relative">
    <div class="fmt-hint" id="fmtHint"></div>
    <!-- Emoji picker CONTEXTUAL (S-Chat) -->
    <div class="emoji-contextual" id="emojiContextual">
      <div class="emoji-ctx-header" id="emojiCtxLabel">Sugestões para esta conversa</div>
      <div class="emoji-ctx-row" id="emojiCtxSuggestions"></div>
      <div class="emoji-ctx-row" style="padding-top:4px;border-top:1px solid var(--border);margin-top:4px;flex-wrap:wrap;">
        <button class="emoji-ctx-btn" onclick="inserirEmoji('😊')">😊</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('😂')">😂</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('❤️')">❤️</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🔥')">🔥</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('👍')">👍</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🎉')">🎉</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('😎')">😎</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🤔')">🤔</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('😍')">😍</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('😢')">😢</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('😅')">😅</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🙏')">🙏</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('💬')">💬</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('⭐')">⭐</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🎮')">🎮</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🎵')">🎵</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🍕')">🍕</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('☕')">☕</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🫂')">🫂</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('✨')">✨</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🤯')">🤯</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🫡')">🫡</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('💯')">💯</button>
        <button class="emoji-ctx-btn" onclick="inserirEmoji('🚀')">🚀</button>
      </div>
    </div>

    <!-- STICKER PANEL S-CHAT -->
    <div class="sticker-panel" id="stickerPanel">
      <div class="sticker-panel-title">✦ Stickers S-Chat</div>
      <div class="sticker-grid" id="stickerGrid"></div>
    </div>
      <button class="btn-icon-input" onclick="toggleEmoji()" title="Emojis">
        <svg viewBox="0 0 24 24" stroke-width="1.8"><circle cx="12" cy="12" r="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 14s1.5 2 4 2 4-2 4-2" stroke-linecap="round" stroke-linejoin="round"/><line x1="9" y1="9" x2="9.01" y2="9" stroke-width="2.5" stroke-linecap="round"/><line x1="15" y1="9" x2="15.01" y2="9" stroke-width="2.5" stroke-linecap="round"/></svg>
      </button>
      <button class="btn-icon-input" onclick="abrirCardCreator()" title="Card Interativo" id="btnCard">
        <svg viewBox="0 0 24 24" stroke-width="1.8" style="fill:none;stroke:var(--text-muted)"><rect x="2" y="5" width="20" height="14" rx="3"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
      </button>
      <button class="btn-icon-input" onclick="toggleStickers()" title="Stickers S-Chat" id="btnSticker">
        <svg viewBox="0 0 24 24" stroke-width="1.8" style="fill:none;stroke:var(--text-muted)"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c1.8 0 3.5-.5 5-1.3L22 22l-1.3-5C21.5 15.5 22 13.8 22 12 22 6.5 17.5 2 12 2z" stroke-linecap="round"/><circle cx="8.5" cy="11" r="1.2" fill="var(--text-muted)" stroke="none"/><circle cx="12" cy="8.5" r="1.2" fill="var(--orange-soft)" stroke="none"/><circle cx="15.5" cy="11" r="1.2" fill="var(--text-muted)" stroke="none"/></svg>
      </button>
      <button class="btn-icon-input" title="Anexar">
        <svg viewBox="0 0 24 24" stroke-width="1.8"><path d="M21.4 11.6L12.2 20.8C10 23 6.5 23 4.3 20.8C2.1 18.6 2.1 15.1 4.3 12.9L13.5 3.7C15 2.2 17.4 2.2 18.9 3.7C20.4 5.2 20.4 7.6 18.9 9.1L9.6 18.3C8.8 19.1 7.5 19.1 6.7 18.3C5.9 17.5 5.9 16.2 6.7 15.4L15.2 6.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <textarea class="chat-input" id="chatInput" placeholder="Digite uma mensagem..." rows="1"
        onkeydown="enviarTecla(event)" oninput="autoResize(this)"></textarea>
      <button class="btn-send" onclick="enviarMensagem()" title="Enviar">
        <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/></svg>
      </button>
      <!-- Botão microfone -->
      <button class="btn-mic" id="btnMic"
        onmousedown="iniciarGravacao()" onmouseup="pararGravacao()" onmouseleave="cancelarGravacao()"
        ontouchstart="iniciarGravacao(event)" ontouchend="pararGravacao()" ontouchcancel="cancelarGravacao()"
        title="Segure para gravar">
        <svg viewBox="0 0 24 24" stroke-width="1.8">
          <rect x="9" y="2" width="6" height="11" rx="3" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M19 10C19 14.4 15.4 18 11 18C6.6 18 3 14.4 3 10" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="12" y1="18" x2="12" y2="22" stroke-linecap="round"/>
          <line x1="8" y1="22" x2="16" y2="22" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <!-- Overlay de gravação -->
    <div class="recording-overlay" id="recordingOverlay">
      <button class="rec-cancel" onclick="cancelarGravacao()" title="Cancelar">✕</button>
      <div class="rec-info">
        <div class="rec-top">
          <div class="rec-dot"></div>
          <div class="rec-label">Gravando áudio...</div>
        </div>
        <div class="rec-timer" id="recTimer">0:00</div>
        <div class="rec-wave">
          <div class="rec-wave-bar"></div><div class="rec-wave-bar"></div>
          <div class="rec-wave-bar"></div><div class="rec-wave-bar"></div>
          <div class="rec-wave-bar"></div><div class="rec-wave-bar"></div>
          <div class="rec-wave-bar"></div><div class="rec-wave-bar"></div>
        </div>
      </div>
      <button class="rec-send" onclick="enviarAudio()" title="Enviar áudio">
        <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/></svg>
      </button>
    </div>

  </div>
</div>

<!-- Reaction picker flutuante -->
<div class="reaction-picker" id="reactionPicker">
  <button class="emoji-btn" onclick="adicionarReacao('❤️')">❤️</button>
  <button class="emoji-btn" onclick="adicionarReacao('😂')">😂</button>
  <button class="emoji-btn" onclick="adicionarReacao('👍')">👍</button>
  <button class="emoji-btn" onclick="adicionarReacao('🔥')">🔥</button>
  <button class="emoji-btn" onclick="adicionarReacao('😮')">😮</button>
  <button class="emoji-btn" onclick="adicionarReacao('😢')">😢</button>
</div>

<script>
  const isMobile = () => window.innerWidth <= 700;
  let msgAlvo = null, emojiAberto = false;
  let recInterval = null, recSegundos = 0, gravando = false;
  let audioPlaying = null, audioInterval = null;

  // Gera waveform visual aleatória
  function gerarWave(containerId, barras = 20) {
    const c = document.getElementById(containerId);
    if (!c) return;
    c.innerHTML = '';
    for (let i = 0; i < barras; i++) {
      const b = document.createElement('div');
      b.className = 'wave-bar';
      const h = Math.floor(Math.random() * 16) + 4;
      b.style.height = h + 'px';
      c.appendChild(b);
    }
  }
  gerarWave('wave-in', 22);
  gerarWave('wave-out', 16);

  // ---- Abrir chat ----
  function abrirChat(el, nome, status, cor, iniciais) {
    document.querySelectorAll('.contact-item').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    const badge = el.querySelector('.unread-badge');
    if (badge) badge.remove();

    // Reset modo assistente
    modoAssistente = false;
    document.querySelector('.chat-area').classList.remove('assistente-mode');
    document.getElementById('chatInput').placeholder = 'Digite uma mensagem...';
    const av2 = document.getElementById('chatAvatar');
    av2.style.background = ''; av2.style.color = ''; av2.style.borderColor = ''; av2.style.fontSize = '';

    // Reset reply e pin
    cancelarReply();
    mensagensFixadas = [];
    document.getElementById('pinnedBanner').classList.remove('visible');
    document.getElementById('ghostBanner').classList.remove('visible');
    modoFantasma = false;

    document.getElementById('chatName').textContent = nome;
    const av = document.getElementById('chatAvatar');
    av.textContent = iniciais; av.className = 'avatar-img ' + cor;

    const dot = document.getElementById('chatStatusDot');
    const statusEl = document.getElementById('chatStatus');
    document.getElementById('typingAvatar').textContent = iniciais;
    document.getElementById('typingAvatar').className = 'msg-avatar ' + cor;

    if (status === 'online') {
      dot.className = 'status-dot online'; statusEl.textContent = 'Online agora'; statusEl.style.color = 'var(--green-online)';
    } else if (status === 'away') {
      dot.className = 'status-dot away'; statusEl.textContent = 'Ausente'; statusEl.style.color = '#c09030';
    } else {
      dot.className = 'status-dot offline'; statusEl.textContent = 'Offline'; statusEl.style.color = 'var(--text-muted)';
    }

    document.getElementById('welcome').classList.add('hidden');
    document.getElementById('chatContent').classList.add('visible');
    if (isMobile()) document.getElementById('sidebar').classList.add('hidden');
    document.getElementById('chatInput').focus();
    fecharTudo();

    // Quick Replies na última msg estática recebida
    setTimeout(() => {
      const msgsIn = document.querySelectorAll('#messagesWrap .msg.in .msg-bubble');
      if (msgsIn.length && window.mostrarQuickReplies) {
        window.mostrarQuickReplies(msgsIn[msgsIn.length - 1].textContent);
      }
    }, 600);
  }

  function voltarLista() { document.getElementById('sidebar').classList.remove('hidden'); }

  // ---- Enviar mensagem ----
  function enviarMensagem() {
    const input = document.getElementById('chatInput');
    const texto = input.value.trim();
    if (!texto) return;
    const wrap = document.getElementById('messagesWrap');
    const agora = new Date();
    const hora = agora.getHours().toString().padStart(2,'0') + ':' + agora.getMinutes().toString().padStart(2,'0');
    const div = document.createElement('div');
    div.className = 'msg out';
    div.innerHTML = `<div class="msg-wrapper">
      <button class="reaction-btn-fixed" onclick="mostrarReacoesBotao(this)" title="Reagir">😊</button>
      <div>
        <div class="msg-bubble" onclick="mostrarReacoes(this)">
          ${window.formatarTexto ? window.formatarTexto(texto) : texto.replace(/</g,'&lt;')}
        </div>
        <div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓</span></div>
      </div>
    </div>`;
    wrap.appendChild(div); wrap.scrollTop = wrap.scrollHeight;
    input.value = ''; input.style.height = 'auto';
    fecharTudo();

    const typing = document.getElementById('typingIndicator');
    const humorText = document.getElementById('typingHumorText');
    // Limpar texto de humor anterior
    if (humorText) humorText.textContent = '';

    // Tempo de resposta variável: entre 3s e 7s — dá tempo do humor aparecer
    const tempoResposta = 3000 + Math.floor(Math.random() * 4000);

    setTimeout(() => {
      typing.classList.add('visible');
      wrap.scrollTop = wrap.scrollHeight;

      // Iniciar ciclo de frases de humor dentro da bolha
      const frasesHumor = [
        { delay: 2000, text: 'ainda digitando... ✍️' },
        { delay: 4500, text: 'mudou de ideia? 👀' },
        { delay: 7000, text: 'tomando um café ☕' },
        { delay: 10000, text: 'reescrevendo tudo 😅' },
        { delay: 13000, text: 'é longa essa resposta 📜' },
        { delay: 17000, text: 'dedicação total 🔥' },
      ];
      const timersHumor = [];
      frasesHumor.forEach(f => {
        if (f.delay < tempoResposta) {
          const t = setTimeout(() => {
            if (!typing.classList.contains('visible')) return;
            if (humorText) {
              humorText.style.animation = 'none';
              requestAnimationFrame(() => {
                humorText.style.animation = 'humor-fade 0.35s ease both';
                humorText.textContent = f.text;
              });
            }
          }, f.delay);
          timersHumor.push(t);
        }
      });

      // Resposta chega após o tempo variável
      setTimeout(() => {
        timersHumor.forEach(t => clearTimeout(t));
        typing.classList.remove('visible');
        if (humorText) humorText.textContent = '';
        const av = document.getElementById('chatAvatar');
        const resp = document.createElement('div');
        resp.className = 'msg in';
        const rs = ['Entendido! 👍','Que ótimo! 😄','Haha! 😂','Incrível! 🔥','Valeu! 🙏','Concordo!','Pode deixar! ✅','Boa ideia! 💡'];
        const r = rs[Math.floor(Math.random()*rs.length)];
        resp.innerHTML = `
          <div class="msg-avatar ${av.className.replace('avatar-img ','')}">${av.textContent}</div>
          <div class="msg-wrapper">
            <div>
              <div class="msg-bubble" onclick="mostrarReacoes(this)">${r}</div>
              <div class="msg-footer"><span class="msg-time">${hora}</span></div>
            </div>
            <button class="reaction-btn-fixed" onclick="mostrarReacoesBotao(this)" title="Reagir">😊</button>
          </div>`;
        wrap.appendChild(resp); wrap.scrollTop = wrap.scrollHeight;
        div.querySelector('.msg-check').textContent = '✓✓';
      }, tempoResposta);

    }, 900);
  }

  function enviarTecla(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); enviarMensagem(); }
  }

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  // ---- GRAVAÇÃO DE ÁUDIO ----
  function iniciarGravacao(e) {
    if (e) e.preventDefault();
    gravando = true;
    recSegundos = 0;
    document.getElementById('btnMic').classList.add('recording');
    document.getElementById('recordingOverlay').classList.add('visible');
    document.getElementById('inputWrap').style.opacity = '0';
    document.getElementById('inputWrap').style.pointerEvents = 'none';
    atualizarTimer();
    recInterval = setInterval(() => {
      recSegundos++;
      atualizarTimer();
      if (recSegundos >= 120) enviarAudio(); // limite 2min
    }, 1000);
  }

  function atualizarTimer() {
    const m = Math.floor(recSegundos / 60);
    const s = (recSegundos % 60).toString().padStart(2,'0');
    document.getElementById('recTimer').textContent = m + ':' + s;
  }

  function pararGravacao() {
    if (!gravando) return;
    clearInterval(recInterval);
    gravando = false;
    if (recSegundos >= 1) {
      enviarAudio();
    } else {
      cancelarGravacao();
    }
  }

  function cancelarGravacao() {
    clearInterval(recInterval);
    gravando = false;
    recSegundos = 0;
    document.getElementById('btnMic').classList.remove('recording');
    document.getElementById('recordingOverlay').classList.remove('visible');
    document.getElementById('inputWrap').style.opacity = '1';
    document.getElementById('inputWrap').style.pointerEvents = '';
  }

  function enviarAudio() {
    const duracao = recSegundos;
    cancelarGravacao();
    if (duracao < 1) return;

    const wrap = document.getElementById('messagesWrap');
    const agora = new Date();
    const hora = agora.getHours().toString().padStart(2,'0') + ':' + agora.getMinutes().toString().padStart(2,'0');
    const m = Math.floor(duracao/60), s = (duracao%60).toString().padStart(2,'0');
    const waveId = 'wave-' + Date.now();

    const div = document.createElement('div');
    div.className = 'msg out';
    div.innerHTML = `<div>
      <div class="audio-bubble" onclick="toggleAudio(this)">
        <button class="audio-play-btn">
          <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
        </button>
        <div class="audio-info">
          <div class="audio-waveform" id="${waveId}"></div>
          <div class="audio-duration">${m}:${s}</div>
        </div>
      </div>
      <div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓✓</span></div>
    </div>`;

    wrap.appendChild(div);
    wrap.scrollTop = wrap.scrollHeight;
    gerarWave(waveId, Math.min(10 + duracao * 2, 30));
  }

  // ---- Player de áudio simulado ----
  function toggleAudio(bubble) {
    const btn = bubble.querySelector('.audio-play-btn');
    const bars = bubble.querySelectorAll('.wave-bar');
    const durEl = bubble.querySelector('.audio-duration');

    if (audioPlaying && audioPlaying !== bubble) {
      pararAudio(audioPlaying);
    }

    if (bubble.dataset.playing === '1') {
      pararAudio(bubble);
    } else {
      bubble.dataset.playing = '1';
      audioPlaying = bubble;
      btn.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:14px;height:14px"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
      bars.forEach((b, i) => {
        b.style.background = 'var(--orange-soft)';
        b.style.animation = `wave-anim ${0.6 + Math.random()*0.4}s infinite ${i*0.05}s`;
      });

      const orig = durEl.textContent;
      const parts = orig.split(':');
      let total = parseInt(parts[0])*60 + parseInt(parts[1]);
      let restante = total;

      audioInterval = setInterval(() => {
        restante--;
        const m = Math.floor(restante/60), s = (restante%60).toString().padStart(2,'0');
        durEl.textContent = m + ':' + s;
        if (restante <= 0) {
          pararAudio(bubble);
          durEl.textContent = orig;
        }
      }, 1000);
    }
  }

  function pararAudio(bubble) {
    if (!bubble) return;
    bubble.dataset.playing = '0';
    clearInterval(audioInterval);
    const btn = bubble.querySelector('.audio-play-btn');
    if (btn) btn.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:14px;height:14px;margin-left:2px"><polygon points="5,3 19,12 5,21"/></svg>';
    const bars = bubble.querySelectorAll('.wave-bar');
    bars.forEach(b => { b.style.background = 'var(--text-muted)'; b.style.animation = 'none'; });
    if (audioPlaying === bubble) audioPlaying = null;
  }

  // ---- Dica microfone ----
  const btnMic = document.getElementById('btnMic');
  btnMic.addEventListener('mouseenter', () => { document.getElementById('micHint').classList.add('visible'); });
  btnMic.addEventListener('mouseleave', () => { document.getElementById('micHint').classList.remove('visible'); });

  // ---- Emojis ----
  function toggleEmoji() {
    emojiAberto = !emojiAberto;
    document.getElementById('emojiPicker').classList.toggle('open', emojiAberto);
  }

  function inserirEmoji(emoji) {
    const input = document.getElementById('chatInput');
    const pos = input.selectionStart;
    input.value = input.value.slice(0, pos) + emoji + input.value.slice(pos);
    input.focus();
    input.setSelectionRange(pos+emoji.length, pos+emoji.length);
  }

  // ---- Reações ----
  function mostrarReacoesBotao(btn) {
    // Find the bubble in the same msg-wrapper
    const wrapper = btn.closest('.msg-wrapper') || btn.closest('.msg');
    const bubble = wrapper?.querySelector('.msg-bubble');
    if (bubble) mostrarReacoes(bubble);
  }

  function mostrarReacoes(bubble) {
    msgAlvo = bubble;
    const picker = document.getElementById('reactionPicker');
    const rect = bubble.getBoundingClientRect();
    picker.style.top = (rect.top - 54 + window.scrollY) + 'px';
    picker.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';
    picker.classList.add('open');
  }

  function adicionarReacao(emoji) {
    if (!msgAlvo) return;
    const pai = msgAlvo.parentElement;
    let reacao = pai.querySelector('.msg-reaction');
    if (reacao) {
      const p = reacao.textContent.trim().split(' ');
      reacao.textContent = emoji + ' ' + ((parseInt(p[1])||1)+1);
    } else {
      reacao = document.createElement('span');
      reacao.className = 'msg-reaction';
      reacao.textContent = emoji + ' 1';
      reacao.onclick = () => reacao.remove();
      pai.appendChild(reacao);
    }
    document.getElementById('reactionPicker').classList.remove('open');
    msgAlvo = null;
  }

  function fecharTudo() {
    document.getElementById('emojiPicker').classList.remove('open');
    document.getElementById('reactionPicker').classList.remove('open');
    document.getElementById('micHint').classList.remove('visible');
    emojiAberto = false;
  }

  function filtrarContatos(termo) {
    document.querySelectorAll('.contact-item').forEach(item => {
      const nome = item.getAttribute('data-nome') || '';
      item.style.display = nome.toLowerCase().includes(termo.toLowerCase()) ? '' : 'none';
    });
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('#emojiPicker') && !e.target.closest('.btn-icon-input') &&
        !e.target.closest('#reactionPicker') && !e.target.closest('.msg-bubble') &&
        !e.target.closest('.reaction-trigger')) fecharTudo();
  });

  if (!isMobile()) document.querySelector('.contact-item').click();

  // =====================================================
  // DIFERENCIAIS S-CHAT
  // =====================================================
  let modoFantasma = false;
  let timerMsgAtivo = false;
  let timerMsgValor = 30;
  let lembretes = [];

  // ---- MODO FANTASMA ----
  function toggleFantasma() {
    modoFantasma = !modoFantasma;
    const btn = document.getElementById('btnFantasma');
    const banner = document.getElementById('ghostBanner');
    if (modoFantasma) {
      btn.classList.add('ghost-on');
      banner.classList.add('visible');
      mostrarToastDif('👻 Modo Fantasma ativado — você é invisível', '#8a4ac0');
    } else {
      desativarFantasma();
    }
  }

  function desativarFantasma() {
    modoFantasma = false;
    document.getElementById('btnFantasma').classList.remove('ghost-on','active');
    document.getElementById('ghostBanner').classList.remove('visible');
    mostrarToastDif('Modo Fantasma desativado', 'var(--text-secondary)');
  }

  // ---- TIMER DE MENSAGEM ----
  const timerOpcoes = [
    { label:'10s', val:10 },{ label:'30s', val:30 },{ label:'1min', val:60 },
    { label:'5min', val:300 },{ label:'1h', val:3600 },{ label:'24h', val:86400 },
  ];

  function toggleTimerMsg() {
    const btn = document.getElementById('btnTimer');
    const existing = document.getElementById('timerPopup');
    if (existing) { existing.remove(); timerMsgAtivo = false; btn.classList.remove('active'); return; }
    const pop = document.createElement('div');
    pop.id = 'timerPopup';
    pop.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);max-width:200px;width:90%;background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:12px;z-index:50;display:flex;flex-direction:column;gap:6px;box-shadow:0 12px 40px #00000070;animation:picker-in 0.15s ease both;min-width:140px;';
    pop.innerHTML = '<div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px">⏱️ Auto-destruir após</div>' +
      timerOpcoes.map(o => `<button onclick="setTimerMsg(${o.val},'${o.label}')" style="padding:7px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;text-align:left;" onmouseover="this.style.background='var(--bg-deep)'" onmouseout="this.style.background='var(--bg-input)'">${o.label}</button>`).join('') +
      '<button onclick="cancelarTimer()" style="padding:7px 12px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);font-family:\'Sora\',sans-serif;font-size:12px;cursor:pointer;">Cancelar</button>';
    document.body.appendChild(pop);
  }

  function setTimerMsg(segundos, label) {
    timerMsgAtivo = true; timerMsgValor = segundos;
    const btn = document.getElementById('btnTimer');
    btn.classList.add('active');
    btn.innerHTML = `<svg viewBox="0 0 24 24" stroke-width="1.8"><circle cx="12" cy="12" r="10" stroke-linecap="round"/><polyline points="12,6 12,12 16,14" stroke-linecap="round"/></svg> ⏱ ${label}`;
    document.getElementById('timerPopup')?.remove();
    mostrarToastDif(`⏱️ Próximas mensagens somem em ${label}`, 'var(--orange-soft)');
  }

  function cancelarTimer() {
    timerMsgAtivo = false;
    const btn = document.getElementById('btnTimer');
    btn.classList.remove('active');
    btn.innerHTML = '<svg viewBox="0 0 24 24" stroke-width="1.8"><circle cx="12" cy="12" r="10" stroke-linecap="round"/><polyline points="12,6 12,12 16,14" stroke-linecap="round"/></svg> Timer';
    document.getElementById('timerPopup')?.remove();
  }

  function aplicarTimer(msgEl, segundos) {
    const badge = document.createElement('div');
    badge.className = 'msg-timer-badge';
    const bid = 'b' + Date.now();
    badge.innerHTML = `<svg viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14" stroke-linecap="round"/></svg><span id="${bid}">${formatarTimer(segundos)}</span>`;
    const footer = msgEl.querySelector('.msg-footer');
    if (footer) footer.insertAdjacentElement('afterend', badge);
    let restante = segundos;
    const interval = setInterval(() => {
      restante--;
      const el = document.getElementById(bid);
      if (el) el.textContent = formatarTimer(restante);
      if (restante <= 10) badge.classList.add('expiring');
      if (restante <= 0) {
        clearInterval(interval);
        msgEl.style.transition = 'opacity 0.5s, transform 0.5s';
        msgEl.style.opacity = '0'; msgEl.style.transform = 'scale(0.9)';
        setTimeout(() => msgEl.remove(), 500);
      }
    }, 1000);
  }

  function formatarTimer(seg) {
    if (seg >= 3600) return Math.floor(seg/3600) + 'h';
    if (seg >= 60) return Math.floor(seg/60) + 'min';
    return seg + 's';
  }

  // ---- TEMA POR CONVERSA ----
  function toggleTemaPanel() {
    document.getElementById('temaPanel').classList.toggle('open');
  }

  function setTemaCat(el, tema, nome) {
    document.querySelectorAll('.tema-opt').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    const area = document.querySelector('.chat-area');
    const strip = document.getElementById('temaStrip');
    area.dataset.tema = tema;
    const cores = { verde:'#4a9e6a', azul:'#4a80c0', rosa:'#c04a8a', roxo:'#8a4ac0', '':'#e8874a' };
    const cor = cores[tema] || '#e8874a';
    strip.style.background = cor;
    strip.style.boxShadow = `0 0 12px ${cor}40`;
    if (!tema) strip.style.background = 'transparent';
    document.getElementById('temaPanel').classList.remove('open');
    mostrarToastDif(`🎨 Tema "${nome}" aplicado`, cor);
  }

  // ---- CÁPSULA DO TEMPO ----
  function toggleCapsula() {
    const f = document.getElementById('capsulaForm');
    const btn = document.getElementById('btnCapsula');
    const isOpen = f.classList.toggle('open');
    btn.classList.toggle('active', isOpen);
    if (isOpen) {
      document.getElementById('enqueteForm').classList.remove('open');
      document.getElementById('lembreteForm').classList.remove('open');
      document.getElementById('btnEnquete').classList.remove('active');
      document.getElementById('btnLembrete').classList.remove('active');
      const agora = new Date(); agora.setMinutes(agora.getMinutes()+1);
      document.getElementById('capsulaData').min = agora.toISOString().slice(0,16);
    }
    fecharTudo();
  }

  function enviarCapsula() {
    const msg = document.getElementById('capsulaMsg').value.trim();
    const data = document.getElementById('capsulaData').value;
    if (!msg || !data) { mostrarToastDif('Preencha a mensagem e a data!', '#c05050'); return; }
    const dataFmt = new Date(data).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
    const wrap = document.getElementById('messagesWrap');
    const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    const div = document.createElement('div'); div.className = 'msg out';
    div.innerHTML = `<div><div class="msg-bubble msg-capsula"><div class="capsula-header"><svg viewBox="0 0 24 24" stroke-width="1.8"><path d="M12 22C12 22 5 16 5 10C5 6.7 8.1 4 12 4C15.9 4 19 6.7 19 10C19 16 12 22 12 22Z" stroke-linecap="round"/><circle cx="12" cy="10" r="2"/></svg>💊 Cápsula do Tempo</div><div style="font-size:14px;line-height:1.5;font-style:italic;color:var(--text-secondary)">"${msg.replace(/</g,'&lt;')}"</div><div class="capsula-unlock-date">🔓 Abre em: ${dataFmt}</div></div><div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓</span></div></div>`;
    wrap.appendChild(div); wrap.scrollTop = wrap.scrollHeight;
    document.getElementById('capsulaMsg').value = ''; document.getElementById('capsulaData').value = '';
    document.getElementById('capsulaForm').classList.remove('open'); document.getElementById('btnCapsula').classList.remove('active');
    mostrarToastDif('💊 Cápsula criada! Entrega em ' + dataFmt, '#8a4ac0');
  }

  // ---- ENQUETE COM DEBATE ----
  function toggleEnquete() {
    const f = document.getElementById('enqueteForm');
    const btn = document.getElementById('btnEnquete');
    const isOpen = f.classList.toggle('open');
    btn.classList.toggle('active', isOpen);
    if (isOpen) {
      document.getElementById('capsulaForm').classList.remove('open');
      document.getElementById('lembreteForm').classList.remove('open');
      document.getElementById('btnCapsula').classList.remove('active');
      document.getElementById('btnLembrete').classList.remove('active');
    }
    fecharTudo();
  }

  function addOpcaoEnquete() {
    const cont = document.getElementById('enqueteOpcoes');
    if (cont.children.length >= 5) { mostrarToastDif('Máximo de 5 opções', '#c05050'); return; }
    const n = cont.children.length + 1;
    const row = document.createElement('div'); row.className = 'enquete-opcao-row';
    row.innerHTML = `<input class="enquete-opcao-input" placeholder="Opção ${n}">`;
    cont.appendChild(row);
  }

  const enqueteVotos = {};

  function enviarEnquete() {
    const pergunta = document.getElementById('enquetePergunta').value.trim();
    const inputs = document.querySelectorAll('#enqueteOpcoes .enquete-opcao-input');
    const opcoes = Array.from(inputs).map(i => i.value.trim()).filter(Boolean);
    if (!pergunta || opcoes.length < 2) { mostrarToastDif('Preencha a pergunta e pelo menos 2 opções!', '#c05050'); return; }
    const wrap = document.getElementById('messagesWrap');
    const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    const eqId = 'eq' + Date.now();
    const div = document.createElement('div'); div.className = 'msg out'; div.style.maxWidth = '300px';
    const opcoesHtml = opcoes.map((op,i) => `<button class="enquete-opcao" id="${eqId}-op${i}" onclick="votarEnquete('${eqId}',${i},${opcoes.length})"><div class="enquete-barra" id="${eqId}-bar${i}" style="width:0%"></div><div class="enquete-opcao-texto"><span>${op.replace(/</g,'&lt;')}</span><span class="enquete-pct" id="${eqId}-pct${i}"></span></div></button>`).join('');
    div.innerHTML = `<div><div class="msg-bubble msg-enquete"><div class="enquete-header-badge"><svg viewBox="0 0 24 24" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10" stroke-linecap="round"/><line x1="12" y1="20" x2="12" y2="4" stroke-linecap="round"/><line x1="6" y1="20" x2="6" y2="14" stroke-linecap="round"/></svg>Enquete • S-Chat</div><div class="enquete-titulo">${pergunta.replace(/</g,'&lt;')}</div>${opcoesHtml}<div class="enquete-total" id="${eqId}-total">0 votos</div><button class="enquete-debate-toggle" onclick="toggleDebate('${eqId}')">💬 Ver debate (0)</button><div class="enquete-debate" id="${eqId}-debate"><div class="enquete-debate-titulo">Debate da enquete</div><div id="${eqId}-coments"></div><div class="enquete-debate-input-row"><input class="enquete-debate-input" id="${eqId}-debinput" placeholder="Argumente sua escolha..."><button class="enquete-debate-send" onclick="enviarDebate('${eqId}')">→</button></div></div></div><div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓</span></div></div>`;
    wrap.appendChild(div); wrap.scrollTop = wrap.scrollHeight;
    document.getElementById('enquetePergunta').value = '';
    inputs.forEach(i => i.value = '');
    document.getElementById('enqueteForm').classList.remove('open'); document.getElementById('btnEnquete').classList.remove('active');
    mostrarToastDif('📊 Enquete publicada!', '#4a80c0');
  }

  function votarEnquete(id, idx, total) {
    if (!enqueteVotos[id]) enqueteVotos[id] = { votos: new Array(total).fill(0), votado:-1, totalVotos:0 };
    const eq = enqueteVotos[id];
    if (eq.votado !== -1) { eq.votos[eq.votado]--; }
    eq.votos[idx]++; eq.votado = idx;
    if (eq.totalVotos === 0) {
      for (let i=0;i<total;i++) eq.votos[i] += Math.floor(Math.random()*7)+1;
    }
    eq.totalVotos = eq.votos.reduce((a,b)=>a+b,0);
    for (let i=0;i<total;i++) {
      const pct = Math.round(eq.votos[i]/eq.totalVotos*100);
      const bar = document.getElementById(`${id}-bar${i}`);
      const pctEl = document.getElementById(`${id}-pct${i}`);
      const btn = document.getElementById(`${id}-op${i}`);
      if (bar) bar.style.width = pct+'%';
      if (pctEl) pctEl.textContent = pct+'%';
      if (btn) btn.classList.toggle('votado', i===eq.votado);
    }
    const tot = document.getElementById(`${id}-total`);
    if (tot) tot.textContent = eq.totalVotos + ' voto' + (eq.totalVotos!==1?'s':'');
  }

  function toggleDebate(id) {
    const d = document.getElementById(`${id}-debate`); if(d) d.classList.toggle('open');
  }

  function enviarDebate(id) {
    const input = document.getElementById(`${id}-debinput`);
    const texto = input.value.trim(); if(!texto) return;
    const cont = document.getElementById(`${id}-coments`);
    const div = document.createElement('div'); div.className = 'enquete-comentario';
    div.innerHTML = `<span class="enquete-comentario-user">Você: </span>${texto.replace(/</g,'&lt;')}`;
    cont.appendChild(div); input.value = '';
    const toggle = document.querySelector(`[onclick="toggleDebate('${id}')"]`);
    if (toggle) toggle.textContent = `💬 Debate (${cont.children.length})`;
  }

  // ---- LEMBRETE ----
  function toggleLembrete() {
    const f = document.getElementById('lembreteForm');
    const btn = document.getElementById('btnLembrete');
    const isOpen = f.classList.toggle('open');
    btn.classList.toggle('active', isOpen);
    if (isOpen) {
      document.getElementById('capsulaForm').classList.remove('open');
      document.getElementById('enqueteForm').classList.remove('open');
      document.getElementById('btnCapsula').classList.remove('active');
      document.getElementById('btnEnquete').classList.remove('active');
      const agora = new Date(); agora.setMinutes(agora.getMinutes()+1);
      document.getElementById('lembreteData').min = agora.toISOString().slice(0,16);
    }
    fecharTudo();
  }

  function enviarLembrete() {
    const msg = document.getElementById('lembreteMsg').value.trim();
    const data = document.getElementById('lembreteData').value;
    if (!msg || !data) { mostrarToastDif('Preencha a mensagem e a data!', '#c05050'); return; }
    const dataObj = new Date(data);
    const dataFmt = dataObj.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
    const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    const wrap = document.getElementById('messagesWrap');
    const div = document.createElement('div'); div.className = 'msg out';
    div.innerHTML = `<div><div class="msg-bubble msg-lembrete"><div class="lembrete-header"><svg viewBox="0 0 24 24" stroke-width="1.8"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke-linecap="round"/><path d="M13.7 21a2 2 0 0 1-3.4 0" stroke-linecap="round"/></svg>⏰ Lembrete criado</div><div style="font-size:14px;line-height:1.5">${msg.replace(/</g,'&lt;')}</div><div class="lembrete-when">🔔 Notifica em: ${dataFmt}</div></div><div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓✓</span></div></div>`;
    wrap.appendChild(div); wrap.scrollTop = wrap.scrollHeight;
    const delay = dataObj.getTime() - Date.now();
    if (delay > 0 && delay < 86400000) setTimeout(() => dispararLembrete(msg), delay);
    document.getElementById('lembreteMsg').value = ''; document.getElementById('lembreteData').value = '';
    document.getElementById('lembreteForm').classList.remove('open'); document.getElementById('btnLembrete').classList.remove('active');
    mostrarToastDif('⏰ Lembrete criado para ' + dataFmt, '#4a9e6a');
  }

  function dispararLembrete(msg) {
    const notif = document.getElementById('lembreteNotif');
    document.getElementById('lembreteNotifMsg').textContent = msg;
    notif.classList.add('show');
    setTimeout(() => notif.classList.remove('show'), 8000);
  }

  function fecharNotifLembrete() { document.getElementById('lembreteNotif').classList.remove('show'); }

  // ---- HOOK: timer automático ao enviar mensagem ----
  const _enviarOriginal = enviarMensagem;
  enviarMensagem = function() {
    const texto = document.getElementById('chatInput').value.trim();
    if (!texto) return;
    _enviarOriginal();
    if (timerMsgAtivo) {
      setTimeout(() => {
        const msgs = document.querySelectorAll('#messagesWrap .msg.out');
        if (msgs.length) aplicarTimer(msgs[msgs.length-1], timerMsgValor);
      }, 60);
    }
  };

  // ---- TOAST COLORIDO ----
  function mostrarToastDif(msg, cor) {
    const t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.style.borderColor = cor || 'var(--border)';
    t.style.color = 'var(--text-primary)';
    t.classList.add('show');
    clearTimeout(t._timer2);
    t._timer2 = setTimeout(() => { t.classList.remove('show'); t.style.borderColor=''; }, 3000);
  }


  // =====================================================
  // PAINEL LATERAL DE FEATURES
  // =====================================================

  function abrirPainel() {
    // Sincronizar avatar e nome com o chat atual
    const av = document.getElementById('chatAvatar');
    const nm = document.getElementById('chatName');
    if (av && nm) {
      const fpAv = document.getElementById('fpAvatar');
      fpAv.textContent = av.textContent;
      fpAv.className = 'fp-header-avatar avatar-img ' + av.className.replace('avatar-img ','');
      document.getElementById('fpNome').textContent = nm.textContent;
    }
    document.getElementById('featOverlay').classList.add('open');
    document.getElementById('featPanel').classList.add('open');
  }

  function fecharPainel() {
    document.getElementById('featOverlay').classList.remove('open');
    document.getElementById('featPanel').classList.remove('open');
  }

  // ---- Toggle fantasma no painel ----
  function fpToggleGhost() {
    modoFantasma = !modoFantasma;
    const tog = document.getElementById('fpToggleFantasma');
    const banner = document.getElementById('ghostBanner');
    if (modoFantasma) {
      tog.classList.add('on','ghost-on');
      tog.style.background = '#8a4ac0'; tog.style.borderColor = '#8a4ac0';
      banner.classList.add('visible');
      mostrarToastDif('👻 Modo Fantasma ativado', '#8a4ac0');
      document.getElementById('btnAbrirPainel').classList.add('has-active');
    } else {
      tog.classList.remove('on','ghost-on');
      tog.style.background = ''; tog.style.borderColor = '';
      banner.classList.remove('visible');
      mostrarToastDif('Modo Fantasma desativado', 'var(--text-muted)');
      atualizarBtnPainel();
    }
  }

  // ---- Timer no painel ----
  function fpToggleTimerSwitch() {
    const tog = document.getElementById('fpToggleTimer');
    const grid = document.getElementById('fpTimerGrid');
    const isOn = tog.classList.toggle('on');
    if (isOn) {
      grid.style.display = 'flex';
      fpSetTimer(30,'30s'); // padrão
    } else {
      grid.style.display = 'none';
      timerMsgAtivo = false;
      document.getElementById('fpTimerDesc').textContent = 'Desativado';
      document.querySelectorAll('.fp-timer-opt').forEach(b => b.classList.remove('selected'));
      mostrarToastDif('Timer desativado', 'var(--text-muted)');
      atualizarBtnPainel();
    }
  }

  function fpSetTimer(seg, label) {
    timerMsgAtivo = true; timerMsgValor = seg;
    document.querySelectorAll('.fp-timer-opt').forEach(b => b.classList.remove('selected'));
    event?.target?.classList.add('selected');
    document.getElementById('fpTimerDesc').textContent = 'Mensagens somem em ' + label;
    document.getElementById('fpToggleTimer').classList.add('on');
    document.getElementById('fpTimerGrid').style.display = 'flex';
    mostrarToastDif('⏱️ Mensagens somem em ' + label, 'var(--orange-soft)');
    document.getElementById('btnAbrirPainel').classList.add('has-active');
  }

  // ---- Tema no painel ----
  function fpSetTema(el) {
    const tema = el.dataset.tema;
    const nome = el.dataset.nome;
    document.querySelectorAll('.fp-tema-opt').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    const area = document.querySelector('.chat-area');
    const strip = document.getElementById('temaStrip');
    area.dataset.tema = tema;
    const cores = { verde:'#4a9e6a', azul:'#4a80c0', rosa:'#c04a8a', roxo:'#8a4ac0', '':'transparent' };
    const cor = cores[tema];
    strip.style.background = cor === 'transparent' ? 'transparent' : cor;
    strip.style.boxShadow = cor === 'transparent' ? 'none' : `0 0 10px ${cor}50`;
    document.getElementById('fpTemaDesc').textContent = nome;
    mostrarToastDif('🎨 Tema "' + nome + '" aplicado', cor === 'transparent' ? 'var(--orange-soft)' : cor);
    atualizarBtnPainel();
  }

  // ---- Toggle de forms dentro do painel ----
  function fpToggleForm(tipo) {
    const formId = { capsula:'fpFormCapsula', lembrete:'fpFormLembrete', enquete:'fpFormEnquete' }[tipo];
    const chevId = { capsula:'fpChevronCapsula', lembrete:'fpChevronLembrete', enquete:'fpChevronEnquete' }[tipo];
    const form = document.getElementById(formId);
    const chev = document.getElementById(chevId);
    if (!form) return;
    const isOpen = form.style.display === 'none' || form.style.display === '';
    // Fechar todos os forms
    ['fpFormCapsula','fpFormLembrete','fpFormEnquete'].forEach(id => { document.getElementById(id).style.display = 'none'; });
    ['fpChevronCapsula','fpChevronLembrete','fpChevronEnquete'].forEach(id => { document.getElementById(id).style.transform = ''; });
    if (isOpen) {
      form.style.display = 'block';
      chev.style.transform = 'rotate(180deg)';
      // Pre-preencher data min
      if (tipo === 'capsula' || tipo === 'lembrete') {
        const agora = new Date(); agora.setMinutes(agora.getMinutes()+1);
        const dataId = tipo === 'capsula' ? 'fpCapsulaData' : 'fpLembreteData';
        document.getElementById(dataId).min = agora.toISOString().slice(0,16);
      }
    }
  }

  // ---- Enviar Cápsula do painel ----
  function fpEnviarCapsula(e) {
    e.stopPropagation();
    const msg = document.getElementById('fpCapsulaMsg').value.trim();
    const data = document.getElementById('fpCapsulaData').value;
    if (!msg || !data) { mostrarToastDif('Preencha a mensagem e a data!','#c05050'); return; }
    const dataFmt = new Date(data).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
    const wrap = document.getElementById('messagesWrap');
    const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    const div = document.createElement('div'); div.className = 'msg out';
    div.innerHTML = `<div><div class="msg-bubble msg-capsula"><div class="capsula-header"><svg viewBox="0 0 24 24" stroke-width="1.8"><path d="M12 22C12 22 5 16 5 10C5 6.7 8.1 4 12 4C15.9 4 19 6.7 19 10C19 16 12 22 12 22Z" stroke-linecap="round"/><circle cx="12" cy="10" r="2"/></svg>💊 Cápsula do Tempo</div><div style="font-size:14px;line-height:1.5;font-style:italic;color:var(--text-secondary)">"${msg.replace(/</g,'&lt;')}"</div><div class="capsula-unlock-date">🔓 Abre em: ${dataFmt}</div></div><div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓</span></div></div>`;
    wrap.appendChild(div); wrap.scrollTop = wrap.scrollHeight;
    document.getElementById('fpCapsulaMsg').value = ''; document.getElementById('fpCapsulaData').value = '';
    fpToggleForm('capsula'); fecharPainel();
    mostrarToastDif('💊 Cápsula criada! Entrega em ' + dataFmt, '#8a4ac0');
  }

  // ---- Enviar Lembrete do painel ----
  function fpEnviarLembrete(e) {
    e.stopPropagation();
    const msg = document.getElementById('fpLembreteMsg').value.trim();
    const data = document.getElementById('fpLembreteData').value;
    if (!msg || !data) { mostrarToastDif('Preencha a mensagem e a data!','#c05050'); return; }
    const dataObj = new Date(data);
    const dataFmt = dataObj.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
    const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    const wrap = document.getElementById('messagesWrap');
    const div = document.createElement('div'); div.className = 'msg out';
    div.innerHTML = `<div><div class="msg-bubble msg-lembrete"><div class="lembrete-header"><svg viewBox="0 0 24 24" stroke-width="1.8"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke-linecap="round"/><path d="M13.7 21a2 2 0 0 1-3.4 0" stroke-linecap="round"/></svg>⏰ Lembrete</div><div style="font-size:14px;line-height:1.5">${msg.replace(/</g,'&lt;')}</div><div class="lembrete-when">🔔 Notifica em: ${dataFmt}</div></div><div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓✓</span></div></div>`;
    wrap.appendChild(div); wrap.scrollTop = wrap.scrollHeight;
    const delay = dataObj.getTime() - Date.now();
    if (delay > 0 && delay < 86400000) setTimeout(() => dispararLembrete(msg), delay);
    document.getElementById('fpLembreteMsg').value = ''; document.getElementById('fpLembreteData').value = '';
    fpToggleForm('lembrete'); fecharPainel();
    mostrarToastDif('⏰ Lembrete para ' + dataFmt, '#4a9e6a');
  }

  // ---- Enquete do painel ----
  function fpAddOpcao(e) {
    e.stopPropagation();
    const cont = document.getElementById('fpEnqueteOpts');
    if (cont.children.length >= 5) { mostrarToastDif('Máximo 5 opções','#c05050'); return; }
    const input = document.createElement('input');
    input.className = 'fp-input'; input.placeholder = 'Opção ' + (cont.children.length+1);
    input.style.marginBottom = '0';
    cont.appendChild(input);
  }

  function fpEnviarEnquete(e) {
    e.stopPropagation();
    const pergunta = document.getElementById('fpEnquetePerg').value.trim();
    const inputs = document.querySelectorAll('#fpEnqueteOpts .fp-input');
    const opcoes = Array.from(inputs).map(i=>i.value.trim()).filter(Boolean);
    if (!pergunta || opcoes.length < 2) { mostrarToastDif('Preencha a pergunta e 2+ opções!','#c05050'); return; }
    const wrap = document.getElementById('messagesWrap');
    const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    const eqId = 'eq'+Date.now();
    const div = document.createElement('div'); div.className = 'msg out'; div.style.maxWidth = '300px';
    const opcoesHtml = opcoes.map((op,i)=>`<button class="enquete-opcao" id="${eqId}-op${i}" onclick="votarEnquete('${eqId}',${i},${opcoes.length})"><div class="enquete-barra" id="${eqId}-bar${i}" style="width:0%"></div><div class="enquete-opcao-texto"><span>${op.replace(/</g,'&lt;')}</span><span class="enquete-pct" id="${eqId}-pct${i}"></span></div></button>`).join('');
    div.innerHTML = `<div><div class="msg-bubble msg-enquete"><div class="enquete-header-badge"><svg viewBox="0 0 24 24" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10" stroke-linecap="round"/><line x1="12" y1="20" x2="12" y2="4" stroke-linecap="round"/><line x1="6" y1="20" x2="6" y2="14" stroke-linecap="round"/></svg>Enquete • S-Chat</div><div class="enquete-titulo">${pergunta.replace(/</g,'&lt;')}</div>${opcoesHtml}<div class="enquete-total" id="${eqId}-total">0 votos</div><button class="enquete-debate-toggle" onclick="toggleDebate('${eqId}')">💬 Ver debate (0)</button><div class="enquete-debate" id="${eqId}-debate"><div class="enquete-debate-titulo">Debate da enquete</div><div id="${eqId}-coments"></div><div class="enquete-debate-input-row"><input class="enquete-debate-input" id="${eqId}-debinput" placeholder="Argumente sua escolha..."><button class="enquete-debate-send" onclick="enviarDebate('${eqId}')">→</button></div></div></div><div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓</span></div></div>`;
    wrap.appendChild(div); wrap.scrollTop = wrap.scrollHeight;
    document.getElementById('fpEnquetePerg').value = '';
    inputs.forEach(i=>i.value='');
    fpToggleForm('enquete'); fecharPainel();
    mostrarToastDif('📊 Enquete publicada!','#4a80c0');
  }

  // ---- Indicador no botão ⋮ ----
  function atualizarBtnPainel() {
    const btn = document.getElementById('btnAbrirPainel');
    const temAtivo = modoFantasma || timerMsgAtivo;
    if (btn) btn.classList.toggle('has-active', temAtivo);
  }

  // =====================================================
  // ASSISTENTE S (IA)
  // =====================================================
  let modoAssistente = false;

  function abrirChatAssistente(el) {
    document.querySelectorAll('.contact-item').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    modoAssistente = true;
    mensagensFixadas = [];
    replyAtual = null;
    document.getElementById('replyPreview').classList.remove('visible');
    document.getElementById('pinnedBanner').classList.remove('visible');

    document.getElementById('chatName').textContent = 'Assistente S';
    const av = document.getElementById('chatAvatar');
    av.textContent = '🤖'; av.className = 'avatar-img';
    av.style.background = 'linear-gradient(135deg,#1a0808,#120d05)';
    av.style.color = 'var(--orange-soft)';
    av.style.borderColor = '#e8874a30';
    av.style.fontSize = '20px';

    const dot = document.getElementById('chatStatusDot');
    dot.className = 'status-dot online'; dot.style.background = 'var(--orange-soft)'; dot.style.boxShadow = '0 0 6px var(--orange-soft)';

    const statusEl = document.getElementById('chatStatus');
    statusEl.innerHTML = '<span style="color:var(--orange-soft)">✨ IA · Sempre disponível</span>';

    const typing = document.getElementById('typingAvatar');
    typing.textContent = '🤖'; typing.className = 'msg-avatar';
    typing.style.background = 'linear-gradient(135deg,#1a0808,#120d05)';
    typing.style.color = 'var(--orange-soft)';
    typing.style.fontSize = '14px';

    // Adicionar classe especial ao chat area
    document.querySelector('.chat-area').classList.add('assistente-mode');

    // Limpar e preencher mensagens do assistente
    const wrap = document.getElementById('messagesWrap');
    wrap.innerHTML = `<div class="date-sep"><span>Conversa com IA</span></div>
    <div class="msg in">
      <div class="msg-avatar" style="background:linear-gradient(135deg,#1a0808,#120d05);color:var(--orange-soft);border:1px solid #e8874a20;font-size:13px">🤖</div>
      <div>
        <div class="assistente-badge"><svg viewBox="0 0 24 24" stroke-width="1.8"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg> Assistente S · IA</div>
        <div class="msg-bubble assistente" onclick="mostrarReacoes(this)">
          Olá! Sou o <strong>Assistente S</strong>, sua IA integrada no S-Chat. ✨<br><br>
          Posso ajudar com perguntas, resumos, ideias, tradução e muito mais. Como posso te ajudar hoje?
          <div class="reaction-trigger" onclick="mostrarReacoes(this.parentElement)">😊 ···</div>
        </div>
        <div class="msg-footer"><span class="msg-time">${new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span></div>
      </div>
    </div>`;

    document.getElementById('welcome').classList.add('hidden');
    document.getElementById('chatContent').classList.add('visible');
    if (window.innerWidth <= 700) document.getElementById('sidebar').classList.add('hidden');
    document.getElementById('chatInput').placeholder = 'Pergunte algo ao Assistente S...';
    document.getElementById('chatInput').focus();
    fecharTudo();
  }

  const respostasIA = {
    padrão: [
      'Entendido! Deixa eu processar isso... 🤔',
      'Boa pergunta! Aqui está o que sei sobre isso:',
      'Com certeza posso ajudar com isso! ✅',
      'Interessante! Vou analisar e te dar uma resposta completa.',
    ],
    oi: ['Olá! Tudo bem? Como posso ajudar você hoje? 😊', 'Oi! Estou aqui e pronto para ajudar! ✨'],
    obrigado: ['De nada! É um prazer ajudar. 🙏', 'Por nada! Sempre à disposição no S-Chat. ✨'],
    ajuda: ['Posso ajudar com: ✅\n• Responder perguntas\n• Escrever textos\n• Resumir conteúdo\n• Traduzir idiomas\n• Dar ideias criativas\n• Analisar problemas\n\nO que você precisa?'],
    codigo: ['Claro! Posso ajudar com código. Qual linguagem e o que você precisa implementar? 💻'],
    traduz: ['Posso traduzir! Qual texto e para qual idioma? 🌍'],
    resumo: ['Me envie o texto e farei um resumo conciso e claro! 📝'],
  };

  function respostaDaIA(pergunta) {
    const p = pergunta.toLowerCase();
    if (p.includes('oi') || p.includes('olá') || p.includes('bom dia') || p.includes('boa tarde')) return respostasIA.oi[Math.floor(Math.random()*respostasIA.oi.length)];
    if (p.includes('obrigad')) return respostasIA.obrigado[Math.floor(Math.random()*respostasIA.obrigado.length)];
    if (p.includes('ajuda') || p.includes('pode') || p.includes('conseg')) return respostasIA.ajuda[0];
    if (p.includes('codi') || p.includes('progra') || p.includes('python') || p.includes('js') || p.includes('html')) return respostasIA.codigo[0];
    if (p.includes('traduz') || p.includes('inglês') || p.includes('espanho')) return respostasIA.traduz[0];
    if (p.includes('resum')) return respostasIA.resumo[0];
    return respostasIA.padrão[Math.floor(Math.random()*respostasIA.padrão.length)] + '\n\n"' + pergunta.slice(0,60) + (pergunta.length > 60 ? '...' : '') + '" — vou processar isso para você! 🤖';
  }

  // Override do enviarMensagem para suportar IA
  const _enviarBase = enviarMensagem;
  enviarMensagem = function() {
    if (!modoAssistente) { _enviarBase(); return; }
    const input = document.getElementById('chatInput');
    const texto = input.value.trim();
    if (!texto) return;
    const wrap = document.getElementById('messagesWrap');
    const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});

    // Mensagem do usuário
    const divUser = document.createElement('div');
    divUser.className = 'msg out';

    // Verificar reply
    let replyHtml = '';
    if (replyAtual) {
      replyHtml = `<div class="msg-reply-ref"><div class="msg-reply-ref-author">${replyAtual.autor}</div><div class="msg-reply-ref-text">${replyAtual.texto}</div></div>`;
      cancelarReply();
    }

    divUser.innerHTML = `<div>${replyHtml}<div class="msg-bubble" onclick="mostrarReacoes(this)">${texto.replace(/</g,'&lt;')}<div class="reaction-trigger" onclick="mostrarReacoes(this.parentElement)">😊 ···</div></div><div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓</span></div></div>`;
    wrap.appendChild(divUser); wrap.scrollTop = wrap.scrollHeight;
    input.value = ''; input.style.height = 'auto';

    // Digitando
    const typing = document.getElementById('typingIndicator');
    setTimeout(() => { typing.classList.add('visible'); wrap.scrollTop = wrap.scrollHeight; }, 500);
    setTimeout(() => {
      typing.classList.remove('visible');
      const divIA = document.createElement('div');
      divIA.className = 'msg in';
      const hora2 = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      const resposta = respostaDaIA(texto);
      divIA.innerHTML = `<div class="msg-avatar" style="background:linear-gradient(135deg,#1a0808,#120d05);color:var(--orange-soft);border:1px solid #e8874a20;font-size:13px">🤖</div>
        <div>
          <div class="assistente-badge"><svg viewBox="0 0 24 24" stroke-width="1.8"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg> Assistente S</div>
          <div class="msg-bubble assistente" onclick="mostrarReacoes(this)">${resposta.replace(/</g,'&lt;').replace(/\n/g,'<br>').replace(/•/g,'•')}<div class="reaction-trigger" onclick="mostrarReacoes(this.parentElement)">😊 ···</div></div>
          <div class="msg-footer"><span class="msg-time">${hora2}</span></div>
        </div>`;
      wrap.appendChild(divIA); wrap.scrollTop = wrap.scrollHeight;
      divUser.querySelector('.msg-check').textContent = '✓✓';
    }, 1500);
  };

  // =====================================================
  // REPLY DE MENSAGEM
  // =====================================================
  let replyAtual = null;

  function iniciarReply(bubbleEl, autor, texto) {
    replyAtual = { autor, texto };
    document.getElementById('replyAuthor').textContent = autor;
    document.getElementById('replyContent').textContent = texto.replace(/<[^>]+>/g,'').slice(0,80);
    document.getElementById('replyPreview').classList.add('visible');
    document.getElementById('chatInput').focus();
  }

  function cancelarReply() {
    replyAtual = null;
    document.getElementById('replyPreview').classList.remove('visible');
  }

  // Adicionar opção reply ao reaction trigger (clique longo)
  document.addEventListener('contextmenu', (e) => {
    const bubble = e.target.closest('.msg-bubble');
    if (!bubble) return;
    e.preventDefault();
    const msg = bubble.closest('.msg');
    const isOut = msg?.classList.contains('out');
    const autor = isOut ? 'Você' : (document.getElementById('chatName')?.textContent || 'Contato');
    const texto = bubble.textContent.replace(/😊 ···/g,'').trim().slice(0,60);
    mostrarMenuContexto(e, bubble, autor, texto);
  });

  function mostrarMenuContexto(e, bubble, autor, texto) {
    // Remover menu anterior
    document.getElementById('ctxMenu')?.remove();
    const menu = document.createElement('div');
    menu.id = 'ctxMenu';
    menu.style.cssText = `position:fixed;left:${Math.min(e.clientX,window.innerWidth-180)}px;top:${Math.min(e.clientY,window.innerHeight-160)}px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:6px;z-index:500;box-shadow:0 12px 40px #00000060;min-width:160px;animation:picker-in 0.15s ease both`;
    const acoes = [
      { icon:'↩️', label:'Responder', fn: `iniciarReply(null,'${autor.replace(/'/g,"\\'")}','${texto.replace(/'/g,"\\'").replace(/\n/g,' ')}')`  },
      { icon:'📌', label:'Fixar mensagem', fn: `fixarMensagem('${texto.replace(/'/g,"\\'").replace(/\n/g,' ')}')` },
      { icon:'📋', label:'Copiar texto', fn: `navigator.clipboard.writeText('${texto.replace(/'/g,"\\'")}')` },
      { icon:'😊', label:'Reagir', fn: `mostrarReacoes(document.querySelector('#ctxMenu').previousSibling||document.querySelector('.msg-bubble'))` },
    ];
    menu.innerHTML = acoes.map(a => `<div onclick="${a.fn};document.getElementById('ctxMenu')?.remove()" style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;font-size:13px;transition:background 0.15s" onmouseover="this.style.background='var(--bg-input)'" onmouseout="this.style.background=''">${a.icon} ${a.label}</div>`).join('');
    document.body.appendChild(menu);
    setTimeout(() => document.addEventListener('click', () => document.getElementById('ctxMenu')?.remove(), {once:true}), 100);
  }

  // Override enviarMensagem normal para suportar reply
  const _enviarComReply = enviarMensagem;
  if (!modoAssistente) {
    const __origEnviar = window.enviarMensagem;
    // Patch já aplicado acima via modoAssistente
  }

  // =====================================================
  // MENSAGENS FIXADAS
  // =====================================================
  let mensagensFixadas = [];
  let pinnedIndex = 0;

  window.mostrarMenuContexto = mostrarMenuContexto;
  function fixarMensagem(texto) {
    mensagensFixadas.push(texto.slice(0,80));
    pinnedIndex = mensagensFixadas.length - 1;
    atualizarPinnedBanner();
    mostrarToastDif('📌 Mensagem fixada', 'var(--orange-soft)');
  }

  function atualizarPinnedBanner() {
    const banner = document.getElementById('pinnedBanner');
    const content = document.getElementById('pinnedContent');
    const count = document.getElementById('pinnedCount');
    if (mensagensFixadas.length === 0) {
      banner.classList.remove('visible');
    } else {
      banner.classList.add('visible');
      content.textContent = mensagensFixadas[pinnedIndex] || '—';
      count.textContent = mensagensFixadas.length > 1 ? (pinnedIndex+1)+'/'+mensagensFixadas.length : '';
    }
  }

  function irParaMsgFixada() {
    pinnedIndex = (pinnedIndex + 1) % mensagensFixadas.length;
    atualizarPinnedBanner();
    mostrarToastDif('📌 Mensagem ' + (pinnedIndex+1) + ' de ' + mensagensFixadas.length, 'var(--orange-soft)');
  }

  // Adicionar botão "Novo contato" → Criar Grupo e Cofre no sidebar

  function verDetalhesContato() {
    if (!modoAssistente) window.location.href = 'schat-contato.html';
  }

  // Fechar painéis ao clicar fora
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#temaPanel') && !e.target.closest('[onclick*="toggleTemaPanel"]'))
      document.getElementById('temaPanel')?.classList.remove('open');
  }, true);


</script>

<!-- ========== OVERLAY + PAINEL LATERAL DE FEATURES ========== -->
<div class="features-overlay" id="featOverlay" onclick="fecharPainel()"></div>

<div class="features-panel" id="featPanel">

  <!-- Cabeçalho do painel -->
  <div class="fp-header">
    <div class="fp-header-avatar avatar-img c1" id="fpAvatar">AL</div>
    <div class="fp-header-info">
      <div class="fp-header-name" id="fpNome">Ana Lima</div>
      <div class="fp-header-sub">Ferramentas desta conversa</div>
    </div>
    <button class="fp-close" onclick="fecharPainel()">
      <svg viewBox="0 0 24 24" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18" stroke-linecap="round"/><line x1="6" y1="6" x2="18" y2="18" stroke-linecap="round"/></svg>
    </button>
  </div>

  <div class="fp-body">

    <!-- PRIVACIDADE -->
    <div class="fp-section">
      <div class="fp-section-title">🔒 Privacidade</div>
      <div class="fp-section-card">

        <!-- Modo Fantasma -->
        <div class="fp-item">
          <div class="fp-item-icon" style="background:#1a0a2a">👻</div>
          <div class="fp-item-info">
            <div class="fp-item-label">Modo Fantasma</div>
            <div class="fp-item-desc">Leia sem gerar confirmação de leitura</div>
          </div>
          <div class="fp-toggle" id="fpToggleFantasma" onclick="fpToggleGhost()">
            <div class="fp-toggle-thumb"></div>
          </div>
        </div>

        <!-- Timer de mensagem -->
        <div class="fp-item" style="flex-direction:column;align-items:flex-start;gap:8px;">
          <div style="display:flex;align-items:center;gap:12px;width:100%">
            <div class="fp-item-icon" style="background:#1a1208">⏱️</div>
            <div class="fp-item-info">
              <div class="fp-item-label">Auto-destruir mensagens</div>
              <div class="fp-item-desc" id="fpTimerDesc">Desativado</div>
            </div>
            <div class="fp-toggle" id="fpToggleTimer" onclick="fpToggleTimerSwitch()">
              <div class="fp-toggle-thumb"></div>
            </div>
          </div>
          <div class="fp-timer-grid" id="fpTimerGrid" style="display:none">
            <button class="fp-timer-opt" onclick="fpSetTimer(10,'10s')">10s</button>
            <button class="fp-timer-opt" onclick="fpSetTimer(30,'30s')">30s</button>
            <button class="fp-timer-opt" onclick="fpSetTimer(60,'1min')">1min</button>
            <button class="fp-timer-opt" onclick="fpSetTimer(300,'5min')">5min</button>
            <button class="fp-timer-opt" onclick="fpSetTimer(3600,'1h')">1h</button>
            <button class="fp-timer-opt" onclick="fpSetTimer(86400,'24h')">24h</button>
          </div>
        </div>

      </div>
    </div>

    <!-- PERSONALIZAÇÃO -->
    <div class="fp-section">
      <div class="fp-section-title">🎨 Personalização</div>
      <div class="fp-section-card">

        <!-- Tema por conversa -->
        <div class="fp-item" style="flex-direction:column;align-items:flex-start;gap:0;padding-bottom:0;">
          <div style="display:flex;align-items:center;gap:12px;width:100%;padding-bottom:10px">
            <div class="fp-item-icon" style="background:#180d20">🎨</div>
            <div class="fp-item-info">
              <div class="fp-item-label">Tema desta conversa</div>
              <div class="fp-item-desc" id="fpTemaDesc">Padrão (Laranja)</div>
            </div>
          </div>
          <div class="fp-tema-grid">
            <div class="fp-tema-opt selected" data-tema="" data-nome="Padrão" style="background:linear-gradient(135deg,#e8874a,#c05820)" onclick="fpSetTema(this)"></div>
            <div class="fp-tema-opt" data-tema="verde" data-nome="Verde" style="background:linear-gradient(135deg,#4a9e6a,#2d7a50)" onclick="fpSetTema(this)"></div>
            <div class="fp-tema-opt" data-tema="azul" data-nome="Azul" style="background:linear-gradient(135deg,#4a80c0,#2a5090)" onclick="fpSetTema(this)"></div>
            <div class="fp-tema-opt" data-tema="rosa" data-nome="Rosa" style="background:linear-gradient(135deg,#c04a8a,#902060)" onclick="fpSetTema(this)"></div>
            <div class="fp-tema-opt" data-tema="roxo" data-nome="Roxo" style="background:linear-gradient(135deg,#8a4ac0,#6030a0)" onclick="fpSetTema(this)"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- MENSAGENS ESPECIAIS -->
    <div class="fp-section">
      <div class="fp-section-title">✨ Mensagens Especiais</div>
      <div class="fp-section-card">

        <!-- Cápsula do Tempo -->
        <div class="fp-item clickable" id="fpItemCapsula" onclick="fpToggleForm('capsula')" style="flex-direction:column;align-items:flex-start;gap:8px;">
          <div style="display:flex;align-items:center;gap:12px;width:100%">
            <div class="fp-item-icon" style="background:#180820">💊</div>
            <div class="fp-item-info">
              <div class="fp-item-label">Cápsula do Tempo</div>
              <div class="fp-item-desc">Mensagem que abre numa data futura</div>
            </div>
            <svg style="width:14px;height:14px;stroke:var(--text-muted);fill:none;flex-shrink:0;transition:transform 0.2s" id="fpChevronCapsula" viewBox="0 0 24 24" stroke-width="2"><polyline points="6,9 12,15 18,9" stroke-linecap="round"/></svg>
          </div>
          <div class="fp-form" id="fpFormCapsula" style="display:none;width:100%;padding:0 0 4px">
            <textarea class="fp-input" id="fpCapsulaMsg" rows="2" placeholder="Mensagem para o futuro..."></textarea>
            <div class="fp-input-row">
              <input type="datetime-local" class="fp-input" id="fpCapsulaData" style="margin-bottom:0">
            </div>
            <button class="fp-btn fp-btn-purple" onclick="fpEnviarCapsula(event)">💊 Criar Cápsula</button>
          </div>
        </div>

        <!-- Lembrete -->
        <div class="fp-item clickable" id="fpItemLembrete" onclick="fpToggleForm('lembrete')" style="flex-direction:column;align-items:flex-start;gap:8px;">
          <div style="display:flex;align-items:center;gap:12px;width:100%">
            <div class="fp-item-icon" style="background:#0a1a0a">⏰</div>
            <div class="fp-item-info">
              <div class="fp-item-label">Lembrete</div>
              <div class="fp-item-desc">Notificação num horário específico</div>
            </div>
            <svg style="width:14px;height:14px;stroke:var(--text-muted);fill:none;flex-shrink:0;transition:transform 0.2s" id="fpChevronLembrete" viewBox="0 0 24 24" stroke-width="2"><polyline points="6,9 12,15 18,9" stroke-linecap="round"/></svg>
          </div>
          <div class="fp-form" id="fpFormLembrete" style="display:none;width:100%;padding:0 0 4px">
            <textarea class="fp-input" id="fpLembreteMsg" rows="2" placeholder="O que você quer ser lembrado?"></textarea>
            <div class="fp-input-row">
              <input type="datetime-local" class="fp-input" id="fpLembreteData" style="margin-bottom:0">
            </div>
            <button class="fp-btn fp-btn-green" onclick="fpEnviarLembrete(event)">⏰ Criar Lembrete</button>
          </div>
        </div>

      </div>
    </div>

    <!-- ENQUETE -->
    <div class="fp-section">
      <div class="fp-section-title">📊 Interatividade</div>
      <div class="fp-section-card">
        <div class="fp-item clickable" id="fpItemEnquete" onclick="fpToggleForm('enquete')" style="flex-direction:column;align-items:flex-start;gap:8px;">
          <div style="display:flex;align-items:center;gap:12px;width:100%">
            <div class="fp-item-icon" style="background:#081220">📊</div>
            <div class="fp-item-info">
              <div class="fp-item-label">Enquete com Debate</div>
              <div class="fp-item-desc">Votação + espaço de discussão</div>
            </div>
            <svg style="width:14px;height:14px;stroke:var(--text-muted);fill:none;flex-shrink:0;transition:transform 0.2s" id="fpChevronEnquete" viewBox="0 0 24 24" stroke-width="2"><polyline points="6,9 12,15 18,9" stroke-linecap="round"/></svg>
          </div>
          <div class="fp-form" id="fpFormEnquete" style="display:none;width:100%;padding:0 0 4px">
            <input class="fp-input" id="fpEnquetePerg" placeholder="Qual é a sua pergunta?">
            <div class="fp-enquete-opcoes" id="fpEnqueteOpts">
              <input class="fp-input" placeholder="Opção 1" style="margin-bottom:0">
              <input class="fp-input" placeholder="Opção 2" style="margin-bottom:0">
            </div>
            <button class="fp-enquete-add" onclick="fpAddOpcao(event)">+ Adicionar opção</button>
            <button class="fp-btn fp-btn-blue" onclick="fpEnviarEnquete(event)">📊 Publicar Enquete</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Notificação flutuante de lembrete -->
<div class="lembrete-notif" id="lembreteNotif">
  <div class="lembrete-notif-icon">⏰</div>
  <div class="lembrete-notif-text">
    <div class="lembrete-notif-title">Lembrete do S-Chat</div>
    <div class="lembrete-notif-msg" id="lembreteNotifMsg">—</div>
  </div>
  <button class="lembrete-notif-close" onclick="fecharNotifLembrete()">✕</button>
</div>


<!-- ══ MENTION POPUP ══ -->
<div class="mention-popup" id="mentionPopup"></div>

<!-- ══ MENTION CARD ══ -->
<div class="mention-card" id="mentionCard">
  <button class="mention-card-close" onclick="fecharMentionCard()">✕</button>
  <div class="mention-card-av c1" id="mcAv">?</div>
  <div class="mention-card-name" id="mcName">—</div>
  <div class="mention-card-status" id="mcStatus">—</div>
  <div class="mention-card-mood" id="mcMood">—</div>
</div>

<!-- ══ EDIT HISTORY ══ -->
<div class="edit-history-popup" id="editHistoryPopup">
  <button style="float:right;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px" onclick="fecharEditHistory()">✕</button>
  <div class="edit-history-title">Histórico de edições</div>
  <div id="editHistoryList"></div>
</div>

<!-- ══ CARD CREATOR ══ -->
<div class="card-creator" id="cardCreator" onclick="fecharCardCreator(event)">
  <div class="card-creator-panel" onclick="event.stopPropagation()">
    <h3>✦ Card Interativo</h3>
    <label>Ícone / Emoji</label>
    <input type="text" id="ccIcon" value="✨" maxlength="4" style="width:70px">
    <label>Título</label>
    <input type="text" id="ccTitle" placeholder="Ex: Proposta de projeto">
    <label>Mensagem</label>
    <textarea id="ccBody" placeholder="Detalhe aqui..."></textarea>
    <label>Cor do card</label>
    <div class="card-colors">
      <div class="card-color-opt selected" data-color="#1a0e08,#e8874a" style="background:linear-gradient(135deg,#2a1a08,#e8874a40)" onclick="selecionarCorCard(this)"></div>
      <div class="card-color-opt" data-color="#081a10,#4a9e6a" style="background:linear-gradient(135deg,#081a10,#4a9e6a40)" onclick="selecionarCorCard(this)"></div>
      <div class="card-color-opt" data-color="#08101a,#4a80c0" style="background:linear-gradient(135deg,#08101a,#4a80c040)" onclick="selecionarCorCard(this)"></div>
      <div class="card-color-opt" data-color="#1a0814,#c04a8a" style="background:linear-gradient(135deg,#1a0814,#c04a8a40)" onclick="selecionarCorCard(this)"></div>
      <div class="card-color-opt" data-color="#141208,#c0a030" style="background:linear-gradient(135deg,#141208,#c0a03040)" onclick="selecionarCorCard(this)"></div>
    </div>
    <div class="card-creator-actions">
      <button class="cc-btn cancel" onclick="fecharCardCreator()">Cancelar</button>
      <button class="cc-btn send" onclick="enviarCard()">Enviar Card ✦</button>
    </div>
  </div>
</div>

<!-- ══ SALA FLASH ══ -->
<div class="sala-flash-overlay" id="salaFlashOverlay" onclick="fecharSalaFlash(event)">
  <div class="sala-flash-panel" onclick="event.stopPropagation()">
    <div class="sf-title">⚡ Sala Flash</div>
    <div class="sf-sub">Sala temporária com código único — expira em 24h</div>
    <div class="sf-tabs">
      <div class="sf-tab active" id="sfTabCriar" onclick="sfMudarAba('criar')">Criar sala</div>
      <div class="sf-tab" id="sfTabEntrar" onclick="sfMudarAba('entrar')">Entrar com código</div>
    </div>
    <div id="sfConteudoCriar">
      <div class="sf-code-display" id="sfCodigoGerado">------</div>
      <div class="sf-expiry" id="sfExpiry">Expira em 24:00:00</div>
      <div class="sf-members" id="sfMembers">
        <div class="sf-member"><div class="sf-member-av">EU</div><div class="sf-member-name">Você <span style="color:var(--orange-soft);font-size:10px">· criador</span></div></div>
      </div>
    </div>
    <div id="sfConteudoEntrar" style="display:none">
      <input class="sf-input" id="sfCodigoInput" placeholder="000000" maxlength="6" oninput="this.value=this.value.replace(/\D/g,'')">
      <div style="font-size:11px;color:var(--text-muted);text-align:center;margin-top:8px">Digite o código de 6 dígitos</div>
    </div>
    <div class="sf-actions" style="margin-top:16px">
      <button class="sf-btn cancel" onclick="fecharSalaFlash()">Fechar</button>
      <button class="sf-btn primary" id="sfBtnAcao" onclick="sfAcao()">Copiar código ⚡</button>
    </div>
  </div>
</div>

<!-- ══ WRAP-UP SEMANAL ══ -->
<div class="wrapup-overlay" id="wrapupOverlay" onclick="fecharWrapup(event)">
  <div class="wrapup-panel" onclick="event.stopPropagation()">
    <div class="wrapup-week" id="wuSemana">SEMANA ATUAL</div>
    <div class="wrapup-title">Seu Resumo 🎉</div>
    <div class="wrapup-sub">Aqui está o que rolou na semana</div>
    <div class="wrapup-grid">
      <div class="wu-card"><div class="wu-icon">💬</div><div class="wu-label">Mensagens</div><div class="wu-value" id="wuMsgs">0</div><div class="wu-detail">enviadas</div></div>
      <div class="wu-card"><div class="wu-icon">👥</div><div class="wu-label">Contato top</div><div class="wu-value" id="wuTop" style="font-size:12px;padding-top:4px">Ana Lima</div><div class="wu-detail" id="wuTopMsgs">+ msgs</div></div>
      <div class="wu-card"><div class="wu-icon">🎵</div><div class="wu-label">Áudios</div><div class="wu-value" id="wuAudios">0</div><div class="wu-detail">enviados</div></div>
      <div class="wu-card"><div class="wu-icon">🏆</div><div class="wu-label">Emoji top</div><div class="wu-value" id="wuEmoji">🔥</div><div class="wu-detail">mais usado</div></div>
    </div>
    <div class="wrapup-highlight">
      <div class="wh-label">✦ Mensagem da semana</div>
      <div class="wh-text" id="wuMsgDestaque">"Carregando..."</div>
    </div>
    <button class="wrapup-close" onclick="fecharWrapup()">Fechar resumo ✓</button>
    <div class="wrapup-share" onclick="mostrarToastDif('📊 Compartilhado!','var(--orange-soft)')">Compartilhar resumo →</div>
  </div>
</div>

<!-- ══ FOCUS BANNER + VIGNETTE ══ -->
<div class="focus-vignette" id="focusVignette"></div>
<div class="focus-banner" id="focusBanner">
  <div class="focus-banner-left">
    <div class="focus-banner-icon">🎯</div>
    <div>
      <div class="focus-banner-text">Modo Foco ativo</div>
      <div class="focus-banner-sub">Notificações silenciadas</div>
    </div>
  </div>
  <div class="focus-timer" id="focusTimer">25:00</div>
  <button class="focus-end-btn" onclick="toggleFoco()">Encerrar</button>
</div>

<!-- ========== PUSH NOTIFICATIONS ========== -->
<div class="push-notif-container" id="pushNotifContainer"></div>

<!-- ========== TIMELINE DA AMIZADE ========== -->
<div class="timeline-overlay" id="timelineOverlay" onclick="fecharTimeline(event)">
  <div class="timeline-panel" onclick="event.stopPropagation()">
    <div class="timeline-header">
      <div>
        <div class="timeline-title" id="timelineTitle">📖 Linha do Tempo</div>
        <div class="timeline-subtitle" id="timelineSubtitle">Sua amizade em momentos</div>
      </div>
      <button class="timeline-close" onclick="fecharTimeline()">✕</button>
    </div>
    <div class="timeline-body" id="timelineBody">
      <!-- preenchido por JS -->
    </div>
  </div>
</div>

<!-- ========== VIDEO CALL EXPANDIDO ========== -->
<div class="video-call-overlay" id="videoCallOverlay">
  <div class="video-main" id="videoMain">
    <canvas class="video-cam-canvas" id="videoCamCanvas"></canvas>
    <div class="video-overlay-gradient"></div>
    <div class="video-remote-avatar c1" id="videoRemoteAvatar">AL</div>

    <!-- PiP câmera própria -->
    <div class="video-pip" id="videoPip">
      <canvas id="videoPipCanvas"></canvas>
      <div class="video-pip-label">Você</div>
    </div>

    <!-- Topbar -->
    <div class="video-topbar">
      <div>
        <div class="video-contact-name" id="videoContactName">Ana Lima</div>
        <div class="video-call-status" id="videoCallStatusText">📹 Vídeo chamada</div>
      </div>
      <div class="video-timer-top" id="videoTimerTop">0:00</div>
    </div>

    <!-- Controles -->
    <div class="video-controls">
      <div class="video-ctrl-group">
        <button class="video-ctrl-btn vcb-mute" id="vbMute" onclick="vToggleMute()" title="Mudo">
          <svg viewBox="0 0 24 24" stroke-linecap="round"><rect x="9" y="2" width="6" height="11" rx="3"/><path d="M19 10C19 14.4 15.4 18 11 18"/><line x1="3" y1="3" x2="21" y2="21"/></svg>
        </button>
        <span class="vcb-label">Mudo</span>
      </div>
      <div class="video-ctrl-group">
        <button class="video-ctrl-btn vcb-cam" id="vbCam" onclick="vToggleCam()" title="Câmera">
          <svg viewBox="0 0 24 24" stroke-linecap="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
        </button>
        <span class="vcb-label">Câmera</span>
      </div>
      <div class="video-ctrl-group">
        <button class="video-ctrl-btn vcb-end" onclick="encerrarVideoCall()" title="Encerrar">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M23.07 18.48l-4.14-4.14a2 2 0 0 0-2.82 0l-1.61 1.61C13.19 15.19 9.81 11.81 9.05 10.5l1.61-1.61a2 2 0 0 0 0-2.82L6.52.93A2 2 0 0 0 3.7.93L1.09 3.54C.04 4.59-.31 6.17.31 7.57c2.17 4.87 8.15 10.85 13.02 13.02 1.4.62 2.98.27 4.03-.78l2.61-2.61a2 2 0 0 0-.9-2.72z"/></svg>
        </button>
        <span class="vcb-label" style="color:#e08080">Encerrar</span>
      </div>
      <div class="video-ctrl-group">
        <button class="video-ctrl-btn vcb-flip" onclick="vFlipCamera()" title="Virar câmera">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
        </button>
        <span class="vcb-label">Virar</span>
      </div>
      <div class="video-ctrl-group">
        <button class="video-ctrl-btn vcb-speaker" id="vbSpeaker" onclick="vToggleSpeaker()" title="Alto-falante">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
        </button>
        <span class="vcb-label">Speaker</span>
      </div>
    </div>
  </div>
</div>

<!-- ========== JANELA DE CHAMADA FLUTUANTE ========== -->
<div class="call-incoming" id="callIncoming">
  <div class="call-incoming-avatar c1" id="callIncomingAvatar">AL</div>
  <div class="call-incoming-info">
    <div class="call-incoming-label">📞 Chamada recebida</div>
    <div class="call-incoming-name" id="callIncomingName">Ana Lima</div>
    <div class="call-incoming-type" id="callIncomingType">Chamada de voz</div>
  </div>
  <div class="call-incoming-actions">
    <button class="call-reject" onclick="rejeitarChamada()" title="Rejeitar">
      <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18" stroke-linecap="round"/><line x1="6" y1="6" x2="18" y2="18" stroke-linecap="round"/></svg>
    </button>
    <button class="call-accept" onclick="aceitarChamada()" title="Aceitar">
      <svg viewBox="0 0 24 24"><path d="M22 16.9V19.9C22 20.5 21.5 21 21 21C10 21 1 12 1 3C1 2.4 1.5 2 2.1 2H5.1C5.6 2 6 2.4 6.1 2.9L7.1 7.5C7.2 8 7 8.5 6.6 8.8L4.9 10.1C6.4 13.1 8.9 15.6 11.9 17.1L13.2 15.4C13.5 15 14 14.8 14.5 14.9L19.1 15.9C19.6 16 20 16.4 20 16.9H22Z" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
  </div>
</div>

<div class="call-window" id="callWindow">
  <div class="call-header">
    <div class="call-avatar c1" id="callWindowAvatar">AL</div>
    <div class="call-info">
      <div class="call-name" id="callWindowName">Ana Lima</div>
      <div class="call-status">
        <div class="call-pulse"></div>
        <span id="callWindowStatus">Em chamada</span>
      </div>
    </div>
    <div class="call-timer" id="callWindowTimer">0:00</div>
    <div class="call-window-controls">
      <button class="call-wc-btn call-wc-min" onclick="minimizarChamada()" title="Minimizar">−</button>
      <button class="call-wc-btn call-wc-close" onclick="encerrarChamada()" title="Encerrar">×</button>
    </div>
  </div>
  <div class="call-body" id="callBody">
    <div class="call-wave">
      <div class="call-wave-bar"></div>
      <div class="call-wave-bar"></div>
      <div class="call-wave-bar"></div>
      <div class="call-wave-bar"></div>
      <div class="call-wave-bar"></div>
      <div class="call-wave-bar"></div>
      <div class="call-wave-bar"></div>
      <div class="call-wave-bar"></div>
    </div>
    <div class="call-actions">
      <button class="call-action-btn call-btn-mute" id="callBtnMute" onclick="toggleMute()" title="Mudo">
        <svg viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="11" rx="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 10C19 14.4 15.4 18 11 18" stroke-linecap="round" stroke-linejoin="round"/><line x1="3" y1="3" x2="21" y2="21" stroke-linecap="round"/></svg>
      </button>
      <button class="call-action-btn call-btn-end" onclick="encerrarChamada()" title="Encerrar chamada">
        <svg viewBox="0 0 24 24"><path d="M23.07 18.48l-4.14-4.14a2 2 0 0 0-2.82 0l-1.61 1.61C13.19 15.19 9.81 11.81 9.05 10.5l1.61-1.61a2 2 0 0 0 0-2.82L6.52.93A2 2 0 0 0 3.7.93L1.09 3.54C.04 4.59-.31 6.17.31 7.57c2.17 4.87 8.15 10.85 13.02 13.02 1.4.62 2.98.27 4.03-.78l2.61-2.61a2 2 0 0 0-.9-2.72z" stroke-linecap="round"/></svg>
      </button>
      <button class="call-action-btn call-btn-speaker" id="callBtnSpeaker" onclick="toggleSpeaker()" title="Alto-falante">
        <svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
  // =====================================================
  // CHAMADA FLUTUANTE
  // =====================================================
  let callInterval = null;
  let callSeconds = 0;
  let isMuted = false;
  let isSpeaker = false;
  let callMinimized = false;

  function iniciarChamada(tipo = 'voz') {
    const nome = document.getElementById('chatName')?.textContent || 'Contato';
    const av = document.getElementById('chatAvatar');
    const iniciais = av?.textContent || '?';
    const cor = av?.className.replace('avatar-img ', '') || 'c1';

    document.getElementById('callWindowAvatar').textContent = iniciais;
    document.getElementById('callWindowAvatar').className = 'call-avatar ' + cor;
    document.getElementById('callWindowName').textContent = nome;
    document.getElementById('callWindowStatus').textContent = tipo === 'video' ? '📹 Vídeo chamada' : '📞 Em chamada';

    callSeconds = 0;
    document.getElementById('callWindowTimer').textContent = '0:00';
    callInterval = setInterval(() => {
      callSeconds++;
      const m = Math.floor(callSeconds / 60);
      const s = (callSeconds % 60).toString().padStart(2, '0');
      document.getElementById('callWindowTimer').textContent = m + ':' + s;
    }, 1000);

    document.getElementById('callWindow').classList.add('visible');
    mostrarToastDif('📞 Chamada iniciada com ' + nome, 'var(--green-online)');
  }

  function encerrarChamada() {
    clearInterval(callInterval);
    const win = document.getElementById('callWindow');
    win.style.animation = 'call-slide-in 0.25s cubic-bezier(0.16,1,0.3,1) reverse both';
    setTimeout(() => {
      win.classList.remove('visible');
      win.style.animation = '';
      isMuted = false; isSpeaker = false;
      document.getElementById('callBtnMute').classList.remove('active');
      document.getElementById('callBtnSpeaker').classList.remove('active');
      document.querySelectorAll('.call-wave-bar').forEach(b => b.classList.remove('muted'));
    }, 240);
  }

  function minimizarChamada() {
    const body = document.getElementById('callBody');
    const btn = document.querySelector('.call-wc-min');
    callMinimized = !callMinimized;
    body.style.display = callMinimized ? 'none' : 'flex';
    btn.textContent = callMinimized ? '+' : '−';
  }

  function toggleMute() {
    isMuted = !isMuted;
    document.getElementById('callBtnMute').classList.toggle('active', isMuted);
    document.querySelectorAll('.call-wave-bar').forEach(b => b.classList.toggle('muted', isMuted));
    mostrarToastDif(isMuted ? '🎙️ Microfone desativado' : '🎙️ Microfone ativado', isMuted ? '#c05050' : '#4a9e6a');
  }

  function toggleSpeaker() {
    isSpeaker = !isSpeaker;
    document.getElementById('callBtnSpeaker').classList.toggle('active', isSpeaker);
    mostrarToastDif(isSpeaker ? '🔊 Alto-falante ligado' : '🔊 Alto-falante desligado', isSpeaker ? 'var(--orange-soft)' : 'var(--text-muted)');
  }

  // Simular chamada recebida (demo)
  function simularChamadaRecebida(tipo = 'voz') {
    const nome = document.getElementById('chatName')?.textContent || 'Ana Lima';
    const av = document.getElementById('chatAvatar');
    document.getElementById('callIncomingAvatar').textContent = av?.textContent || 'AL';
    document.getElementById('callIncomingAvatar').className = 'call-incoming-avatar ' + (av?.className.replace('avatar-img ','') || 'c1');
    document.getElementById('callIncomingName').textContent = nome;
    document.getElementById('callIncomingType').textContent = tipo === 'video' ? '📹 Chamada de vídeo' : '📞 Chamada de voz';
    document.getElementById('callIncoming').classList.add('show');
  }

  function aceitarChamada() {
    document.getElementById('callIncoming').classList.remove('show');
    iniciarChamada();
  }

  function rejeitarChamada() {
    document.getElementById('callIncoming').classList.remove('show');
    mostrarToastDif('📵 Chamada recusada', '#c05050');
  }

  // Conectar botões de chamada no header
  document.addEventListener('DOMContentLoaded', () => {});
  // Hook nos botões de chamada existentes no header
  setTimeout(() => {
    const btns = document.querySelectorAll('.chat-header-actions .icon-btn');
    btns.forEach(btn => {
      const title = btn.getAttribute('title');
      if (title === 'Chamada de voz') {
        btn.addEventListener('click', () => {
          if (document.getElementById('chatContent').classList.contains('visible')) {
            simularChamadaRecebida('voz');
          }
        });
      } else if (title === 'Chamada de vídeo') {
        btn.addEventListener('click', () => {
          if (document.getElementById('chatContent').classList.contains('visible')) {
            simularChamadaRecebida('video');
          }
        });
      }
    });
  }, 100);
</script>

<script>
// =====================================================
// VIDEO CALL EXPANDIDO
// =====================================================
let videoCallInterval = null;
let videoSeconds = 0;
let vMuted = false, vCamOn = true, vSpeakerOn = true;
let videoCanvas, videoCtx, pipCanvas, pipCtx;
let videoAnimFrame;
let hue = 0;

function iniciarVideoCall(tipo = 'video') {
  const nome = document.getElementById('chatName')?.textContent || 'Contato';
  const av = document.getElementById('chatAvatar');
  const iniciais = av?.textContent || '?';
  const cor = av?.className.replace('avatar-img ', '') || 'c1';

  document.getElementById('videoContactName').textContent = nome;
  document.getElementById('videoCallStatusText').textContent = tipo === 'video' ? '📹 Vídeo chamada' : '📞 Em chamada';
  document.getElementById('videoRemoteAvatar').textContent = iniciais;
  document.getElementById('videoRemoteAvatar').className = 'video-remote-avatar ' + cor;

  videoSeconds = 0;
  document.getElementById('videoTimerTop').textContent = '0:00';
  videoCallInterval = setInterval(() => {
    videoSeconds++;
    const m = Math.floor(videoSeconds / 60);
    const s = (videoSeconds % 60).toString().padStart(2, '0');
    document.getElementById('videoTimerTop').textContent = m + ':' + s;
  }, 1000);

  vMuted = false; vCamOn = true; vSpeakerOn = true;
  document.getElementById('vbMute').classList.remove('toggled');
  document.getElementById('vbCam').classList.remove('toggled');
  document.getElementById('vbSpeaker').classList.remove('toggled');

  const overlay = document.getElementById('videoCallOverlay');
  overlay.classList.add('visible');

  // Iniciar canvas animados
  initVideoCanvas();
}

function initVideoCanvas() {
  videoCanvas = document.getElementById('videoCamCanvas');
  videoCtx = videoCanvas.getContext('2d');
  pipCanvas = document.getElementById('videoPipCanvas');
  pipCtx = pipCanvas.getContext('2d');

  function resizeCanvas() {
    const vMain = document.getElementById('videoMain');
    videoCanvas.width = vMain.offsetWidth;
    videoCanvas.height = vMain.offsetHeight;
    pipCanvas.width = 110;
    pipCanvas.height = 150;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  animateVideoCanvas();
}

function animateVideoCanvas() {
  if (!document.getElementById('videoCallOverlay').classList.contains('visible')) return;
  hue = (hue + 0.3) % 360;
  const W = videoCanvas.width, H = videoCanvas.height;

  // Fundo do interlocutor (simulado)
  const grd = videoCtx.createRadialGradient(W*0.5, H*0.4, 0, W*0.5, H*0.4, W*0.7);
  grd.addColorStop(0, `hsla(${(hue+180)%360},30%,12%,1)`);
  grd.addColorStop(1, '#030303');
  videoCtx.fillStyle = grd;
  videoCtx.fillRect(0, 0, W, H);

  // Partículas ambiente
  const t = Date.now() * 0.001;
  for (let i = 0; i < 6; i++) {
    const x = W * 0.5 + Math.cos(t * 0.5 + i * 1.05) * W * 0.3;
    const y = H * 0.4 + Math.sin(t * 0.7 + i * 1.3) * H * 0.25;
    const g2 = videoCtx.createRadialGradient(x, y, 0, x, y, 80);
    g2.addColorStop(0, `hsla(${hue + i * 30},70%,60%,0.06)`);
    g2.addColorStop(1, 'transparent');
    videoCtx.fillStyle = g2;
    videoCtx.fillRect(0, 0, W, H);
  }

  // PiP — câmera própria simulada (verde esverdeado — like a real camera)
  if (vCamOn) {
    const pg = pipCtx.createLinearGradient(0, 0, 0, 150);
    pg.addColorStop(0, `hsl(${(hue+120)%360},40%,18%)`);
    pg.addColorStop(1, `hsl(${(hue+140)%360},30%,10%)`);
    pipCtx.fillStyle = pg;
    pipCtx.fillRect(0, 0, 110, 150);
    // Silhueta simples
    pipCtx.fillStyle = `hsla(${(hue+120)%360},50%,35%,0.5)`;
    pipCtx.beginPath();
    pipCtx.ellipse(55, 55, 22, 22, 0, 0, Math.PI*2);
    pipCtx.fill();
    pipCtx.beginPath();
    pipCtx.ellipse(55, 110, 38, 55, 0, 0, Math.PI*2);
    pipCtx.fill();
    document.getElementById('videoPip').style.display = '';
  } else {
    pipCtx.fillStyle = '#111';
    pipCtx.fillRect(0, 0, 110, 150);
    pipCtx.fillStyle = 'rgba(255,255,255,0.3)';
    pipCtx.font = '28px sans-serif';
    pipCtx.textAlign = 'center';
    pipCtx.fillText('📵', 55, 85);
    document.getElementById('videoPip').style.display = '';
  }

  videoAnimFrame = requestAnimationFrame(animateVideoCanvas);
}

function encerrarVideoCall() {
  clearInterval(videoCallInterval);
  cancelAnimationFrame(videoAnimFrame);
  const overlay = document.getElementById('videoCallOverlay');
  overlay.style.opacity = '0';
  overlay.style.transform = 'scale(1.03)';
  overlay.style.transition = 'opacity 0.3s, transform 0.3s';
  setTimeout(() => {
    overlay.classList.remove('visible');
    overlay.style.opacity = '';
    overlay.style.transform = '';
    overlay.style.transition = '';
  }, 300);
  mostrarToastDif('📹 Chamada de vídeo encerrada', '#c05050');
}

function vToggleMute() {
  vMuted = !vMuted;
  document.getElementById('vbMute').classList.toggle('toggled', vMuted);
  mostrarToastDif(vMuted ? '🎙️ Microfone desativado' : '🎙️ Microfone ativado', vMuted ? '#c05050' : '#4a9e6a');
}
function vToggleCam() {
  vCamOn = !vCamOn;
  document.getElementById('vbCam').classList.toggle('toggled', !vCamOn);
  mostrarToastDif(vCamOn ? '📹 Câmera ligada' : '📷 Câmera desligada', vCamOn ? '#4a9e6a' : '#c05050');
}
function vToggleSpeaker() {
  vSpeakerOn = !vSpeakerOn;
  document.getElementById('vbSpeaker').classList.toggle('toggled', !vSpeakerOn);
  mostrarToastDif(vSpeakerOn ? '🔊 Alto-falante ligado' : '🔇 Alto-falante desligado', vSpeakerOn ? 'var(--orange-soft)' : 'var(--text-muted)');
}
function vFlipCamera() {
  document.getElementById('videoPip').style.transform = 'scaleX(-1)';
  setTimeout(() => document.getElementById('videoPip').style.transform = '', 400);
  mostrarToastDif('📷 Câmera invertida', 'var(--text-secondary)');
}

// Override: ao clicar em chamada de vídeo, abre o overlay de vídeo
setTimeout(() => {
  document.querySelectorAll('.chat-header-actions .icon-btn').forEach(btn => {
    if (btn.getAttribute('title') === 'Chamada de vídeo') {
      // remove listeners antigos clonando
      const novo = btn.cloneNode(true);
      btn.parentNode.replaceChild(novo, btn);
      novo.addEventListener('click', () => {
        if (document.getElementById('chatContent')?.classList.contains('visible')) {
          iniciarVideoCall('video');
        }
      });
    }
  });
}, 200);
</script>

<script>
// =====================================================
// PUSH NOTIFICATIONS VISUAIS
// =====================================================
const pushQueue = [];
let pushActive = 0;

const pushDemos = [
  { sender: 'Ana Lima', avatar: 'AL', cor: 'c1', msg: 'Oi! Tudo bem? 😊', tipo: 'msg' },
  { sender: 'Carlos Souza', avatar: 'CS', cor: 'c2', msg: 'Você viu o projeto novo?', tipo: 'msg' },
  { sender: 'Beatriz Ramos', avatar: 'BR', cor: 'c3', msg: 'Manda o arquivo aqui 📎', tipo: 'msg' },
  { sender: 'Grupo Trabalho', avatar: 'GT', cor: 'c4', msg: 'Lucas: Reunião às 15h confirmada ✓', tipo: 'grupo' },
  { sender: 'Ana Lima', avatar: 'AL', cor: 'c1', msg: '📞 Chamada de vídeo perdida', tipo: 'call' },
];

function showPushNotif(data) {
  const container = document.getElementById('pushNotifContainer');
  const id = 'pn-' + Date.now();
  const now = new Date();
  const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

  const el = document.createElement('div');
  el.className = 'push-notif';
  el.id = id;
  el.innerHTML = `
    <div class="push-notif-avatar ${data.cor}">${data.avatar}</div>
    <div class="push-notif-body">
      <div class="push-notif-header">
        <span class="push-notif-sender">${data.sender}</span>
        <span class="push-notif-time">${timeStr}</span>
      </div>
      <div class="push-notif-app">S-Chat</div>
      <div class="push-notif-text">${data.msg}</div>
      ${data.tipo === 'call' ? `
        <div class="push-notif-actions">
          <button class="push-notif-btn" onclick="dismissPush('${id}')">Ignorar</button>
          <button class="push-notif-btn primary" onclick="aceitarChamada(); dismissPush('${id}')">Ligar</button>
        </div>` : `
        <div class="push-notif-actions">
          <button class="push-notif-btn" onclick="dismissPush('${id}')">Ignorar</button>
          <button class="push-notif-btn primary" onclick="dismissPush('${id}')">Responder</button>
        </div>`}
    </div>
    <button class="push-notif-dismiss" onclick="dismissPush('${id}')">✕</button>
    <div class="push-notif-progress"></div>
  `;

  container.appendChild(el);
  requestAnimationFrame(() => {
    requestAnimationFrame(() => el.classList.add('in'));
  });

  // Auto-dismiss após 6s
  setTimeout(() => dismissPush(id), 6500);
}

function dismissPush(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('in');
  el.classList.add('out');
  setTimeout(() => el.remove(), 400);
}

// Demo: dispara notificações automáticas para mostrar o sistema
(function scheduleNotifs() {
  let idx = 0;
  const times = [3000, 9000, 16000, 25000, 35000];
  times.forEach((delay, i) => {
    setTimeout(() => {
      showPushNotif(pushDemos[i % pushDemos.length]);
    }, delay);
  });
})();

// Expor para uso externo
window.showPushNotif = showPushNotif;
</script>

<script>
// =====================================================
// ANIMAÇÕES EXTRA NA SIDEBAR
// =====================================================
(function initSidebarAnimations() {
  // Ripple ao clicar em contatos
  document.addEventListener('click', function(e) {
    const item = e.target.closest('.contact-item');
    if (!item) return;
    const rect = item.getBoundingClientRect();
    const ripple = document.createElement('span');
    ripple.style.cssText = `
      position:absolute;
      border-radius:50%;
      background:rgba(232,135,74,0.15);
      width:10px; height:10px;
      left:${e.clientX - rect.left - 5}px;
      top:${e.clientY - rect.top - 5}px;
      transform:scale(0);
      transition:transform 0.5s ease, opacity 0.5s ease;
      pointer-events:none;
      z-index:0;
    `;
    item.style.position = 'relative';
    item.style.overflow = 'hidden';
    item.appendChild(ripple);
    requestAnimationFrame(() => {
      ripple.style.transform = 'scale(30)';
      ripple.style.opacity = '0';
    });
    setTimeout(() => ripple.remove(), 520);
  });

  // Stagger ao carregar — items aparecem em sequência
  const items = document.querySelectorAll('.contact-item');
  items.forEach((item, i) => {
    item.style.opacity = '0';
    item.style.transform = 'translateX(-12px)';
    item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    setTimeout(() => {
      item.style.opacity = '';
      item.style.transform = '';
    }, 80 + i * 40);
  });

  // Bounce no badge de notificação ao aparecer
  const observer = new MutationObserver(mutations => {
    mutations.forEach(m => {
      m.addedNodes.forEach(node => {
        if (node.classList && node.classList.contains('contact-badge')) {
          node.style.animation = 'none';
          node.style.transform = 'scale(0)';
          requestAnimationFrame(() => {
            node.style.transition = 'transform 0.3s cubic-bezier(0.34,1.56,0.64,1)';
            node.style.transform = 'scale(1)';
          });
        }
      });
    });
  });
  observer.observe(document.getElementById('sidebar') || document.body, { childList: true, subtree: true });
})();
</script>

<script>
// =====================================================
// UPGRADE 1: AUTODESTRUIÇÃO VISUAL (POEIRA) 
// =====================================================

// Adicionar botão de autodestruição no painel de ferramentas
// Quando ativo, mensagens enviadas ganham timer visual

let autoDestructActive = false;
let autoDestructSeconds = 10;

function ativarAutodestruct(seg) {
  autoDestructActive = true;
  autoDestructSeconds = seg;
  mostrarToastDif('💥 Autodestruição em ' + seg + 's ativada', 'var(--orange-soft)');
}

function desativarAutodestruct() {
  autoDestructActive = false;
  mostrarToastDif('💥 Autodestruição desativada', 'var(--text-muted)');
}

function dispararPoeira(el) {
  const rect = el.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  const cores = ['#e8874a','#c05820','#f0a070','#ffd0a0','#8a4020','#e8874a60'];

  // Cria entre 40 e 70 partículas
  const qtd = 50 + Math.floor(Math.random()*20);
  for (let i = 0; i < qtd; i++) {
    const p = document.createElement('div');
    p.className = 'dust-particle';
    const size = 2 + Math.random() * 6;
    const angle = Math.random() * Math.PI * 2;
    const dist = 40 + Math.random() * 120;
    const tx = Math.cos(angle) * dist;
    const ty = Math.sin(angle) * dist - Math.random() * 40;
    const dur = 0.5 + Math.random() * 0.8;
    const cor = cores[Math.floor(Math.random() * cores.length)];
    p.style.cssText = `
      width:${size}px;height:${size}px;
      left:${cx + (Math.random()-0.5)*rect.width}px;
      top:${cy + (Math.random()-0.5)*rect.height}px;
      background:${cor};
      --tx:${tx}px;--ty:${ty}px;--dur:${dur}s;
    `;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), dur * 1000 + 100);
  }

  // Anima e remove a mensagem
  el.style.transition = 'opacity 0.4s ease, transform 0.4s ease, max-height 0.4s ease, padding 0.4s ease, margin 0.4s ease';
  el.style.opacity = '0';
  el.style.transform = 'scale(0.8)';
  el.style.maxHeight = '0';
  el.style.overflow = 'hidden';
  el.style.padding = '0';
  el.style.margin = '0';
  setTimeout(() => el.remove(), 450);
}

function aplicarAutoDestructMsg(msgEl, segundos) {
  const bubble = msgEl.querySelector('.msg-bubble');
  if (!bubble) return;

  bubble.classList.add('autodestruct');
  
  // Criar anel de progresso e badge
  const ring = document.createElement('div');
  ring.className = 'autodestruct-ring';
  bubble.appendChild(ring);

  // Badge com timer
  const footer = msgEl.querySelector('.msg-footer');
  const badge = document.createElement('span');
  badge.className = 'autodestruct-badge';
  badge.title = 'Mensagem com autodestruição';
  let remaining = segundos;
  badge.innerHTML = `<span class="ad-icon">💥</span> <span class="ad-timer">${remaining}s</span>`;
  if (footer) footer.appendChild(badge);

  // Atualizar progresso do anel
  let pct = 100;
  const interval = setInterval(() => {
    remaining--;
    pct = (remaining / segundos) * 100;
    // Atualiza anel (background conic)
    ring.style.background = `conic-gradient(var(--orange-soft) ${pct}%, transparent ${pct}%) border-box`;
    const timerEl = badge.querySelector('.ad-timer');
    if (timerEl) timerEl.textContent = remaining + 's';

    if (remaining <= 3) {
      badge.style.color = '#e05050';
      badge.style.borderColor = 'rgba(224,80,80,0.4)';
      bubble.style.opacity = '0.7';
    }

    if (remaining <= 0) {
      clearInterval(interval);
      dispararPoeira(msgEl);
    }
  }, 1000);
}

// Expor globalmente para uso no enviarMensagem
window.autoDestructActive = false;
window.autoDestructSeconds = 10;
window.aplicarAutoDestructMsg = aplicarAutoDestructMsg;

// Hook no enviarMensagem para checar autodestruição
const _origEnviar = window.enviarMensagem;
// Nota: o hook é feito pela função enviarMensagem já existente — 
// verificamos autoDestructActive após criar a msg
// Usaremos MutationObserver para pegar msgs novas
const msgObserver = new MutationObserver(mutations => {
  mutations.forEach(m => {
    m.addedNodes.forEach(node => {
      if (node.classList && node.classList.contains('msg') && node.classList.contains('out')) {
        if (window.autoDestructActive) {
          setTimeout(() => aplicarAutoDestructMsg(node, window.autoDestructSeconds || 10), 300);
        }
      }
    });
  });
});
const mw = document.getElementById('messagesWrap');
if (mw) msgObserver.observe(mw, { childList: true });

// Adicionar opções de autodestruição no painel de ferramentas extra
setTimeout(() => {
  const painel = document.getElementById('fpanel') || document.querySelector('.fp-body');
  if (!painel) return;
  // Cria seção no painel flutuante
  const sec = document.createElement('div');
  sec.innerHTML = `
    <div class="fp-section-title" style="color:var(--orange-soft)">💥 Autodestruição</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">
      <button class="fp-tag" onclick="window.autoDestructActive=true;window.autoDestructSeconds=10;mostrarToastDif('💥 Mensagens explodem em 10s','var(--orange-soft)')">10s</button>
      <button class="fp-tag" onclick="window.autoDestructActive=true;window.autoDestructSeconds=30;mostrarToastDif('💥 Mensagens explodem em 30s','var(--orange-soft)')">30s</button>
      <button class="fp-tag" onclick="window.autoDestructActive=true;window.autoDestructSeconds=60;mostrarToastDif('💥 Mensagens explodem em 60s','var(--orange-soft)')">1min</button>
      <button class="fp-tag" onclick="window.autoDestructActive=false;mostrarToastDif('💥 Autodestruição off','var(--text-muted)')">Desligar</button>
    </div>
  `;
  painel.appendChild(sec);
}, 500);
</script>

<script>
// =====================================================
// UPGRADE 2: MODO FANTASMA (melhorado)
// =====================================================
// Já existe no código, apenas adicionamos o ghost no status label
function atualizarGhostUI() {
  const lbl = document.getElementById('ghostStatusLabel');
  const banner = document.getElementById('ghostBanner');
  const badge = document.getElementById('moodBadge');
  if (window.ghostMode) {
    if (lbl) { lbl.textContent = '👻 Modo Fantasma'; lbl.style.color = 'var(--orange-soft)'; }
    if (badge) badge.classList.add('ghost-pulse');
  } else {
    if (lbl) { lbl.textContent = '● Online'; lbl.style.color = 'var(--green-online)'; }
    if (badge) badge.classList.remove('ghost-pulse');
  }
}
// Sobrescrever toggleFantasma para incluir update UI
const _origToggleFantasma = window.toggleFantasma;
window.toggleFantasma = function() {
  if (_origToggleFantasma) _origToggleFantasma();
  setTimeout(atualizarGhostUI, 50);
};
</script>

<script>
// =====================================================
// UPGRADE 3: EMOJI CONTEXTUAL COM SUGESTÕES INTELIGENTES
// =====================================================

const emojiContextMap = {
  // Palavras-chave -> emojis sugeridos
  'saudade': ['🥺','💙','🫂','😢','❤️'],
  'amor': ['❤️','😍','💕','🥰','💋'],
  'bom dia': ['☀️','🌅','😊','☕','✨'],
  'boa noite': ['🌙','😴','💤','⭐','🌟'],
  'parabéns': ['🎉','🎂','🥳','🎁','🎊'],
  'obrigado': ['🙏','😊','❤️','✨','👏'],
  'trabalho': ['💻','😤','☕','📊','🏋️'],
  'game': ['🎮','👾','🕹️','🏆','🔥'],
  'música': ['🎵','🎶','🎸','🎧','🎤'],
  'comida': ['🍕','🍔','😋','🍝','🤤'],
  'engraçado': ['😂','🤣','💀','😭','😅'],
  'triste': ['😢','💔','🥺','😔','🫂'],
  'ansioso': ['😰','😬','🤔','💭','😤'],
  'feliz': ['😊','🥳','🎉','✨','💃'],
  'cansado': ['😴','💤','☕','🥱','😮‍💨'],
  'top': ['🔥','💯','👏','✨','🚀'],
  'que': ['🤔','💭','❓','🧐','😮'],
  'oi': ['👋','😊','✨','🤗','💙'],
  'não': ['😅','🙅','💀','😬','🫠'],
  'sim': ['✅','👍','💯','😊','🔥'],
  'legal': ['🔥','💯','😎','✨','👏'],
};

const emojiPadrao = ['😊','😂','❤️','🔥','👍','🎉','😎','🤔','🫂','💯'];

function getSugestoesEmoji(texto) {
  if (!texto || texto.length < 2) return emojiPadrao;
  const lower = texto.toLowerCase();
  
  // Verifica todas as palavras chave
  for (const [palavra, emojis] of Object.entries(emojiContextMap)) {
    if (lower.includes(palavra)) return emojis;
  }
  
  // Analisa tom geral da última mensagem recebida
  const msgs = document.querySelectorAll('#messagesWrap .msg.in .msg-bubble');
  if (msgs.length > 0) {
    const ultima = msgs[msgs.length - 1].textContent.toLowerCase();
    for (const [palavra, emojis] of Object.entries(emojiContextMap)) {
      if (ultima.includes(palavra)) return emojis;
    }
  }
  
  return emojiPadrao;
}

function atualizarEmojiContextual() {
  const input = document.getElementById('chatInput');
  const texto = input ? input.value : '';
  const sugestoes = getSugestoesEmoji(texto);
  
  const row = document.getElementById('emojiCtxSuggestions');
  const label = document.getElementById('emojiCtxLabel');
  if (!row) return;
  
  // Determinar label contextual
  const ctx = texto.length > 2 ? 'Para "' + texto.slice(-20) + '"' : 'Sugestões desta conversa';
  if (label) label.textContent = ctx;
  
  row.innerHTML = '';
  sugestoes.forEach((emoji, i) => {
    const btn = document.createElement('button');
    btn.className = 'emoji-ctx-btn' + (i === 0 ? ' top-suggestion' : '');
    btn.textContent = emoji;
    btn.onclick = () => { inserirEmoji(emoji); };
    btn.style.animationDelay = (i * 0.03) + 's';
    btn.style.animation = 'humor-fade 0.3s ease both';
    btn.style.animationDelay = (i * 0.04) + 's';
    row.appendChild(btn);
  });
}

// Override da função toggleEmoji para usar o contextual
window.toggleEmoji = function() {
  const picker = document.getElementById('emojiContextual');
  const oldPicker = document.getElementById('emojiPicker');
  if (!picker) return;
  
  emojiAberto = !emojiAberto;
  picker.classList.toggle('visible', emojiAberto);
  if (oldPicker) oldPicker.classList.remove('open');
  
  if (emojiAberto) {
    atualizarEmojiContextual();
    // Fechar ao clicar fora
    setTimeout(() => {
      document.addEventListener('click', fecharEmojiContextual, { once: true });
    }, 100);
  }
};

function fecharEmojiContextual(e) {
  const picker = document.getElementById('emojiContextual');
  if (picker && !picker.contains(e.target)) {
    picker.classList.remove('visible');
    emojiAberto = false;
  }
}

// Atualizar sugestões enquanto digita
const inputEl = document.getElementById('chatInput');
if (inputEl) {
  inputEl.addEventListener('input', () => {
    if (emojiAberto) atualizarEmojiContextual();
  });
}

// Fechar contextual ao fechar tudo
const _origFecharTudo = window.fecharTudo;
window.fecharTudo = function() {
  if (_origFecharTudo) _origFecharTudo();
  const picker = document.getElementById('emojiContextual');
  if (picker) picker.classList.remove('visible');
  emojiAberto = false;
};
</script>

<script>
// =====================================================
// UPGRADE 4: BOLHA DE DIGITAÇÃO COM HUMOR
// =====================================================

const humorFrases = [
  { delay: 0,    text: '' },              // normal: só bolinhas
  { delay: 4000, text: 'ainda escrevendo... ✍️' },
  { delay: 7000, text: 'mudou de ideia? 👀' },
  { delay: 10000,text: 'tomando um café ☕' },
  { delay: 14000,text: 'reescrevendo tudo 😅' },
  { delay: 18000,text: 'vai que é long 📜' },
  { delay: 22000,text: 'dedicação total 🔥' },
];

let typingHumorTimer = null;
let typingHumorIdx = 0;
let typingHumorVisible = false;

function mostrarTypingHumor(nomeContato) {
  const indicator = document.getElementById('typingIndicator');
  const humorText = document.getElementById('typingHumorText');
  const avatar = document.getElementById('typingAvatar');
  
  if (!indicator) return;
  
  // Atualizar avatar com as iniciais do contato
  if (avatar && nomeContato) {
    const iniciais = nomeContato.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
    avatar.textContent = iniciais;
  }
  
  indicator.classList.add('visible');
  typingHumorVisible = true;
  typingHumorIdx = 0;
  
  if (humorText) humorText.textContent = '';
  
  clearTimeout(typingHumorTimer);
  
  // Escalonar frases de humor
  function agendarProximaFrase() {
    if (!typingHumorVisible) return;
    typingHumorIdx++;
    if (typingHumorIdx >= humorFrases.length) return;
    
    const proxima = humorFrases[typingHumorIdx];
    typingHumorTimer = setTimeout(() => {
      if (humorText && typingHumorVisible) {
        // Re-animar
        humorText.style.animation = 'none';
        requestAnimationFrame(() => {
          humorText.style.animation = '';
          humorText.textContent = proxima.text;
        });
      }
      agendarProximaFrase();
    }, humorFrases[typingHumorIdx].delay - humorFrases[typingHumorIdx - 1].delay);
  }
  
  agendarProximaFrase();
}

function esconderTypingHumor() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) indicator.classList.remove('visible');
  typingHumorVisible = false;
  clearTimeout(typingHumorTimer);
}

// Typing humor agora integrado diretamente no enviarMensagem (acima)

window.mostrarTypingHumor = mostrarTypingHumor;
window.esconderTypingHumor = esconderTypingHumor;
</script>

<script>
// =====================================================
// UPGRADE 5: MOOD DO DIA
// =====================================================
let moodAtual = { emoji:'😎', label:'Focado' };

// Carregar mood salvo
try {
  const saved = JSON.parse(localStorage.getItem('schat-mood') || 'null');
  if (saved) moodAtual = saved;
} catch(e){}

function atualizarMoodBadge() {
  const badge = document.getElementById('moodBadge');
  const lbl = document.getElementById('moodLabel');
  if (badge) badge.childNodes[0].textContent = moodAtual.emoji + ' ';
  if (lbl) lbl.textContent = moodAtual.label;
}

function toggleMoodSelector() {
  const sel = document.getElementById('moodSelector');
  if (!sel) return;
  sel.classList.toggle('visible');
  if (sel.classList.contains('visible')) {
    setTimeout(() => document.addEventListener('click', fecharMoodSel, {once:true}), 100);
  }
}

function fecharMoodSel(e) {
  const sel = document.getElementById('moodSelector');
  const badge = document.getElementById('moodBadge');
  if (sel && !sel.contains(e.target) && e.target !== badge) {
    sel.classList.remove('visible');
  }
}

function setMood(emoji, label) {
  moodAtual = {emoji, label};
  localStorage.setItem('schat-mood', JSON.stringify(moodAtual));
  
  // Atualizar badge
  atualizarMoodBadge();
  
  // Marcar ativo nos opts
  document.querySelectorAll('.mood-opt').forEach(o => {
    o.classList.toggle('active', o.dataset.mood === label);
  });
  
  // Fechar selector
  const sel = document.getElementById('moodSelector');
  if (sel) sel.classList.remove('visible');
  
  // Toast
  mostrarToastDif(`${emoji} Mood: ${label}`, 'var(--orange-soft)');
  
  // Atualizar mood nos contatos da lista (simulado — mostra o mood do contato como badge no avatar)
  atualizarMoodContatos();
}

function atualizarMoodContatos() {
  // Simular moods aleatórios para contatos
  const moodsPossiveis = ['🔥','🎮','🎵','💻','🌙','😴','😎','🏋️'];
  document.querySelectorAll('.contact-item').forEach((item, i) => {
    const av = item.querySelector('.avatar');
    if (!av) return;
    let moodEl = av.querySelector('.contact-mood');
    if (!moodEl) {
      moodEl = document.createElement('div');
      moodEl.className = 'contact-mood';
      moodEl.style.cssText = 'position:absolute;bottom:-4px;right:-4px;font-size:12px;z-index:2;';
      av.style.position = 'relative';
      av.appendChild(moodEl);
    }
    moodEl.textContent = moodsPossiveis[i % moodsPossiveis.length];
  });
}

// Inicializar mood ao carregar
document.addEventListener('DOMContentLoaded', () => {
  atualizarMoodBadge();
  setTimeout(atualizarMoodContatos, 800);
});
// Se DOMContentLoaded já passou
setTimeout(() => { atualizarMoodBadge(); setTimeout(atualizarMoodContatos, 500); }, 200);

window.toggleMoodSelector = toggleMoodSelector;
window.setMood = setMood;
</script>

<script>
// =====================================================
// UPGRADE 6: CÁPSULA DO TEMPO
// =====================================================
// A cápsula do tempo já existe no painel de ferramentas (fpEnviarCapsula)
// Vamos melhorar com animação de abertura e confete

function dispararConfete(x, y, qtd = 40) {
  const cores = ['#e8874a','#ffd700','#ff6b6b','#4ecdc4','#a29bfe','#fd79a8','#00b894'];
  for (let i = 0; i < qtd; i++) {
    const c = document.createElement('div');
    c.className = 'confete';
    const cor = cores[Math.floor(Math.random() * cores.length)];
    const tx = (Math.random() - 0.5) * 200;
    const ty = -(Math.random() * 200 + 50);
    const dur = 0.8 + Math.random() * 0.8;
    const rot = (Math.random() - 0.5) * 720;
    c.style.cssText = `
      left:${x + (Math.random()-0.5)*60}px;
      top:${y}px;
      background:${cor};
      --tx:${tx}px;--ty:${ty}px;--dur:${dur}s;--rot:${rot}deg;
      width:${4+Math.random()*8}px;height:${4+Math.random()*8}px;
      border-radius:${Math.random()>0.5?'50%':'2px'};
    `;
    document.body.appendChild(c);
    setTimeout(() => c.remove(), dur * 1000 + 100);
  }
}

// Melhorar renderização de cápsulas do tempo criadas
function renderizarCapsulaMsg(texto, data, timeAtual) {
  const div = document.createElement('div');
  div.className = 'msg out';
  div.style.animation = 'msg-out 0.25s ease both';
  
  const dataObj = new Date(data);
  const agora = new Date();
  const diferenca = dataObj - agora;
  const diasRestantes = Math.ceil(diferenca / (1000 * 60 * 60 * 24));
  
  let statusText, isAberta;
  if (diferenca <= 0) {
    statusText = '🎉 Entregue agora!';
    isAberta = true;
  } else if (diasRestantes === 0) {
    statusText = 'Entrega em poucas horas';
    isAberta = false;
  } else {
    statusText = `Entrega em ${diasRestantes} dia${diasRestantes>1?'s':''}`;
    isAberta = false;
  }
  
  div.innerHTML = `
    <div>
      <div class="capsula-msg ${isAberta ? 'capsula-aberta' : ''}">
        <div class="capsula-header">
          <div class="capsula-icon">⏳</div>
          <div>
            <div class="capsula-title">CÁPSULA DO TEMPO</div>
            <div class="capsula-subtitle">${isAberta ? 'Aberta! ✨' : 'Lacrada até ' + dataObj.toLocaleDateString('pt-BR')}</div>
          </div>
        </div>
        <div class="capsula-body">${isAberta ? '"' + texto + '"' : '🔒 Conteúdo protegido até a data de abertura'}</div>
        <div class="capsula-lacre">
          <div class="capsula-delivery">${statusText}</div>
          <div class="capsula-status"><div class="capsula-dot"></div>${isAberta ? 'ABERTA' : 'LACRADA'}</div>
        </div>
      </div>
      <div class="msg-footer">
        <span class="msg-time">${timeAtual}</span>
        <span class="msg-check">✓✓</span>
      </div>
    </div>
  `;
  
  return div;
}

// Sobrescrever fpEnviarCapsula para usar nova renderização
const _origFpEnviarCapsula = window.fpEnviarCapsula;
window.fpEnviarCapsula = function(e) {
  e.preventDefault();
  const texto = document.getElementById('fpCapsulaTxt')?.value?.trim();
  const data = document.getElementById('fpCapsulaData')?.value;
  if (!texto || !data) { mostrarToastDif('Preencha a mensagem e a data!', '#c05050'); return; }
  
  const agora = new Date();
  const timeStr = agora.getHours() + ':' + String(agora.getMinutes()).padStart(2,'0');
  
  const mw = document.getElementById('messagesWrap');
  const msgEl = renderizarCapsulaMsg(texto, data, timeStr);
  if (mw) {
    mw.appendChild(msgEl);
    mw.scrollTop = mw.scrollHeight;
  }
  
  // Confete se a data já passou
  const dataObj = new Date(data);
  if (dataObj <= agora) {
    const rect = msgEl.getBoundingClientRect();
    dispararConfete(rect.left + rect.width/2, rect.top + 20, 60);
    mostrarToastDif('🎉 Cápsula aberta na hora! Confete!', 'var(--orange-soft)');
  } else {
    mostrarToastDif('⏳ Cápsula lacrada! Será entregue em ' + dataObj.toLocaleDateString('pt-BR'), 'var(--orange-soft)');
  }
  
  // Fechar form
  const form = document.getElementById('fpCapsulaForm');
  if (form) form.style.display = 'none';
  fecharPainel && fecharPainel();
  
  // Limpar campos
  const txt = document.getElementById('fpCapsulaTxt');
  const dt = document.getElementById('fpCapsulaData');
  if (txt) txt.value = '';
  if (dt) dt.value = '';
};

window.dispararConfete = dispararConfete;
</script>

<script>
// =====================================================
// UPGRADE 7: TIMELINE DA AMIZADE
// =====================================================

function abrirTimeline() {
  const chatContent = document.getElementById('chatContent');
  if (!chatContent || !chatContent.classList.contains('visible')) {
    mostrarToastDif('Abra uma conversa primeiro!', 'var(--text-muted)');
    return;
  }
  
  const nome = document.getElementById('chatName')?.textContent || 'Contato';
  const iniciais = document.getElementById('chatAvatar')?.textContent || '?';
  const cor = document.getElementById('chatAvatar')?.className.replace('avatar-img ', '') || 'c1';
  
  // Titulo
  const title = document.getElementById('timelineTitle');
  const subtitle = document.getElementById('timelineSubtitle');
  if (title) title.innerHTML = '📖 Linha do Tempo — <span style="color:var(--orange-soft)">' + nome + '</span>';
  if (subtitle) subtitle.textContent = 'Sua amizade em momentos marcantes';
  
  // Gerar timeline simulada com base no contato
  const agora = new Date();
  const seed = iniciais.charCodeAt(0) || 65;
  
  const eventos = [
    {
      icon: '👋',
      label: 'Primeira mensagem',
      data: new Date(agora - (seed * 1.2 + 30) * 24*60*60*1000).toLocaleDateString('pt-BR'),
      preview: '"Oi! Tudo bem? 😊"',
      special: true,
    },
    {
      icon: '🔥',
      label: 'Mensagem mais curtida',
      data: new Date(agora - (seed * 0.9 + 15) * 24*60*60*1000).toLocaleDateString('pt-BR'),
      preview: '"Que app incrível esse S-Chat! 🔥" — 8 reações',
      special: true,
    },
    {
      icon: '🎵',
      label: 'Primeiro áudio enviado',
      data: new Date(agora - (seed * 0.7 + 12) * 24*60*60*1000).toLocaleDateString('pt-BR'),
      preview: '🎙️ Áudio de 0:42',
      special: false,
    },
    {
      icon: '📸',
      label: 'Primeira foto compartilhada',
      data: new Date(agora - (seed * 0.5 + 8) * 24*60*60*1000).toLocaleDateString('pt-BR'),
      preview: '🖼️ Imagem enviada',
      special: false,
    },
    {
      icon: '⏳',
      label: 'Cápsula do tempo criada',
      data: new Date(agora - (seed * 0.3 + 3) * 24*60*60*1000).toLocaleDateString('pt-BR'),
      preview: '"Mensagem lacrada para o futuro ✨"',
      special: true,
    },
    {
      icon: '📞',
      label: 'Primeira chamada',
      data: new Date(agora - (seed * 0.2 + 1) * 24*60*60*1000).toLocaleDateString('pt-BR'),
      preview: '📞 Duração: 12:34',
      special: false,
    },
  ];
  
  // Stats
  const totalMsgs = 47 + (seed % 200);
  const diasAtivos = 12 + (seed % 60);
  const audios = 3 + (seed % 15);
  
  const body = document.getElementById('timelineBody');
  if (!body) return;
  
  // Stats no topo
  body.innerHTML = `
    <div class="timeline-stats" style="margin-bottom:20px">
      <div class="tl-stat">
        <div class="tl-stat-n">${totalMsgs}</div>
        <div class="tl-stat-l">Mensagens</div>
      </div>
      <div class="tl-stat">
        <div class="tl-stat-n">${diasAtivos}</div>
        <div class="tl-stat-l">Dias ativos</div>
      </div>
      <div class="tl-stat">
        <div class="tl-stat-n">${audios}</div>
        <div class="tl-stat-l">Áudios</div>
      </div>
    </div>
    <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;margin-bottom:12px">Momentos</div>
  `;
  
  // Itens da timeline
  eventos.forEach((ev, i) => {
    const isLast = i === eventos.length - 1;
    const item = document.createElement('div');
    item.className = 'tl-item';
    item.style.animationDelay = (i * 0.06) + 's';
    item.innerHTML = `
      <div class="tl-line">
        <div class="tl-icon">${ev.icon}</div>
        ${!isLast ? '<div class="tl-connector"></div>' : ''}
      </div>
      <div class="tl-content">
        <div class="tl-label">${ev.label}</div>
        <div class="tl-date">${ev.data}</div>
        <div class="tl-preview ${ev.special ? 'special' : ''}">${ev.preview}</div>
      </div>
    `;
    body.appendChild(item);
  });
  
  // Abrir overlay
  const overlay = document.getElementById('timelineOverlay');
  if (overlay) overlay.classList.add('visible');
  
  // Animar botão
  const btn = document.getElementById('btnTimeline');
  if (btn) {
    btn.style.borderColor = 'var(--orange-soft)';
    btn.style.background = 'var(--orange-dim)';
  }
}

function fecharTimeline(e) {
  if (e && e.target !== document.getElementById('timelineOverlay')) return;
  const overlay = document.getElementById('timelineOverlay');
  if (overlay) {
    overlay.style.opacity = '0';
    setTimeout(() => {
      overlay.classList.remove('visible');
      overlay.style.opacity = '';
    }, 250);
  }
  // Resetar botão
  const btn = document.getElementById('btnTimeline');
  if (btn) { btn.style.borderColor = ''; btn.style.background = ''; }
}

window.abrirTimeline = abrirTimeline;
window.fecharTimeline = fecharTimeline;
</script>


<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 1: FORMATAÇÃO RICA  (*negrito* _itálico_ `código` @menção)
// ══════════════════════════════════════════════════════════════════
function formatarTexto(txt) {
  // Escapar HTML primeiro
  let s = txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  // Negrito **texto** ou *texto*
  s = s.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
  s = s.replace(/\*([^*\n]+?)\*/g, '<b>$1</b>');
  // Itálico _texto_
  s = s.replace(/_([^_\n]+?)_/g, '<i>$1</i>');
  // Tachado ~texto~
  s = s.replace(/~([^~\n]+?)~/g, '<s>$1</s>');
  // Código `texto`
  s = s.replace(/`([^`\n]+?)`/g, '<code>$1</code>');
  // Menção @Nome
  s = s.replace(/@(\w[\w\s]{0,20})/g, (m, nome) => {
    return `<span class="mention" onclick="abrirMentionCard('${nome}',event)">@${nome}</span>`;
  });
  return s;
}

// Hook no enviarMensagem para aplicar formatação
// Interceptar criação de msg-bubble para formatar
const _criarMsgBubble = (texto) => {
  const div = document.createElement('div');
  div.className = 'msg-bubble';
  div.onclick = function(){ mostrarReacoes(this); };
  div.innerHTML = formatarTexto(texto);
  return div;
};
window._criarMsgBubble = _criarMsgBubble;
window.formatarTexto = formatarTexto;
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 2: PESQUISA NA CONVERSA
// ══════════════════════════════════════════════════════════════════
let searchResults = [], searchIdx = 0;

function toggleBusca() {
  const bar = document.getElementById('searchBarChat');
  const btn = document.getElementById('btnBusca');
  const aberto = bar.classList.toggle('visible');
  btn.style.background = aberto ? 'var(--orange-dim)' : '';
  btn.style.borderColor = aberto ? 'var(--orange-soft)' : '';
  if (aberto) {
    setTimeout(() => document.getElementById('searchChatInput').focus(), 100);
  } else {
    fecharBusca();
  }
}

function fecharBusca() {
  document.getElementById('searchBarChat').classList.remove('visible');
  document.getElementById('btnBusca').style.background = '';
  document.getElementById('btnBusca').style.borderColor = '';
  // Limpar highlights
  document.querySelectorAll('#messagesWrap .msg-highlight, #messagesWrap .msg-highlight-current').forEach(el => {
    el.classList.remove('msg-highlight', 'msg-highlight-current');
  });
  document.getElementById('searchChatInput').value = '';
  searchResults = []; searchIdx = 0;
  document.getElementById('searchCount').textContent = '0/0';
}

function buscarNaConversa(termo) {
  // Limpar highlights antigos
  document.querySelectorAll('#messagesWrap .msg-highlight, #messagesWrap .msg-highlight-current').forEach(el => {
    el.classList.remove('msg-highlight', 'msg-highlight-current');
  });
  searchResults = []; searchIdx = 0;

  if (!termo || termo.length < 2) {
    document.getElementById('searchCount').textContent = '0/0';
    return;
  }

  const lower = termo.toLowerCase();
  const bubbles = document.querySelectorAll('#messagesWrap .msg-bubble');
  bubbles.forEach(b => {
    if (b.textContent.toLowerCase().includes(lower)) {
      b.classList.add('msg-highlight');
      searchResults.push(b);
    }
  });

  document.getElementById('searchCount').textContent = searchResults.length > 0
    ? `1/${searchResults.length}` : '0/0';

  if (searchResults.length > 0) {
    searchResults[0].classList.add('msg-highlight-current');
    searchResults[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
    searchIdx = 0;
  }
}

function navegarBusca(dir) {
  if (!searchResults.length) return;
  searchResults[searchIdx].classList.remove('msg-highlight-current');
  searchIdx = (searchIdx + dir + searchResults.length) % searchResults.length;
  searchResults[searchIdx].classList.add('msg-highlight-current');
  searchResults[searchIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
  document.getElementById('searchCount').textContent = `${searchIdx+1}/${searchResults.length}`;
}
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 3: QUICK REPLIES
// ══════════════════════════════════════════════════════════════════
const quickReplyMap = {
  'Tudo bem?':         ['Tudo ótimo! 😊', 'Mais ou menos 😅', 'Depois te conto 🤫'],
  'Oi':                ['Oi! 👋', 'Olá! 😊', 'Eai! 🤙'],
  'Oi!':               ['Oi! 👋', 'Olá! 😊', 'Eai! 🤙'],
  'Quando':            ['Agora! ⚡', 'Amanhã 📅', 'Ainda não sei 🤔'],
  'Ok':                ['👍', 'Perfeito!', 'Combinado! ✅'],
  'Ok!':               ['👍', 'Perfeito!', 'Combinado! ✅'],
  'Vamos':             ['Sim! 🔥', 'Pode ser!', 'Confirmo! ✅'],
  'Obrigado':          ['De nada! 😊', 'Com prazer! 🙏', 'Sempre! ❤️'],
  'Parabéns':          ['Muito obrigado! 🎉', 'Valeu demais! 🙏', '🎂✨'],
  'Reunião':           ['Confirmado! ✅', 'Que horas? 🕐', 'Online ou presencial?'],
  'default':           ['👍', '😊', 'Pode ser!', 'Entendido!'],
};

function mostrarQuickReplies(textoRecebido) {
  const qr = document.getElementById('quickReplies');
  if (!qr) return;

  // Encontrar respostas relevantes
  let sugestoes = quickReplyMap['default'];
  for (const [chave, resps] of Object.entries(quickReplyMap)) {
    if (textoRecebido.includes(chave)) { sugestoes = resps; break; }
  }

  qr.innerHTML = '';
  sugestoes.forEach(r => {
    const chip = document.createElement('button');
    chip.className = 'qr-chip';
    chip.textContent = r;
    chip.onclick = () => {
      document.getElementById('chatInput').value = r;
      enviarMensagem();
      qr.classList.remove('visible');
    };
    qr.appendChild(chip);
  });

  qr.classList.add('visible');
  // Sumir após 8s automaticamente
  setTimeout(() => qr.classList.remove('visible'), 8000);
}
window.mostrarQuickReplies = mostrarQuickReplies;

// Injetar chamada de quick replies quando msg recebida é gerada
// Observar novas msgs recebidas
const qrObserver = new MutationObserver(muts => {
  muts.forEach(m => {
    m.addedNodes.forEach(node => {
      if (node.classList && node.classList.contains('msg') && node.classList.contains('in')) {
        const bubble = node.querySelector('.msg-bubble');
        if (bubble) mostrarQuickReplies(bubble.textContent);
      }
    });
  });
});
const mwEl = document.getElementById('messagesWrap');
if (mwEl) qrObserver.observe(mwEl, { childList: true });
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 4: CARD INTERATIVO
// ══════════════════════════════════════════════════════════════════
let cardCorSelecionada = '#1a0e08,#e8874a';

function abrirCardCreator() {
  document.getElementById('cardCreator').classList.add('visible');
}
function fecharCardCreator(e) {
  if (e && e.target !== document.getElementById('cardCreator')) return;
  document.getElementById('cardCreator').classList.remove('visible');
}
function selecionarCorCard(el) {
  document.querySelectorAll('.card-color-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  cardCorSelecionada = el.dataset.color;
}

function enviarCard() {
  const icon  = document.getElementById('ccIcon').value.trim() || '✨';
  const title = document.getElementById('ccTitle').value.trim();
  const body  = document.getElementById('ccBody').value.trim();
  if (!title) { mostrarToastDif('Coloque um título no card!', '#c05050'); return; }

  const [bg, ac] = cardCorSelecionada.split(',');
  const wrap = document.getElementById('messagesWrap');
  const agora = new Date();
  const hora = agora.getHours().toString().padStart(2,'0') + ':' + agora.getMinutes().toString().padStart(2,'0');

  const div = document.createElement('div');
  div.className = 'msg out';
  div.style.animation = 'msg-out .25s ease both';
  div.innerHTML = `
    <div>
      <div class="card-msg" style="background:${bg}">
        <div class="card-msg-header" style="background:linear-gradient(135deg,${bg},${ac}20)">
          <div class="card-msg-badge" style="color:${ac}">✦ S-Card</div>
          <div class="card-msg-title">${icon} ${title.replace(/</g,'&lt;')}</div>
        </div>
        ${body ? `<div class="card-msg-body">${body.replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>` : ''}
        <div class="card-msg-footer">
          <span class="card-msg-tag">Via S-Chat</span>
          <span class="card-msg-icon">${icon}</span>
        </div>
      </div>
      <div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓✓</span></div>
    </div>`;

  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;

  // Limpar e fechar
  document.getElementById('ccTitle').value = '';
  document.getElementById('ccBody').value = '';
  document.getElementById('ccIcon').value = '✨';
  document.getElementById('cardCreator').classList.remove('visible');
  mostrarToastDif('✦ Card enviado!', 'var(--orange-soft)');
}
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 5: MENÇÃO @
// ══════════════════════════════════════════════════════════════════
const contatosMencao = [
  { nome: 'Ana Lima',       iniciais: 'AL', cor: 'c1', status: 'Online agora', mood: '😊 Animada' },
  { nome: 'Carlos Souza',   iniciais: 'CS', cor: 'c2', status: 'Online agora', mood: '💻 No trampo' },
  { nome: 'Beatriz Ramos',  iniciais: 'BR', cor: 'c4', status: 'Ausente',       mood: '☕ Pausa' },
  { nome: 'Diego Martins',  iniciais: 'DM', cor: 'c3', status: 'Offline',       mood: '🎮 No game' },
  { nome: 'Fernanda Costa', iniciais: 'FC', cor: 'c5', status: 'Offline',       mood: '🎵 Na música' },
];

let mentionAberto = false;

document.getElementById('chatInput').addEventListener('input', (e) => {
  const val = e.target.value;
  const cursor = e.target.selectionStart;
  const antes = val.slice(0, cursor);
  const match = antes.match(/@(\w*)$/);

  if (match) {
    const filtro = match[1].toLowerCase();
    const lista = contatosMencao.filter(c => c.nome.toLowerCase().includes(filtro));
    mostrarMentionPopup(lista);
  } else {
    fecharMentionPopup();
  }
});

function mostrarMentionPopup(lista) {
  const popup = document.getElementById('mentionPopup');
  if (!lista.length) { fecharMentionPopup(); return; }

  popup.innerHTML = lista.map(c => `
    <div class="mention-item" onclick="inserirMencao('${c.nome}')">
      <div class="mention-item-av avatar-img ${c.cor}">${c.iniciais}</div>
      <div>
        <div class="mention-item-name">${c.nome}</div>
        <div class="mention-item-status">${c.status}</div>
      </div>
    </div>
  `).join('');

  // Posicionar acima do input
  const inputWrap = document.getElementById('inputWrap');
  const rect = inputWrap.getBoundingClientRect();
  popup.style.bottom = (window.innerHeight - rect.top + 6) + 'px';
  popup.style.left = '18px';
  popup.style.position = 'fixed';
  popup.classList.add('visible');
  mentionAberto = true;
}

function fecharMentionPopup() {
  document.getElementById('mentionPopup').classList.remove('visible');
  mentionAberto = false;
}

function inserirMencao(nome) {
  const input = document.getElementById('chatInput');
  const val = input.value;
  const cursor = input.selectionStart;
  const antes = val.slice(0, cursor);
  const novoAntes = antes.replace(/@\w*$/, '@' + nome + ' ');
  input.value = novoAntes + val.slice(cursor);
  input.focus();
  fecharMentionPopup();
}

function abrirMentionCard(nome, e) {
  const contato = contatosMencao.find(c => c.nome.toLowerCase() === nome.toLowerCase())
    || { nome, iniciais: nome.slice(0,2).toUpperCase(), cor: 'c1', status: 'S-Chat', mood: '✨' };

  document.getElementById('mcAv').textContent = contato.iniciais;
  document.getElementById('mcAv').className = 'mention-card-av avatar-img ' + contato.cor;
  document.getElementById('mcName').textContent = contato.nome;
  document.getElementById('mcStatus').textContent = '● ' + contato.status;
  document.getElementById('mcStatus').style.color = contato.status === 'Online agora' ? 'var(--green-online)' : 'var(--text-muted)';
  document.getElementById('mcMood').textContent = contato.mood;

  const card = document.getElementById('mentionCard');
  const x = Math.min(e.clientX, window.innerWidth - 220);
  const y = Math.min(e.clientY + 10, window.innerHeight - 160);
  card.style.left = x + 'px';
  card.style.top  = y + 'px';
  card.classList.add('visible');

  setTimeout(() => document.addEventListener('click', fecharMentionCard, { once: true }), 100);
}

function fecharMentionCard() {
  document.getElementById('mentionCard').classList.remove('visible');
}
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 6: HISTÓRICO DE EDIÇÕES
// ══════════════════════════════════════════════════════════════════
const historicoEdicoes = new Map(); // msgId -> [{versao, texto, hora}]
let editHistoryAlvo = null;

// Adicionar opção "Editar" no menu de contexto existente
const _origMostrarMenuContexto = window.mostrarMenuContexto;
window.mostrarMenuContexto = function(e, bubble, autor, texto) {
  if (_origMostrarMenuContexto) _origMostrarMenuContexto(e, bubble, autor, texto);

  // Se a msg é do próprio usuário (out), adicionar opção editar
  const msgEl = bubble.closest('.msg.out');
  if (!msgEl) return;

  setTimeout(() => {
    const menu = document.getElementById('ctxMenu') || document.querySelector('.context-menu');
    if (!menu) return;
    const btnEditar = document.createElement('button');
    btnEditar.className = menu.querySelector('button')?.className || '';
    btnEditar.style.cssText = 'display:flex;align-items:center;gap:8px;width:100%;padding:9px 14px;background:none;border:none;color:var(--text-primary);font-family:Sora,sans-serif;font-size:13px;cursor:pointer;text-align:left';
    btnEditar.innerHTML = '✏️ Editar mensagem';
    btnEditar.onclick = () => { editarMensagem(bubble, texto); menu.remove(); };
    menu.appendChild(btnEditar);
  }, 50);
};

function editarMensagem(bubble, textoOriginal) {
  const msgId = bubble.dataset.msgId || ('msg-' + Date.now());
  bubble.dataset.msgId = msgId;

  // Salvar histórico
  if (!historicoEdicoes.has(msgId)) {
    historicoEdicoes.set(msgId, [{ versao: 'Original', texto: textoOriginal, hora: new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) }]);
  }

  // Transformar bubble em input inline
  const textoAtual = bubble.textContent;
  const inputEdit = document.createElement('input');
  inputEdit.value = textoAtual;
  inputEdit.style.cssText = `
    background: var(--bg-input); border: 1px solid var(--orange-soft);
    border-radius: 8px; padding: 6px 10px; color: var(--text-primary);
    font-family: 'Sora', sans-serif; font-size: 14px; outline: none; width: 100%;
  `;
  bubble.style.display = 'none';
  bubble.parentNode.insertBefore(inputEdit, bubble);
  inputEdit.focus();
  inputEdit.select();

  const confirmar = () => {
    const novoTexto = inputEdit.value.trim();
    if (novoTexto && novoTexto !== textoAtual) {
      bubble.innerHTML = formatarTexto(novoTexto);
      const hora = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      historicoEdicoes.get(msgId).push({ versao: 'Editado ' + hora, texto: novoTexto, hora });

      // Adicionar badge "editado"
      let badge = bubble.parentNode.querySelector('.edit-badge');
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'edit-badge';
        badge.onclick = (e) => { e.stopPropagation(); mostrarEditHistory(msgId, e); };
        bubble.parentNode.appendChild(badge);
      }
      badge.textContent = '(editado)';
    }
    bubble.style.display = '';
    inputEdit.remove();
  };

  inputEdit.addEventListener('keydown', e => {
    if (e.key === 'Enter') confirmar();
    if (e.key === 'Escape') { bubble.style.display = ''; inputEdit.remove(); }
  });
  inputEdit.addEventListener('blur', confirmar);
}

function mostrarEditHistory(msgId, e) {
  const historico = historicoEdicoes.get(msgId) || [];
  const popup = document.getElementById('editHistoryPopup');
  const lista = document.getElementById('editHistoryList');

  lista.innerHTML = historico.map((h, i) => `
    <div class="edit-history-item">
      <div class="edit-history-ver">${h.versao}</div>
      <div class="edit-history-text">"${h.texto}"</div>
    </div>
  `).join('');

  const x = Math.min(e.clientX, window.innerWidth - 280);
  const y = Math.max(e.clientY - 150, 20);
  popup.style.left = x + 'px';
  popup.style.top  = y + 'px';
  popup.classList.add('visible');
  setTimeout(() => document.addEventListener('click', fecharEditHistory, { once: true }), 100);
}

function fecharEditHistory() {
  document.getElementById('editHistoryPopup').classList.remove('visible');
}
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 7: MODO FOCO
// ══════════════════════════════════════════════════════════════════
let focoAtivo = false, focoInterval = null, focoSegundos = 25 * 60;

function toggleFoco() {
  focoAtivo = !focoAtivo;
  const vignette = document.getElementById('focusVignette');
  const banner   = document.getElementById('focusBanner');
  const btn      = document.getElementById('btnFoco');

  if (focoAtivo) {
    vignette.classList.add('visible');
    banner.classList.add('visible');
    btn.style.background    = 'var(--orange-dim)';
    btn.style.borderColor   = 'var(--orange-soft)';
    focoSegundos = 25 * 60;
    atualizarFocoTimer();
    focoInterval = setInterval(() => {
      focoSegundos--;
      atualizarFocoTimer();
      if (focoSegundos <= 0) {
        clearInterval(focoInterval);
        focoAtivo = false;
        vignette.classList.remove('visible');
        banner.classList.remove('visible');
        btn.style.background  = '';
        btn.style.borderColor = '';
        mostrarToastDif('🎯 Foco de 25min concluído! Bom trabalho ✨', 'var(--orange-soft)');
      }
    }, 1000);
    mostrarToastDif('🎯 Modo Foco ativo — 25min', 'var(--orange-soft)');
  } else {
    clearInterval(focoInterval);
    vignette.classList.remove('visible');
    banner.classList.remove('visible');
    btn.style.background  = '';
    btn.style.borderColor = '';
    mostrarToastDif('🎯 Modo Foco encerrado', 'var(--text-muted)');
  }
}

function atualizarFocoTimer() {
  const m = Math.floor(focoSegundos / 60).toString().padStart(2,'0');
  const s = (focoSegundos % 60).toString().padStart(2,'0');
  const el = document.getElementById('focusTimer');
  if (el) el.textContent = m + ':' + s;
}
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 8: STICKERS S-CHAT (SVG inline)
// ══════════════════════════════════════════════════════════════════
const stickersDef = [
  // S-Bot feliz
  { id:'s1', label:'Feliz', svg:`<svg viewBox="0 0 80 80" class="sticker-svg">
    <circle cx="40" cy="40" r="36" fill="#e8874a" opacity=".15" stroke="#e8874a" stroke-width="2"/>
    <circle cx="40" cy="38" r="22" fill="#e8874a"/>
    <circle cx="32" cy="33" r="4" fill="#1a0e08"/>
    <circle cx="48" cy="33" r="4" fill="#1a0e08"/>
    <circle cx="33" cy="32" r="1.5" fill="white"/>
    <circle cx="49" cy="32" r="1.5" fill="white"/>
    <path d="M30 44 Q40 54 50 44" stroke="#1a0e08" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <circle cx="55" cy="28" r="8" fill="#ffd700" opacity=".9"/>
    <text x="55" y="32" text-anchor="middle" font-size="10">★</text>
  </svg>` },
  // S-Bot chocado
  { id:'s2', label:'Chocado', svg:`<svg viewBox="0 0 80 80" class="sticker-svg">
    <circle cx="40" cy="40" r="36" fill="#4a80c0" opacity=".15" stroke="#4a80c0" stroke-width="2"/>
    <circle cx="40" cy="38" r="22" fill="#e8874a"/>
    <circle cx="32" cy="33" r="5" fill="#1a0e08"/>
    <circle cx="48" cy="33" r="5" fill="#1a0e08"/>
    <circle cx="33" cy="32" r="2" fill="white"/>
    <circle cx="49" cy="32" r="2" fill="white"/>
    <ellipse cx="40" cy="47" rx="5" ry="6" fill="#1a0e08"/>
    <path d="M28 26 L36 30" stroke="#1a0e08" stroke-width="2" stroke-linecap="round"/>
    <path d="M52 26 L44 30" stroke="#1a0e08" stroke-width="2" stroke-linecap="round"/>
  </svg>` },
  // S-Bot apaixonado
  { id:'s3', label:'Amor', svg:`<svg viewBox="0 0 80 80" class="sticker-svg">
    <circle cx="40" cy="40" r="36" fill="#c04a8a" opacity=".12" stroke="#c04a8a" stroke-width="2"/>
    <circle cx="40" cy="40" r="22" fill="#e8874a"/>
    <path d="M32 33 Q32 28 37 33 Q40 36 40 36 Q40 36 43 33 Q48 28 48 33 Q48 38 40 44 Q32 38 32 33Z" fill="#e05080"/>
    <path d="M22 18 Q25 14 28 18 Q25 22 22 18Z" fill="#e05080"/>
    <path d="M52 18 Q55 14 58 18 Q55 22 52 18Z" fill="#e05080"/>
  </svg>` },
  // S-Bot fogo
  { id:'s4', label:'Fire', svg:`<svg viewBox="0 0 80 80" class="sticker-svg">
    <circle cx="40" cy="44" r="28" fill="#e8874a"/>
    <path d="M40 12 Q45 22 38 26 Q50 18 48 32 Q55 24 52 36 Q58 30 54 44 Q56 52 40 60 Q24 52 26 44 Q22 30 28 36 Q24 24 32 32 Q28 18 40 12Z" fill="#ff6b00" opacity=".8"/>
    <circle cx="35" cy="46" r="3" fill="#1a0e08"/>
    <circle cx="45" cy="46" r="3" fill="#1a0e08"/>
    <path d="M34 53 Q40 58 46 53" stroke="#1a0e08" stroke-width="2" fill="none" stroke-linecap="round"/>
  </svg>` },
  // S-Bot pensativo
  { id:'s5', label:'Hm...', svg:`<svg viewBox="0 0 80 80" class="sticker-svg">
    <circle cx="40" cy="40" r="36" fill="#8a60c0" opacity=".12" stroke="#8a60c0" stroke-width="2"/>
    <circle cx="40" cy="40" r="22" fill="#e8874a"/>
    <circle cx="32" cy="37" r="3.5" fill="#1a0e08"/>
    <circle cx="48" cy="37" r="3.5" fill="#1a0e08"/>
    <path d="M33 47 Q38 44 46 47" stroke="#1a0e08" stroke-width="2" fill="none" stroke-linecap="round"/>
    <circle cx="54" cy="30" r="5" fill="white" opacity=".9" stroke="var(--border)" stroke-width="1"/>
    <text x="54" y="34" text-anchor="middle" font-size="8" fill="var(--text-muted)">?</text>
    <circle cx="62" cy="24" r="3" fill="white" opacity=".6" stroke="var(--border)" stroke-width="1"/>
    <circle cx="68" cy="20" r="2" fill="white" opacity=".4" stroke="var(--border)" stroke-width="1"/>
  </svg>` },
  // S-Bot legal - thumbs up
  { id:'s6', label:'Top!', svg:`<svg viewBox="0 0 80 80" class="sticker-svg">
    <circle cx="40" cy="36" r="22" fill="#e8874a"/>
    <circle cx="33" cy="31" r="3.5" fill="#1a0e08"/>
    <circle cx="47" cy="31" r="3.5" fill="#1a0e08"/>
    <path d="M32 42 Q40 50 48 42" stroke="#1a0e08" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <rect x="12" y="45" width="14" height="20" rx="5" fill="#e8874a" stroke="#c05820" stroke-width="1.5"/>
    <path d="M26 52 Q30 38 38 36" stroke="#e8874a" stroke-width="3" fill="none" stroke-linecap="round"/>
    <text x="56" y="68" font-size="22">👍</text>
  </svg>` },
  // S-Bot dançando
  { id:'s7', label:'Dance!', svg:`<svg viewBox="0 0 80 80" class="sticker-svg">
    <circle cx="40" cy="28" r="16" fill="#e8874a"/>
    <circle cx="35" cy="25" r="3" fill="#1a0e08"/>
    <circle cx="45" cy="25" r="3" fill="#1a0e08"/>
    <path d="M34 32 Q40 37 46 32" stroke="#1a0e08" stroke-width="2" fill="none" stroke-linecap="round"/>
    <rect x="32" y="44" width="16" height="18" rx="5" fill="#4a80c0"/>
    <line x1="40" y1="44" x2="40" y2="62" stroke="#3a6ab0" stroke-width="2"/>
    <line x1="32" y1="52" x2="18" y2="44" stroke="#e8874a" stroke-width="3" stroke-linecap="round"/>
    <line x1="48" y1="52" x2="62" y2="44" stroke="#e8874a" stroke-width="3" stroke-linecap="round"/>
    <line x1="36" y1="62" x2="28" y2="74" stroke="#e8874a" stroke-width="3" stroke-linecap="round"/>
    <line x1="44" y1="62" x2="52" y2="74" stroke="#e8874a" stroke-width="3" stroke-linecap="round"/>
    <text x="10" y="30" font-size="12">🎵</text><text x="58" y="25" font-size="10">♪</text>
  </svg>` },
  // S-Bot dormindo
  { id:'s8', label:'Zzz', svg:`<svg viewBox="0 0 80 80" class="sticker-svg">
    <circle cx="40" cy="42" r="22" fill="#e8874a"/>
    <path d="M30 38 Q32 34 34 38" stroke="#1a0e08" stroke-width="2" fill="none" stroke-linecap="round"/>
    <path d="M46 38 Q48 34 50 38" stroke="#1a0e08" stroke-width="2" fill="none" stroke-linecap="round"/>
    <path d="M33 50 Q40 55 47 50" stroke="#1a0e08" stroke-width="2" fill="none" stroke-linecap="round"/>
    <text x="52" y="28" font-size="11" fill="#8a8178" font-weight="700">z</text>
    <text x="58" y="20" font-size="14" fill="#8a8178" font-weight="700">z</text>
    <text x="65" y="13" font-size="17" fill="#8a8178" font-weight="700">Z</text>
  </svg>` },
];

function renderizarStickers() {
  const grid = document.getElementById('stickerGrid');
  if (!grid) return;
  grid.innerHTML = stickersDef.map(s => `
    <button class="sticker-btn" title="${s.label}" onclick="enviarSticker('${s.id}')">
      ${s.svg}
    </button>
  `).join('');
}

function toggleStickers() {
  const panel = document.getElementById('stickerPanel');
  const btn   = document.getElementById('btnSticker');
  const aberto = panel.classList.toggle('visible');
  btn.style.color = aberto ? 'var(--orange-soft)' : '';
  if (aberto) {
    renderizarStickers();
    // fechar emoji se aberto
    document.getElementById('emojiContextual')?.classList.remove('visible');
    emojiAberto = false;
    setTimeout(() => document.addEventListener('click', fecharStickersOut, { once: true }), 100);
  }
}

function fecharStickersOut(e) {
  const panel = document.getElementById('stickerPanel');
  const btn   = document.getElementById('btnSticker');
  if (panel && !panel.contains(e.target) && e.target !== btn) {
    panel.classList.remove('visible');
    btn.style.color = '';
  }
}

function enviarSticker(id) {
  const sticker = stickersDef.find(s => s.id === id);
  if (!sticker) return;

  const wrap = document.getElementById('messagesWrap');
  const agora = new Date();
  const hora = agora.getHours().toString().padStart(2,'0') + ':' + agora.getMinutes().toString().padStart(2,'0');

  const div = document.createElement('div');
  div.className = 'msg out';
  div.style.animation = 'msg-out .25s ease both';
  div.innerHTML = `
    <div>
      <div class="msg-bubble sticker-bubble" onclick="mostrarReacoes(this)">
        ${sticker.svg}
      </div>
      <div class="msg-footer"><span class="msg-time">${hora}</span><span class="msg-check">✓✓</span></div>
    </div>`;

  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;
  document.getElementById('stickerPanel').classList.remove('visible');
  document.getElementById('btnSticker').style.color = '';
}
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 9: SALA FLASH
// ══════════════════════════════════════════════════════════════════
let sfAbaAtual = 'criar';
let sfCodigoAtivo = null;
let sfExpiryInterval = null;
let sfSegundos = 24 * 60 * 60;

const sfMembrosSimulados = [
  { av: 'AL', nome: 'Ana Lima' },
  { av: 'CS', nome: 'Carlos Souza' },
];

function gerarCodigoFlash() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

function abrirSalaFlash() {
  sfCodigoAtivo = gerarCodigoFlash();
  document.getElementById('sfCodigoGerado').textContent = sfCodigoAtivo;
  sfSegundos = 24 * 60 * 60;
  atualizarSfExpiry();
  clearInterval(sfExpiryInterval);
  sfExpiryInterval = setInterval(() => {
    sfSegundos--;
    atualizarSfExpiry();
    if (sfSegundos <= 0) { clearInterval(sfExpiryInterval); fecharSalaFlash(); }
  }, 1000);

  // Simular membros entrando
  sfRenderizarMembros(['Você']);
  setTimeout(() => { sfRenderizarMembros(['Você', sfMembrosSimulados[0].nome]); mostrarToastDif('⚡ ' + sfMembrosSimulados[0].nome + ' entrou na sala!', 'var(--green-online)'); }, 4000);
  setTimeout(() => { sfRenderizarMembros(['Você', sfMembrosSimulados[0].nome, sfMembrosSimulados[1].nome]); mostrarToastDif('⚡ ' + sfMembrosSimulados[1].nome + ' entrou na sala!', 'var(--green-online)'); }, 8000);

  sfMudarAba('criar');
  document.getElementById('salaFlashOverlay').classList.add('visible');
}

function sfRenderizarMembros(lista) {
  const el = document.getElementById('sfMembers');
  if (!el) return;
  el.innerHTML = lista.map((n, i) => `
    <div class="sf-member">
      <div class="sf-member-av">${n.slice(0,2).toUpperCase()}</div>
      <div class="sf-member-name">${n} ${i === 0 ? '<span style="color:var(--orange-soft);font-size:10px">· criador</span>' : ''}</div>
    </div>
  `).join('');
}

function atualizarSfExpiry() {
  const h = Math.floor(sfSegundos / 3600).toString().padStart(2,'0');
  const m = Math.floor((sfSegundos % 3600) / 60).toString().padStart(2,'0');
  const s = (sfSegundos % 60).toString().padStart(2,'0');
  const el = document.getElementById('sfExpiry');
  if (el) el.textContent = `Expira em ${h}:${m}:${s}`;
}

function sfMudarAba(aba) {
  sfAbaAtual = aba;
  document.getElementById('sfTabCriar').classList.toggle('active', aba === 'criar');
  document.getElementById('sfTabEntrar').classList.toggle('active', aba === 'entrar');
  document.getElementById('sfConteudoCriar').style.display = aba === 'criar' ? '' : 'none';
  document.getElementById('sfConteudoEntrar').style.display = aba === 'entrar' ? '' : 'none';
  document.getElementById('sfBtnAcao').textContent = aba === 'criar' ? 'Copiar código ⚡' : 'Entrar na sala ⚡';
}

function sfAcao() {
  if (sfAbaAtual === 'criar') {
    navigator.clipboard?.writeText(sfCodigoAtivo || '').catch(()=>{});
    mostrarToastDif('⚡ Código ' + sfCodigoAtivo + ' copiado!', 'var(--orange-soft)');
  } else {
    const codigo = document.getElementById('sfCodigoInput').value.trim();
    if (codigo.length !== 6) { mostrarToastDif('Digite os 6 dígitos!', '#c05050'); return; }
    mostrarToastDif('⚡ Entrando na sala ' + codigo + '...', 'var(--green-online)');
    setTimeout(() => { fecharSalaFlash(); mostrarToastDif('✅ Você entrou na sala ' + codigo + '!', 'var(--green-online)'); }, 1200);
  }
}

function fecharSalaFlash(e) {
  if (e && e.target !== document.getElementById('salaFlashOverlay')) return;
  document.getElementById('salaFlashOverlay').classList.remove('visible');
}
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// UPGRADE 10: WRAP-UP SEMANAL
// ══════════════════════════════════════════════════════════════════
const msgsSemana = [
  '"Que app incrível esse S-Chat! 🔥"',
  '"Gente, esse negócio é demais! ✨"',
  '"Nunca vi um chat assim, caramba! 😍"',
  '"S-Chat é o futuro das mensagens! 🚀"',
];
const emojisSemana = ['🔥','😂','❤️','✨','👍','😎','🚀','💯'];
const contatosSemana = ['Ana Lima','Carlos Souza','Beatriz Ramos','Fernanda Costa'];

function abrirWrapup() {
  // Gerar stats simulados mas com variação
  const seed = new Date().getDate();
  const msgs    = 47 + (seed * 13) % 200;
  const audios  = 3  + (seed * 7)  % 20;
  const topIdx  = seed % contatosSemana.length;
  const emojiIdx = seed % emojisSemana.length;
  const msgDest  = msgsSemana[seed % msgsSemana.length];

  document.getElementById('wuMsgs').textContent   = msgs;
  document.getElementById('wuAudios').textContent  = audios;
  document.getElementById('wuTop').textContent     = contatosSemana[topIdx];
  document.getElementById('wuTopMsgs').textContent = '+ ' + (20 + (seed * 3) % 40) + ' msgs';
  document.getElementById('wuEmoji').textContent   = emojisSemana[emojiIdx];
  document.getElementById('wuMsgDestaque').textContent = msgDest;

  // Data da semana
  const agora = new Date();
  const diaInicio = new Date(agora);
  diaInicio.setDate(agora.getDate() - agora.getDay());
  document.getElementById('wuSemana').textContent = 'SEMANA DE ' +
    diaInicio.toLocaleDateString('pt-BR', { day:'2-digit', month:'short' }).toUpperCase();

  document.getElementById('wrapupOverlay').classList.add('visible');
}

function fecharWrapup(e) {
  if (e && e.target !== document.getElementById('wrapupOverlay')) return;
  document.getElementById('wrapupOverlay').classList.remove('visible');
}

// Botão de Wrap-up no painel de ferramentas — adicionar ao my-profile area
setTimeout(() => {
  const myProfile = document.querySelector('.my-profile');
  if (!myProfile) return;
  // Já existe botão de perfil, vamos adicionar wrap-up no painel de ferramentas
}, 300);

// Expor abrirWrapup globalmente para ser chamado do painel de ferramentas
window.abrirWrapup = abrirWrapup;
window.fecharWrapup = fecharWrapup;
</script>

<script>
// ══════════════════════════════════════════════════════════════════
// INTEGRAÇÃO: Botão Wrap-up no painel de ferramentas + formatação nas msgs enviadas
// ══════════════════════════════════════════════════════════════════

// Adicionar Wrap-up ao painel existente após carregar
setTimeout(() => {
  const painel = document.getElementById('fpanel') || document.querySelector('.fp-body');
  if (painel) {
    const sec = document.createElement('div');
    sec.style.cssText = 'margin-top:12px;padding-top:12px;border-top:1px solid var(--border)';
    sec.innerHTML = `
      <div class="fp-section-title" style="color:var(--orange-soft);margin-bottom:8px">📊 Relatórios</div>
      <div style="display:flex;gap:6px">
        <button class="fp-tag" onclick="abrirWrapup();fecharPainel()">📊 Wrap-up semanal</button>
        <button class="fp-tag" onclick="abrirSalaFlash();fecharPainel()">⚡ Sala Flash</button>
      </div>
    `;
    painel.appendChild(sec);
  }
}, 600);

// Override enviarMensagem para aplicar formatação rica
// (só aplicar se o texto tiver marcadores)
const _enviarMsgOrig = window.enviarMensagem;
(function() {
  // Guardar referência da função atual
  const currentEnviar = document.querySelector('#chatInput') ? true : false;
  // Hook no oninput para preview de formatação
  const inputEl = document.getElementById('chatInput');
  if (!inputEl) return;

  // Preview da formatação no placeholder (dica)
  inputEl.addEventListener('focus', () => {
    if (!inputEl.placeholder.includes('*negrito*')) {
      inputEl.setAttribute('data-orig-placeholder', inputEl.placeholder);
    }
  });
  inputEl.addEventListener('blur', () => {
    const orig = inputEl.getAttribute('data-orig-placeholder');
    if (orig) inputEl.placeholder = orig;
  });
})();

// O formatarTexto já está disponível e será usado quando renderizarmos as msgs
// Para as msgs enviadas, vamos aplicar formatação depois que o bubble é criado
const formatObserver = new MutationObserver(muts => {
  muts.forEach(m => {
    m.addedNodes.forEach(node => {
      if (node.classList && node.classList.contains('msg')) {
        const bubble = node.querySelector('.msg-bubble');
        if (bubble && !bubble.dataset.formatted && !bubble.querySelector('svg')) {
          const txt = bubble.textContent;
          // Só formatar se tiver marcadores
          if (/[*_~`@]/.test(txt)) {
            bubble.innerHTML = formatarTexto(txt);
          }
          bubble.dataset.formatted = '1';
        }
      }
    });
  });
});
const mwFmt = document.getElementById('messagesWrap');
if (mwFmt) formatObserver.observe(mwFmt, { childList: true });
</script>


<script>
// Hint de formatação rica no input
(function() {
  const input = document.getElementById('chatInput');
  const hint = document.getElementById('fmtHint');
  if (!input || !hint) return;
  
  const dicas = [
    { regex: /\*[^*]+\*/, msg: '💡 <b>*texto*</b> = <b>negrito</b>' },
    { regex: /_[^_]+_/,   msg: '💡 <i>_texto_</i> = <i>itálico</i>' },
    { regex: /~[^~]+~/,   msg: '💡 ~texto~ = <s>tachado</s>' },
    { regex: /`[^`]+`/,   msg: '💡 `código` = <code>monoespaçado</code>' },
    { regex: /@\w+/,      msg: '💡 @Nome = mencionar contato' },
  ];

  let hintTimer = null;
  input.addEventListener('input', () => {
    const val = input.value;
    let found = null;
    for (const d of dicas) { if (d.regex.test(val)) { found = d; break; } }
    clearTimeout(hintTimer);
    if (found) {
      hint.innerHTML = found.msg;
      hint.classList.add('visible');
      hintTimer = setTimeout(() => hint.classList.remove('visible'), 3000);
    } else {
      hint.classList.remove('visible');
    }
  });
})();
</script>


<!-- ── HOVER PREVIEW DE MENSAGENS ── -->
<div class="contact-preview-popup" id="contactPreviewPopup">
  <div class="cpp-header">
    <div class="cpp-av avatar-img c1" id="cppAv">AL</div>
    <div>
      <div class="cpp-name" id="cppName">Ana Lima</div>
      <div class="cpp-status" id="cppStatus">● Online agora</div>
    </div>
  </div>
  <div class="cpp-msgs" id="cppMsgs"></div>
</div>


<script>
// ════════════════════════════════════════════════════════
// UPGRADES SIDEBAR — S-Chat v3
// ════════════════════════════════════════════════════════

// ── 1. HEADER: STATUS DE CONEXÃO ──────────────────────
(function() {
  let online = true;
  function checarConexao() {
    const dot   = document.getElementById('connDot');
    const label = document.getElementById('connLabel');
    if (!dot || !label) return;
    if (navigator.onLine !== undefined) online = navigator.onLine;
    if (online) {
      dot.className   = 'conn-dot';
      label.textContent = 'Conectado · v3.0';
    } else {
      dot.className   = 'conn-dot offline';
      label.textContent = 'Sem conexão';
    }
  }
  checarConexao();
  window.addEventListener('online',  () => { online = true;  checarConexao(); });
  window.addEventListener('offline', () => { online = false; checarConexao(); });
})();

// ── 2. MINI DASHBOARD ─────────────────────────────────
let dashAberto = true;

function toggleDash() {
  dashAberto = !dashAberto;
  const grid    = document.getElementById('dashGrid');
  const chevron = document.getElementById('dashChevron');
  if (grid)    grid.classList.toggle('collapsed', !dashAberto);
  if (chevron) chevron.classList.toggle('open', dashAberto);
}

// Animar números do dashboard ao carregar
function animarDashNumeros() {
  const targets = [
    { id: 'dashMsgs',   val: 24 },
    { id: 'dashOnline', val: 3  },
    { id: 'dashNotif',  val: 6  },
  ];
  targets.forEach(({ id, val }) => {
    const el = document.getElementById(id);
    if (!el) return;
    let cur = 0;
    const step = Math.ceil(val / 20);
    const t = setInterval(() => {
      cur = Math.min(cur + step, val);
      el.textContent = cur;
      if (cur >= val) clearInterval(t);
    }, 40);
  });
}
setTimeout(animarDashNumeros, 400);

// ── 3. FILTROS DE CONVERSA ────────────────────────────
function filtrarChip(el, tipo) {
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');

  const items = document.querySelectorAll('#contactsList .contact-item');
  items.forEach(item => {
    let mostrar = true;
    if (tipo === 'nao-lidos') {
      mostrar = !!item.querySelector('.unread-badge');
    } else if (tipo === 'online') {
      mostrar = !!item.querySelector('.status-dot.online');
    } else if (tipo === 'grupos') {
      mostrar = false; // sem grupos ainda — mostra vazio com msg
    }
    item.style.transition = 'opacity 0.2s, transform 0.2s';
    if (mostrar) {
      item.style.opacity = '1';
      item.style.transform = '';
      item.style.display = '';
    } else {
      item.style.opacity = '0';
      item.style.transform = 'translateX(-8px)';
      setTimeout(() => { if (item.style.opacity === '0') item.style.display = 'none'; }, 200);
    }
  });

  if (tipo === 'grupos') {
    mostrarToastDif('Nenhum grupo criado ainda — clique em + para criar!', 'var(--text-muted)');
  }
}
window.filtrarChip = filtrarChip;

// ── 4. HOVER PREVIEW ──────────────────────────────────
const previewData = {
  'Ana Lima': {
    cor: 'c1', status: '● Online agora',
    msgs: [
      { dir: 'in',  txt: 'Oi! Tudo bem? 😊' },
      { dir: 'out', txt: 'Tudo ótimo! E você?' },
      { dir: 'in',  txt: 'Que app incrível esse S-Chat! 🔥' },
    ]
  },
  'Carlos Souza': {
    cor: 'c2', status: '● Online agora',
    msgs: [
      { dir: 'in',  txt: 'Você viu o jogo ontem?' },
      { dir: 'out', txt: 'Vi sim! Que partida!' },
      { dir: 'in',  txt: 'Demais! 🔥' },
    ]
  },
  'Beatriz Ramos': {
    cor: 'c4', status: '◌ Ausente',
    msgs: [
      { dir: 'out', txt: 'Oi Beatriz! Tudo bem?' },
      { dir: 'in',  txt: 'Ok, te falo mais tarde!' },
    ]
  },
  'Diego Martins': {
    cor: 'c3', status: '○ Offline',
    msgs: [
      { dir: 'in',  txt: 'Vlw! Até mais 👋' },
    ]
  },
  'Fernanda Costa': {
    cor: 'c5', status: '○ Offline',
    msgs: [
      { dir: 'in',  txt: 'Vou verificar aqui 🙂' },
      { dir: 'out', txt: 'Ok, me avisa!' },
    ]
  },
};

let previewTimer = null;
const popup = document.getElementById('contactPreviewPopup');

document.querySelectorAll('#contactsList .contact-item').forEach(item => {
  const nome = item.dataset.nome;
  if (!nome || !previewData[nome]) return;

  item.addEventListener('mouseenter', (e) => {
    if (window.innerWidth <= 1024) return; // só desktop
    clearTimeout(previewTimer);
    previewTimer = setTimeout(() => {
      const data = previewData[nome];
      const rect = item.getBoundingClientRect();

      // Preencher popup
      const av = document.getElementById('cppAv');
      av.textContent = nome.split(' ').map(n=>n[0]).join('').slice(0,2);
      av.className = 'cpp-av avatar-img ' + data.cor;
      document.getElementById('cppName').textContent = nome;
      const st = document.getElementById('cppStatus');
      st.textContent = data.status;
      st.style.color = data.status.includes('Online') ? 'var(--green-online)' : 'var(--text-muted)';

      const msgs = document.getElementById('cppMsgs');
      msgs.innerHTML = data.msgs.map(m =>
        `<div class="cpp-msg ${m.dir}">${m.dir === 'out' ? 'Você: ' : ''}${m.txt}</div>`
      ).join('');

      // Posicionar à direita do item
      popup.style.top  = Math.min(rect.top, window.innerHeight - 200) + 'px';
      popup.style.left = (rect.right + 10) + 'px';
      popup.classList.add('visible');
    }, 500);
  });

  item.addEventListener('mouseleave', () => {
    clearTimeout(previewTimer);
    popup.classList.remove('visible');
  });
});

// ── 5. NUDGE "PENSANDO EM VOCÊ" ───────────────────────
const nudgePessoas = [
  { nome: 'Ana Lima',       av: 'AL', cor: 'c1', sub: 'Ativa há 2h — que tal dar um oi? 👋',   target: '[data-nome="Ana Lima"]' },
  { nome: 'Carlos Souza',   av: 'CS', cor: 'c2', sub: 'Online agora! Não fala há 3 dias 💬',   target: '[data-nome="Carlos Souza"]' },
  { nome: 'Fernanda Costa', av: 'FC', cor: 'c5', sub: 'Última conversa há 5 dias — saudade? 🥺', target: '[data-nome="Fernanda Costa"]' },
];
let nudgeIdx = 0;

function mostrarNudge() {
  const card = document.getElementById('nudgeCard');
  const p = nudgePessoas[nudgeIdx % nudgePessoas.length];
  const av = document.getElementById('nudgeAv');
  av.innerHTML = p.av + '<div class="nudge-heart">❤️</div>';
  av.className = 'nudge-av ' + p.cor;
  document.getElementById('nudgeName').textContent = p.nome;
  document.getElementById('nudgeSub').textContent  = p.sub;
  card._target = p.target;
  card.classList.add('visible');
  nudgeIdx++;
  // Auto-fechar após 12s
  setTimeout(fecharNudge, 12000);
}

function fecharNudge() {
  document.getElementById('nudgeCard').classList.remove('visible');
}

function nudgeAbrir() {
  const card = document.getElementById('nudgeCard');
  const sel  = card._target;
  fecharNudge();
  if (sel) {
    const el = document.querySelector(sel);
    if (el) { el.click(); mostrarToastDif('💌 Conversa aberta!', 'var(--orange-soft)'); }
  }
}

// Disparar nudges aleatórios
setTimeout(() => mostrarNudge(), 8000);
setTimeout(() => mostrarNudge(), 35000);
window.fecharNudge = fecharNudge;
window.nudgeAbrir  = nudgeAbrir;

// ── 6. WELCOME SCREEN — frases rotativas + partículas ─
const welcomeFrases = [
  'Selecione uma conversa para começar ✨',
  'Suas mensagens são protegidas 🔐',
  'Use *negrito*, _itálico_ e `código` ✍️',
  'Experimente o Modo Cofre para conversas secretas 🕵️',
  'Crie uma Cápsula do Tempo para o futuro ⏳',
  'Reaja às mensagens com emojis contextuais 😊',
  'Modo Foco: 25 minutos de concentração total 🎯',
];
let fraseIdx = 0;

function rotacionarFrase() {
  const el = document.getElementById('welcomeFrase');
  if (!el) return;
  el.style.opacity = '0';
  setTimeout(() => {
    fraseIdx = (fraseIdx + 1) % welcomeFrases.length;
    el.textContent = welcomeFrases[fraseIdx];
    el.style.opacity = '1';
  }, 400);
}
setInterval(rotacionarFrase, 4000);

// Partículas flutuantes na welcome
function criarParticulas() {
  const container = document.getElementById('welcomeParticles');
  if (!container) return;
  for (let i = 0; i < 12; i++) {
    const p = document.createElement('div');
    p.className = 'wp';
    const size = 3 + Math.random() * 6;
    p.style.cssText = `
      width:${size}px; height:${size}px;
      left:${10 + Math.random() * 80}%;
      bottom:-10px;
      --dur:${5 + Math.random() * 6}s;
      --delay:${Math.random() * -8}s;
      animation-delay: var(--delay);
    `;
    container.appendChild(p);
  }
}
criarParticulas();

// ── 7. DASHBOARD: atualizar ao receber msgs ────────────
const dashObserver = new MutationObserver(() => {
  const notifEl = document.getElementById('dashNotif');
  const badges = document.querySelectorAll('#contactsList .unread-badge');
  let total = 0;
  badges.forEach(b => total += parseInt(b.textContent) || 0);
  if (notifEl) {
    notifEl.textContent = total;
    notifEl.style.color = total > 0 ? '#e87070' : 'var(--green-online)';
  }
});
const cl = document.getElementById('contactsList');
if (cl) dashObserver.observe(cl, { subtree: true, childList: true, characterData: true });

window.toggleDash = toggleDash;
</script>


<script>
// Drag-to-scroll na faixa de stories (mouse desktop)
(function() {
  const bar = document.getElementById('storiesBar');
  if (!bar) return;
  let isDown = false, startX, scrollLeft;

  bar.addEventListener('mousedown', e => {
    // Não iniciar drag se clicar direto num thumb
    if (e.target.closest('.story-thumb') || e.target.closest('.story-add')) return;
    isDown = true;
    bar.style.cursor = 'grabbing';
    startX    = e.pageX - bar.offsetLeft;
    scrollLeft = bar.scrollLeft;
    e.preventDefault();
  });

  bar.addEventListener('mouseleave', () => { isDown = false; bar.style.cursor = 'grab'; });
  bar.addEventListener('mouseup',    () => { isDown = false; bar.style.cursor = 'grab'; });
  bar.addEventListener('mousemove',  e => {
    if (!isDown) return;
    e.preventDefault();
    const x    = e.pageX - bar.offsetLeft;
    const walk = (x - startX) * 1.5;
    bar.scrollLeft = scrollLeft - walk;
  });

  // Também permitir scroll com roda do mouse horizontal
  bar.addEventListener('wheel', e => {
    e.preventDefault();
    bar.scrollLeft += e.deltaY * 0.8;
  }, { passive: false });
})();
</script>

</body>
</html>
